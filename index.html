<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>数秘＋宿曜｜フル強化版（設計図／季節／ピナクル／名前の力／ふたり）</title>
<style>
  :root{
    --bg:#0b0f14;--ink:#eaf1ff;--muted:#9fb1cf;--line:#223049;
    --panel:#101826;--panel2:#0c1524;--accent:#22d3ee;--accent2:#34d399;
    --good:#34d399;--warn:#f59e0b;--bad:#fb7185;--mid:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#05080c;color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;line-height:1.9}
  header{padding:24px 16px;text-align:center;background:linear-gradient(180deg,#0a0f13,#0a1320)}
  header h1{margin:0 0 6px;font-size:22px;letter-spacing:.04em}
  header p{margin:0;color:var(--muted)}
  main{max-width:1120px;margin:0 auto;padding:14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 8px 24px rgba(0,0,0,.26)}
  .row{display:grid;gap:12px}
  @media(min-width:900px){.row.two{grid-template-columns:1fr 1fr}}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1422;color:var(--ink)}
  button{cursor:pointer;background:linear-gradient(45deg,var(--accent),var(--accent2));border:none;font-weight:700}
  h2{margin:0 0 10px;font-size:20px}
  h3{margin:12px 0 6px;font-size:17px}
  p{margin:.55em 0}
  .muted{color:var(--muted)} .small{font-size:12px}
  .pill{display:inline-block;border:1px solid var(--line);padding:3px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .box{background:var(--panel2);border:1px dashed #27405f;padding:12px;border-radius:10px;margin:.6em 0}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  canvas{max-width:100%;height:auto;border-radius:10px;background:#0b1422;border:1px solid var(--line)}
  .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:3px 10px;margin:2px;font-size:12px}
  .tag.good{color:var(--good)} .tag.warn{color:var(--warn)} .tag.bad{color:var(--bad)} .tag.mid{color:var(--mid)}
  .list2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:680px){.list2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>数秘＋宿曜 フル強化版</h1>
  <p class="muted">設計図・いまの季節・ピナクル・名前の力・ふたりの取り扱い｜全部クライアント計算</p>
</header>

<main>
  <!-- 入力 -->
  <div class="card">
    <div class="row two">
      <div>
        <label>あなたの生年月日</label>
        <input type="date" id="birthA"/>
        <div class="row two">
          <div>
            <label>出生時刻（任意）</label>
            <input type="time" id="timeA" step="60"/>
          </div>
          <div>
            <label>氏名（ひらがな or ローマ字）</label>
            <input type="text" id="nameA" placeholder="やまだたろう / YAMADA TARO"/>
          </div>
        </div>
      </div>
      <div>
        <label>相手の生年月日（任意｜相性）</label>
        <input type="date" id="birthB"/>
        <div class="row two">
          <div>
            <label>相手の出生時刻（任意）</label>
            <input type="time" id="timeB" step="60"/>
          </div>
          <div>
            <label>相手の氏名（任意）</label>
            <input type="text" id="nameB" placeholder="ひらがな or ROMAJI"/>
          </div>
        </div>
      </div>
    </div>
    <div class="row two" style="margin-top:8px">
      <div>
        <label>タイムゾーン</label>
        <select id="tz">
          <option value="">自動（端末TZ）</option>
          <option value="9">日本（UTC+9）</option>
          <option value="0">UTC±0</option>
          <option value="-5">NY（UTC-5）</option>
          <option value="1">CET（UTC+1）</option>
        </select>
      </div>
      <div style="align-self:end">
        <button id="run">結果を表示</button>
      </div>
    </div>
    <div class="small muted" style="margin-top:6px">
      ※宿曜は月の黄経から27宿を算出（Meeus系簡易法）。氏名はひらがな→簡易数割当／ローマ字→ピタゴラス式で数化。
    </div>
  </div>

  <!-- 1. あなたの設計図 -->
  <div class="card">
    <h2>1. あなたの設計図（5分でわかる）</h2>
    <div class="flex">
      <canvas id="chartCore" width="420" height="260"></canvas>
      <div>
        <div class="pill" id="copyTitle">—</div>
        <p id="copyLine" class="lead"></p>
        <div id="coreList" class="small muted"></div>
      </div>
    </div>
  </div>

  <!-- 2. いまの季節 -->
  <div class="card">
    <h2>2. いまの季節（個人年・月・日）</h2>
    <div class="flex">
      <canvas id="spark30" width="520" height="120"></canvas>
      <div>
        <p class="pill" id="pymd">—</p>
        <div class="box small" id="threeActions"></div>
      </div>
    </div>
  </div>

  <!-- 3. 一生のビッグウェーブ -->
  <div class="card">
    <h2>3. 一生のビッグウェーブ（ピナクル & チャレンジ）</h2>
    <canvas id="pinnacleBar" width="800" height="220"></canvas>
    <div id="pinnacleWords" class="small muted"></div>
  </div>

  <!-- 4. 名前に眠る力 -->
  <div class="card">
    <h2>4. 名前に眠る力（隠れた情熱・課題）</h2>
    <div id="namePowers" class="flex"></div>
  </div>

  <!-- 5. ふたりの取り扱い説明書 -->
  <div class="card">
    <h2>5. ふたりの取り扱い説明書（宿曜ヒートマップ＋一致項目）</h2>
    <div class="row two">
      <canvas id="heatmap" width="380" height="380"></canvas>
      <div>
        <div id="pairHead" class="pill">—</div>
        <div class="box" id="pairSummary"></div>
        <div class="list2">
          <div class="box"><strong>やること3つ</strong><ul id="do3"></ul></div>
          <div class="box"><strong>やらないこと3つ</strong><ul id="dont3"></ul></div>
        </div>
      </div>
    </div>
    <p class="small muted">※相手の情報が未入力のときは、ヒートマップは基準宿のみ表示。</p>
  </div>
</main>

<script>
/* ================= 共通ユーティリティ ================= */
const d2r=d=>d*Math.PI/180, norm360=x=>(x%360+360)%360;
const sumDigits=n=>String(n).split("").reduce((a,b)=>a+Number(b),0);
function reduceNum(n){ if([11,22,33].includes(n))return n; let r=n; while(r>9) r=sumDigits(r); return r; }
function toDateTZ(dateStr,timeStr,tzHours){
  const [y,m,d]=dateStr.split("-").map(Number);
  let H=12,MIN=0; if(timeStr){const t=timeStr.split(":");H=+t[0];MIN=+t[1];}
  const tz=(tzHours==null||tzHours==="")?-(new Date().getTimezoneOffset()/60):Number(tzHours);
  return new Date(Date.UTC(y,m-1,d,H - tz,MIN));
}
function JD(utc){
  const y=utc.getUTCFullYear(), m=utc.getUTCMonth()+1;
  const D=utc.getUTCDate()+(utc.getUTCHours()+utc.getUTCMinutes()/60)/24;
  let Y=y,M=m; if(M<=2){Y--;M+=12;}
  const A=Math.floor(Y/100), B=2-A+Math.floor(A/4);
  return Math.floor(365.25*(Y+4716))+Math.floor(30.6001*(M+1))+D+B-1524.5;
}
let variantOffset=0;
function seedFrom(...xs){ let s=1779033703; for(const x of xs){const str=String(x);for(let i=0;i<str.length;i++){s=Math.imul(s^str.charCodeAt(i),3432918353); s=(s<<13)|(s>>>19);} } return (s>>>0); }
function mulberry32(a){return function(){let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296;}}
function choice(rng, arr){ return arr[Math.floor(rng()*arr.length)] }

/* ================= 宿曜：月黄経→宿 ================= */
function moonLon(utc){
  const t=(JD(utc)-2451545)/36525;
  const L0=norm360(218.3164477+481267.88123421*t-0.0015786*t*t+t*t*t/538841-t*t*t*t/65194000);
  const D =norm360(297.8501921+445267.1114034*t-0.0018819*t*t+t*t*t/545868-t*t*t*t/113065000);
  const M =norm360(357.5291092+35999.0502909*t-0.0001536*t*t+t*t*t/24490000);
  const M1=norm360(134.9633964+477198.8675055*t+0.0087414*t*t+t*t*t/69699-t*t*t*t/14712000);
  const F =norm360(93.2720950 +483202.0175233*t-0.0036539*t*t-t*t*t/3526000+t*t*t*t/863310000);
  let lon=L0+6.289*Math.sin(d2r(M1))+1.274*Math.sin(d2r(2*D-M1))+0.658*Math.sin(d2r(2*D))+0.214*Math.sin(d2r(2*M1))+0.186*Math.sin(d2r(M))-0.114*Math.sin(d2r(2*F));
  return norm360(lon);
}
const SHUKU=["角木蛟","亢金龍","氐土貉","房日兎","心月狐","尾火虎","箕水豹","斗木獬","女土蝠","虚日鼠","危月燕","室火猪","壁水貐","奎木狼","婁金狗","胃土雉","昴日鵠","畢月烏","觜火猴","参水猿","井木犴","鬼金羊","柳土獐","星日馬","張月鹿","翼火蛇","軫水蚓"];
function shukuOf(utc){ const lon=moonLon(utc); const idx=Math.floor(lon/(360/27)); return {name:SHUKU[idx], idx}; }

/* ================= 数秘：生年月日 ================= */
const lifePath=(y,m,d)=>{const t=sumDigits(y)+sumDigits(m)+sumDigits(d); return [11,22,33].includes(t)?t:reduceNum(t);};
const birthNum=d=>reduceNum(d);
const pYear=(bY,bM,bD,year)=>reduceNum(reduceNum(bM+bD)+reduceNum(year));
const pMonth=(pyear,month)=>reduceNum(pyear+month);
const pDay=(pmonth,day)=>reduceNum(pmonth+day);

/* ================= 数秘：氏名（ひらがな or ローマ字） ================= */
// ローマ字→ピタゴラス
const P = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:4,W:5,X:6,Y:7,Z:8};
// ひらがな→簡易割当（行ごとに1〜9を循環）
const H2N = (()=>{ const m={}; const rows=[
  ["あ","か","さ","た","な","は","ま","や","ら","わ"],
  ["い","き","し","ち","に","ひ","み","","り","ゐ"],
  ["う","く","す","つ","ぬ","ふ","む","ゆ","る","ん"],
  ["え","け","せ","て","ね","へ","め","","れ","ゑ"],
  ["お","こ","そ","と","の","ほ","も","よ","ろ","を"]
]; const val=[1,2,3,4,5,6,7,8,9,1];
rows.forEach((row)=>row.forEach((k,ci)=>{ if(k){ m[k]=val[ci]; }}));
["がぎぐげご","ざじずぜぞ","だぢづでど","ばびぶべぼ","ぱぴぷぺぽ"].forEach((grp,i)=>{grp.split("").forEach(ch=>m[ch]= (m["か"]+i)%9 || 9);});
return m;})();

function onlyLetters(s){return s.toUpperCase().replace(/[^A-Z]/g,"");}
function isVowel(c){return "AEIOUY".includes(c);}
function mapCharsToNums(name){
  const hira=name.replace(/[ァ-ヶ]/g,s=>String.fromCharCode(s.charCodeAt(0)-0x60)); // カナ→ひらがな
  const hasHira=/[ぁ-ゖ]/.test(hira);
  if(hasHira){
    const nums=[...hira].map(ch=>H2N[ch]||0).filter(n=>n>0);
    return nums;
  }else{
    return onlyLetters(name).split("").map(c=>P[c]||0).filter(n=>n>0);
  }
}
function reduceFromChars(arr){return reduceNum(arr.reduce((a,b)=>a+b,0));}
function expressionNumber(name){ return reduceFromChars(mapCharsToNums(name)); }
function soulUrgeNumber(name){
  const letters=onlyLetters(name);
  const romaji = letters ? letters.split("").filter(isVowel).map(c=>P[c]||0) : [];
  const hira = name.replace(/[ァ-ヶ]/g,s=>String.fromCharCode(s.charCodeAt(0)-0x60));
  const hiraNums=[...hira].filter(ch=>/[ぁ-ゖ]/.test(ch) && "あいうえおやゆよ".includes(ch)).map(ch=>H2N[ch]||0);
  const all=[...romaji,...hiraNums];
  return all.length?reduceFromChars(all):0;
}
function personalityNumber(name){
  const letters=onlyLetters(name);
  const romaji = letters ? letters.split("").filter(c=>!isVowel(c)).map(c=>P[c]||0) : [];
  const hira = name.replace(/[ァ-ヶ]/g,s=>String.fromCharCode(s.charCodeAt(0)-0x60));
  const hiraNums=[...hira].filter(ch=>/[ぁ-ゖ]/.test(ch) && !"あいうえおやゆよ".includes(ch)).map(ch=>H2N[ch]||0);
  const all=[...romaji,...hiraNums];
  return all.length?reduceFromChars(all):0;
}
function hiddenPassion(name){
  const counts=Array(10).fill(0);
  mapCharsToNums(name).forEach(n=>counts[n]++);
  const max=Math.max(...counts.slice(1));
  return max>0?[...counts.keys()].filter(n=>n>0 && counts[n]===max):[];
}
function karmicLessons(name){
  const seen=new Set(mapCharsToNums(name));
  return [1,2,3,4,5,6,7,8,9].filter(n=>!seen.has(n));
}
// Maturity = reduce(LifePath + Expression)
function maturityNumber(lp, expr){ return reduceNum(lp + expr); }

/* ================= 宿曜：関係 ================= */
const REL_NAME=["命","危","安","—","壊","—","—","—","業","友","—","—","—","栄","衰","—","—","—","成","胎","—","—","壊","—","安","危","—"];
function relationByDistance(d){
  const base=REL_NAME[d];
  if(base && base!=="—") return base;
  if(d===0) return "命"; if(d===13) return "栄"; if(d===14) return "衰";
  if(d===4||d===23) return "壊"; if(d===8) return "業"; if(d===19) return "胎";
  if(d<=2) return "安"; if(d<=9) return "友"; if(d<=18) return "成"; return "衰";
}
const REL_BASE_SCORE={ "命":85,"栄":82,"友":80,"成":78,"安":76,"胎":74,"衰":68,"業":62,"危":60,"壊":55 };

/* ================= コピー辞書 ================= */
const LP_VERB={
  1:"切りひらく",2:"つなぐ",3:"表現する",4:"仕組む",5:"刷新する",6:"整える/守る",7:"深める",8:"実現する",9:"包む",
  11:"ひらめきを橋渡す",22:"大枠を形にする",33:"癒しで満たす"
};
const SH_KEY={
  "角木蛟":"はじめる","亢金龍":"正しさ","氐土貉":"整える","房日兎":"華やか","心月狐":"やさしさ","尾火虎":"情熱","箕水豹":"発信",
  "斗木獬":"堅実","女土蝠":"育てる","虚日鼠":"慎重","危月燕":"スピード","室火猪":"信用","壁水貐":"見抜く","奎木狼":"企画",
  "婁金狗":"きちんと","胃土雉":"実務","昴日鵠":"スター性","畢月烏":"コツコツ","觜火猴":"ことば/技術","参水猿":"改革",
  "井木犴":"学び","鬼金羊":"慎重さ","柳土獐":"しなやか","星日馬":"遠くへ","張月鹿":"見せ方","翼火蛇":"戦略","軫水蚓":"いやし"
};

/* ================= 1) 設計図：円グラフ＆コピー ================= */
function drawCoreChart(canvas, numbers){
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const keys=["Life Path","Birthday","Expression","SoulUrge","Personality"];
  const vals=[numbers.lp, numbers.bd, numbers.expr, numbers.soul, numbers.pers].map(n=> (n===11||n===22||n===33)?11: (n||0));
  const sum=vals.reduce((a,b)=>a+b,0) || 1;
  let start=-Math.PI/2;
  const cx=130, cy=130, r=90;
  keys.forEach((k,i)=>{
    const frac=vals[i]/sum, end=start+frac*2*Math.PI;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
    ctx.fillStyle=`hsl(${i*72},70%,55%)`; ctx.fill();
    // legend
    const v = numbers[keysMap(k)] || "—";
    ctx.fillStyle="#eaf1ff"; ctx.font="12px system-ui"; ctx.textAlign="left";
    ctx.fillText(`${k}: ${v}`, 250, 30+18*i);
    start=end;
  });
  ctx.beginPath(); ctx.arc(cx,cy,50,0,2*Math.PI); ctx.fillStyle="#0b1422"; ctx.fill();
  ctx.fillStyle="#eaf1ff"; ctx.font="bold 16px system-ui"; ctx.textAlign="center";
  ctx.fillText(numbers.lp, cx, cy+6);
  function keysMap(k){return { "Life Path":"lp","Birthday":"bd","Expression":"expr","SoulUrge":"soul","Personality":"pers"}[k];}
}
function buildCopy(lp, shuku){
  const lpv=LP_VERB[lp]||"進める";
  const shk=SH_KEY[shuku]||"整える";
  return `${lp}×${shuku}：静かに${lpv.replace("/","・")}、必要な場面で「${shk}」を効かせると評価が跳ねる`;
}

/* ================= 2) 30日スパークライン＋三行 ================= */
// 30日スパークライン（数値1-9を高さに）
function drawSpark(canvas, startDate, pmonth){
  const ctx=canvas.getContext("2d"); ctx.clearRect(0,0,canvas.width,canvas.height);
  const W=canvas.width, H=canvas.height; const N=30;
  const xs=[], ys=[];
  for(let i=0;i<N;i++){
    const d=new Date(startDate.getTime()); d.setDate(d.getDate()+i);
    const pd=pDay(pmonth, d.getDate());
    const x=i*(W-30)/(N-1)+15, y=H-20 - (pd-1)*(H-40)/8;
    xs.push(x); ys.push(y);
  }
  // baseline
  ctx.strokeStyle="#223049"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(10,H-20); ctx.lineTo(W-10,H-20); ctx.stroke();
  // line
  ctx.strokeStyle="#34d399"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(xs[0],ys[0]); for(let i=1;i<N;i++) ctx.lineTo(xs[i],ys[i]); ctx.stroke();
  // dots
  ctx.fillStyle="#22d3ee"; for(let i=0;i<N;i++){ ctx.beginPath(); ctx.arc(xs[i],ys[i],2.5,0,2*Math.PI); ctx.fill(); }
}

/* 三行アクション（個人月×個人日で簡易生成） */
function threeLines(pmonth,todayPD){
  const p= (pmonth>9)?reduceNum(pmonth):pmonth;
  const job={
    1:"15分の“始める時間”を先取り",
    2:"共同作業を1つ。役割をメモ化",
    3:"発信を1件。量より“率直さ”",
    4:"チェックリスト更新→繰り返しに",
    5:"新しいやり方を小さく試す",
    6:"整える作業を前倒し",
    7:"90分の学び/深掘り",
    8:"交渉/条件見直しを実行",
    9:"手放しと完了を1件"
  }[p];
  const relation = (todayPD>=7)?"返信ペースを合意":"短くテンポよく連絡を1通";
  const self = (todayPD>=8)?"就寝前スクロール禁止":"深い呼吸×3セット";
  return {job,relation:self===relation? "会話は“2行で”" : relation, self};
}

/* ================= 3) ピナクル＆チャレンジ ================= */
function pinnaclesAndChallenges(y,m,d, lp){
  const p1=reduceNum(m+d), p2=reduceNum(d+sumDigits(y)), p3=reduceNum(p1+p2), p4=reduceNum(m+sumDigits(y));
  const c1=Math.abs(m-d)%9, c2=Math.abs(d-sumDigits(y))%9, c3=Math.abs(c1-c2)%9, c4=Math.abs(m-sumDigits(y))%9;
  const end1=36-lp, end2=end1+9, end3=end2+9; // 以後は第4
  return {p:[p1,p2,p3,p4], c:[c1||0,c2||0,c3||0,c4||0], ends:[end1,end2,end3]};
}
function drawPinnacleBar(canvas, data){
  const ctx=canvas.getContext("2d"); ctx.clearRect(0,0,canvas.width,canvas.height);
  const W=canvas.width, H=canvas.height; const ages=[0,data.ends[0],data.ends[1],data.ends[2],80];
  const labels=["第1","第2","第3","第4"], colors=["#60a5fa","#34d399","#22d3ee","#a78bfa"];
  for(let i=0;i<4;i++){
    const x=W*(ages[i]/80), w=W*((ages[i+1]-ages[i])/80);
    ctx.fillStyle=colors[i]; ctx.fillRect(x+2,40,w-4,36);
    ctx.fillStyle="#0b1422"; ctx.font="bold 13px system-ui"; ctx.textAlign="center";
    ctx.fillText(`${labels[i]} P${data.p[i]} / C${data.c[i]}`, x+w/2, 64);
  }
  // axis
  ctx.fillStyle="#9fb1cf"; ctx.textAlign="center"; ctx.font="12px system-ui";
  for(let a=0;a<=80;a+=10){ const x=W*(a/80); ctx.fillText(a, x, 20); ctx.fillRect(x,26,1,6); }
}

/* ================= 4) 名前の力 ================= */
function renderNamePowers(root, name, lp, expr, soul, pers){
  root.innerHTML="";
  const hp=hiddenPassion(name), kl=karmicLessons(name);
  const frag=document.createDocumentFragment();
  const box1=document.createElement("div");
  box1.innerHTML=`<div class="box"><strong>Hidden Passion：</strong>${hp.map(n=>`<span class="tag mid">#${n}</span>`).join("")||'<span class="muted">—</span>'}<br>
  <span class="small muted">最頻出の数字＝得意な資質</span></div>`;
  frag.appendChild(box1);
  const box2=document.createElement("div");
  box2.innerHTML=`<div class="box"><strong>Karmic Lessons：</strong>${kl.map(n=>`<span class="tag warn">欠け #${n}</span>`).join("")||'<span class="muted">なし</span>'}<br>
  <span class="small muted">氏名に出てこない数字＝学びのテーマ</span></div>`;
  frag.appendChild(box2);
  const box3=document.createElement("div");
  box3.innerHTML=`<div class="box"><strong>成熟数（Maturity）：</strong><span class="tag good">#${maturityNumber(lp, expr)}</span>
  <br><span class="small muted">Life PathとExpressionの合算</span></div>`;
  frag.appendChild(box3);
  root.appendChild(frag);
}

/* ================= 5) ヒートマップ＋取り扱い ================= */
function drawHeatmap(canvas, baseIdx, pairIdx=-1){
  const ctx=canvas.getContext("2d"); ctx.clearRect(0,0,canvas.width,canvas.height);
  const N=27, cell=canvas.width/N;
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      const d=Math.min((c-r+N)%N,(r-c+N)%N);
      const rel=relationByDistance(d);
      let col="#223049";
      if(["命","栄","友","成","安","胎"].includes(rel)) col="#184d3d";
      if(["危","壊"].includes(rel)) col="#4b1e2a";
      if(["業","衰"].includes(rel)) col="#3a2f4f";
      ctx.fillStyle=col; ctx.fillRect(c*cell, r*cell, cell-0.5, cell-0.5);
    }
  }
  // 基準宿の行列を目立たせる
  ctx.fillStyle="rgba(255,255,255,.12)";
  ctx.fillRect(0, baseIdx*cell, canvas.width, cell);
  ctx.fillRect(baseIdx*cell, 0, cell, canvas.height);
  if(pairIdx>=0){
    ctx.fillStyle="rgba(255,255,255,.25)";
    ctx.fillRect(0, pairIdx*cell, canvas.width, cell);
    ctx.fillRect(pairIdx*cell, 0, cell, canvas.height);
    ctx.strokeStyle="#fff"; ctx.lineWidth=2;
    ctx.strokeRect(pairIdx*cell, baseIdx*cell, cell-1, cell-1);
  }
}

/* 相性まとめ＋Do/Dont */
function compatScore(rel,lpA,lpB,exprA,exprB,soulA,soulB,persA,persB){
  const base=REL_BASE_SCORE[rel]??70;
  const diff=Math.abs(lpA-lpB);
  const lpDelta= diff<=1?8: diff<=3?4: diff<=5?0:-4;
  const add=(a,b)=> a&&b && a===b?1:0;
  const bonus= add(exprA,exprB)*6 + add(soulA,soulB)*6 + add(persA,persB)*4;
  return Math.max(40, Math.min(99, base+lpDelta+bonus));
}
function buildDoDont(rel){
  const map={
    "命":{do:["役割分担をメモ化","週1の共同作業","褒め合う日を作る"], dont:["張り合いで競わない","全部同時に決めない","疲れた時に深追いしない"]},
    "友":{do:["生活デートを増やす","小さなねぎらい","写真で記録"], dont:["サプライズ過多","返信催促","遠回しすぎる指摘"]},
    "成":{do:["次の予定を先に決める","家事や支払いを見える化","月1棚卸し"], dont:["感情論で決める","役割あいまい","長時間だらだら会議"]},
    "栄":{do:["見せ場を作る","言葉で称賛","休む日の明確化"], dont:["人前での批判","詰問調の会話","予定を詰め込みすぎ"]},
    "安":{do:["体が安心する時間","家事を一緒に","スキンシップ"], dont:["依存しすぎ","相手の予定に干渉","夜更かし連絡の強要"]},
    "胎":{do:["共通の学び","進捗は3ヶ月ごと","“できたこと”共有"], dont:["結果を急ぐ","背負い込み","比較癖"]},
    "衰":{do:["静かな時間","小さな積み重ね","感謝の記録"], dont:["白黒つける議論","即答の強要","評価を急ぐ"]},
    "業":{do:["小出しで支え合う","役割交代デー","自立の確保"], dont:["背負いすぎ","過去の蒸し返し","借り/貸しの計算"]},
    "危":{do:["短時間の非日常","早めに解散","境界線の合意"], dont:["長時間の刺激","即レス強要","金銭の曖昧さ"]},
    "壊":{do:["Yes/No/保留テンプレ","短時間×高頻度","要点で伝える"], dont:["感情のぶつけ合い","長時間の議論","共同財布の曖昧化"]}
  };
  return map[rel] || map["成"];
}

/* ================= 実行 ================= */
function runAll(){
  document.activeElement && document.activeElement.blur();
  const dA=document.getElementById("birthA").value; if(!dA){alert("あなたの生年月日を入れてね");return;}
  const tz=document.getElementById("tz").value||"";
  const utcA=toDateTZ(dA, document.getElementById("timeA").value||"", tz);
  const y=utcA.getUTCFullYear(), m=utcA.getUTCMonth()+1, d=utcA.getUTCDate();
  const nameA=document.getElementById("nameA").value||"";
  const lp=lifePath(y,m,d), bd=birthNum(d);
  const expr=nameA?expressionNumber(nameA):0, soul=nameA?soulUrgeNumber(nameA):0, pers=nameA?personalityNumber(nameA):0;
  const shA=shukuOf(utcA);

  // 1) 設計図
  drawCoreChart(document.getElementById("chartCore"), {lp,bd,expr,soul,pers});
  document.getElementById("copyTitle").textContent=`LP ${lp} ／ 本命宿 ${shA.name}`;
  document.getElementById("copyLine").textContent=buildCopy(lp, shA.name);
  document.getElementById("coreList").innerHTML=`Life Path:${lp} ／ 誕生数:${bd} ／ Expression:${expr||"—"} ／ SoulUrge:${soul||"—"} ／ Personality:${pers||"—"}`;

  // 2) いまの季節
  const now=new Date();
  const py=pYear(y,m,d, now.getFullYear());
  const pm=pMonth(py, now.getMonth()+1);
  const pd=pDay(pm, now.getDate());
  drawSpark(document.getElementById("spark30"), new Date(), pm);
  const act=threeLines(pm,pd);
  document.getElementById("pymd").textContent=`個人年 ${py} ／ 個人月 ${pm} ／ 個人日 ${pd}`;
  document.getElementById("threeActions").innerHTML=
    `<div>仕事：${act.job}</div><div>対人：${act.relation}</div><div>自己ケア：${act.self}</div>`;

  // 3) ピナクル＆チャレンジ
  const lpForAge = (lp>9&&lp<100)?reduceNum(lp):lp; // 11/22/33保持
  const pc=pinnaclesAndChallenges(y,m,d, lpForAge); // ← yをそのまま渡す
  drawPinnacleBar(document.getElementById("pinnacleBar"), pc);
  document.getElementById("pinnacleWords").innerHTML=
    `第1:${pc.p[0]}／第2:${pc.p[1]}／第3:${pc.p[2]}／第4:${pc.p[3]}　
     チャレンジ→ 1:${pc.c[0]} 2:${pc.c[1]} 3:${pc.c[2]} 4:${pc.c[3]}（P=ピナクル, C=チャレンジ）`;

  // 4) 名前の力
  renderNamePowers(document.getElementById("namePowers"), nameA, lp, expr, soul, pers);

  // 5) ふたり（相手がいれば詳細）
  const dB=document.getElementById("birthB").value;
  const nameB=document.getElementById("nameB").value||"";
  const heat=document.getElementById("heatmap");
  let pairText="相手未入力。あなたの基準宿を表示中。";
  let do3=[], dont3=[];
  if(dB){
    const utcB=toDateTZ(dB, document.getElementById("timeB").value||"", tz);
    const shB=shukuOf(utcB);
    const N=27, cw=(shB.idx-shA.idx+N)%N, ccw=(shA.idx-shB.idx+N)%N, dist=Math.min(cw,ccw), rel=relationByDistance(dist);
    const lpB=lifePath(utcB.getUTCFullYear(),utcB.getUTCMonth()+1,utcB.getUTCDate());
    const exprB=nameB?expressionNumber(nameB):0, soulB=nameB?soulUrgeNumber(nameB):0, persB=nameB?personalityNumber(nameB):0;
    const score=compatScore(rel,lp,lpB,expr,exprB,soul,soulB,pers,persB);
    pairText=`あなた：${shA.name}（LP${lp}）／相手：${shB.name}（LP${lpB}）<br>
              関係名：<strong>${rel}</strong>　相性スコア：<strong>${score}/100</strong><br>
              一致：Expr ${expr&&exprB&&expr===exprB?"◎":"—"} ／ Soul ${soul&&soulB&&soul===soulB?"◎":"—"} ／ Pers ${pers&&persB&&pers===persB?"◎":"—"}`;
    const sets=buildDoDont(rel); do3=sets.do; dont3=sets.dont;
    drawHeatmap(heat, shA.idx, shB.idx);
  }else{
    drawHeatmap(heat, shA.idx, -1);
  }
  document.getElementById("pairHead").textContent=`基準宿：${shA.name}`;
  document.getElementById("pairSummary").innerHTML=pairText;
  const ulDo=document.getElementById("do3"), ulDont=document.getElementById("dont3");
  ulDo.innerHTML=do3.map(s=>`<li>${s}</li>`).join("")||"<li class='muted'>—</li>";
  ulDont.innerHTML=dont3.map(s=>`<li>${s}</li>`).join("")||"<li class='muted'>—</li>";
}

// ボタン
document.getElementById("run").addEventListener("click", ()=>{ variantOffset++; runAll(); });
</script>
</body>
</html>
