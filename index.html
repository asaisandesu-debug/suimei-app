<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>あなたの鑑定｜数秘＋宿曜（やさしい説明＋3年カレンダー）</title>
<style>
  :root{
    --bg:#0b0f14;--ink:#eaf1ff;--muted:#9fb1cf;--line:#223049;
    --panel:#111826;--panel2:#0c1728;--accent:#22d3ee;--accent2:#34d399;
    --love:#f472b6;--meet:#34d399;--marry:#fbbf24;--move:#60a5fa;--job:#c084fc;--work:#ffd580;--promo:#a5b4fc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#05080c;color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;line-height:1.9}
  header{padding:26px 16px;text-align:center;background:linear-gradient(180deg,#0a0f13,#0a1320)}
  header h1{margin:0 0 6px;font-size:24px}
  header p{margin:0;color:var(--muted)}
  main{max-width:1120px;margin:0 auto;padding:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1422;color:var(--ink)}
  button{cursor:pointer;background:linear-gradient(45deg,var(--accent),var(--accent2));border:none;font-weight:700}
  h2{font-size:20px;margin-bottom:10px}
  h3{font-size:17px;margin:10px 0 6px}
  p{margin:.55em 0}
  .small{font-size:12px;color:var(--muted)}
  .box{background:var(--panel2);border:1px dashed #264064;padding:12px;border-radius:10px;margin-top:10px}
  ul.clean{padding-left:1.2em;margin:0} ul.clean li{margin:4px 0}
  .row{display:grid;gap:12px}
  @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .kpi{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .kpi span{background:#0b1422;border:1px solid var(--line);border-radius:8px;padding:6px 10px}
  .calendar{display:grid;gap:12px}
  .calendar{grid-template-columns:1fr}
  @media(min-width:680px){.calendar{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:960px){.calendar{grid-template-columns:repeat(3,1fr)}}
  .mon{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0b1422}
  .mon.now{outline:2px solid var(--accent);box-shadow:0 0 0 4px rgba(34,211,238,.2)}
  .head{display:flex;justify-content:space-between;align-items:center}
  .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .tag{display:inline-flex;align-items:center;gap:4px;font-size:11px;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
  .t-love{color:var(--love)} .t-meet{color:var(--meet)} .t-marry{color:var(--marry)} .t-move{color:var(--move)}
  .t-job{color:var(--job)} .t-work{color:var(--work)} .t-promo{color:var(--promo)}
  .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<header>
  <h1>あなたの鑑定｜数秘＋宿曜（統合版）</h1>
  <p>専門用語ゼロ。読みやすく、そのまま実行できるアドバイス。</p>
</header>

<main>
  <!-- 入力 -->
  <div class="card">
    <div class="row">
      <div>
        <label>あなたの生年月日</label>
        <input type="date" id="birthA"/>
        <div class="row">
          <div>
            <label>出生時刻（任意）</label>
            <input type="time" id="timeA" step="60"/>
          </div>
          <div>
            <label>性別（任意｜文体に反映）</label>
            <select id="genderA">
              <option value="">指定なし</option>
              <option value="female">女性</option>
              <option value="male">男性</option>
            </select>
          </div>
        </div>
        <p class="small">※宿曜は月の位置から27宿を計算（簡易法）。時刻不明は正午で推定します。</p>
      </div>
      <div>
        <label>相性（任意）：相手の生年月日</label>
        <input type="date" id="birthB"/>
        <div class="row">
          <div>
            <label>相手の出生時刻（任意）</label>
            <input type="time" id="timeB" step="60"/>
          </div>
          <div>
            <label>タイムゾーン</label>
            <select id="tz">
              <option value="">自動（端末TZ）</option>
              <option value="9">日本（UTC+9）</option>
              <option value="0">UTC±0</option>
              <option value="-5">NY（UTC-5）</option>
              <option value="1">CET（UTC+1）</option>
            </select>
          </div>
        </div>
        <div class="flex" style="margin-top:10px">
          <button id="run">鑑定する</button>
          <button id="shuffle" title="表現だけランダム更新（数値は固定）">表現を変える</button>
        </div>
      </div>
    </div>
    <div class="kpi small">
      <span>数字タイプ：<strong id="lifePath">—</strong></span>
      <span>日常のクセ：<strong id="birthNum">—</strong></span>
      <span>生まれもった雰囲気：<strong id="shukuA">—</strong></span>
      <span>今年の流れ：<strong id="pyear">—</strong></span>
    </div>
  </div>

  <!-- 1. あなたの設計図 -->
  <div class="card">
    <h2>1. あなたの設計図（やさしい説明）</h2>
    <div id="designText" class="box"></div>

    <div class="row">
      <div class="box">
        <h3>どんな人に惹かれる？（10行）</h3>
        <ul id="attractList" class="clean"></ul>
      </div>
      <div class="box">
        <h3>向いている職業（具体 8選｜数字タイプ×雰囲気）</h3>
        <ul id="jobsList" class="clean"></ul>
        <p class="small">※100+職種データから自動選抜。似た系統に偏らないよう調整しています。</p>
      </div>
    </div>
  </div>

  <!-- 2. ふたりの取り扱い説明書 -->
  <div class="card">
    <h2>2. ふたりの取り扱い説明書（雰囲気＋数字タイプの一致点）</h2>
    <div id="compat" class="box"></div>
  </div>

  <!-- 3年カレンダー（36ヶ月固定表示） -->
  <div class="card">
    <h2>3. 予定を組みやすいカレンダー（3年間）</h2>
    <div class="small">毎月の空気感を「わかりやすいタグ」で表示。チェックを外すと非表示にできます。</div>
    <div class="flex small" style="margin-top:8px">
      <label><input type="checkbox" class="ft" value="love" checked> 恋愛</label>
      <label><input type="checkbox" class="ft" value="meet" checked> 出会い</label>
      <label><input type="checkbox" class="ft" value="marry" checked> 結婚</label>
      <label><input type="checkbox" class="ft" value="move" checked> 引越し</label>
      <label><input type="checkbox" class="ft" value="job" checked> 転職</label>
      <label><input type="checkbox" class="ft" value="work" checked> 仕事運</label>
      <label><input type="checkbox" class="ft" value="promo" checked> 昇格</label>
      <button id="applyFilter" style="max-width:140px;margin-left:auto">反映</button>
    </div>
    <div id="calendar" class="calendar" style="margin-top:10px"></div>
  </div>

  <div class="card small">
    <strong>免責：</strong>本ツールは自己理解と行動のヒントを提供します。医療・法務・投資判断の代替ではありません。暦や流派により差異が出る場合があります。
  </div>
</main>

<script>
/* ========= 基本ユーティリティ ========= */
const d2r=d=>d*Math.PI/180, norm360=x=>(x%360+360)%360;
function toDateTZ(dateStr,timeStr,tzHours){
  const [y,m,d]=dateStr.split("-").map(Number);
  let H=12,MIN=0; if(timeStr){const t=timeStr.split(":");H=+t[0];MIN=+t[1];}
  const tz=(tzHours==null||tzHours==="")?-(new Date().getTimezoneOffset()/60):Number(tzHours);
  return new Date(Date.UTC(y,m-1,d,H - tz,MIN));
}
function JD(utc){
  const y=utc.getUTCFullYear(), m=utc.getUTCMonth()+1;
  const D=utc.getUTCDate()+(utc.getUTCHours()+utc.getUTCMinutes()/60)/24;
  let Y=y,M=m; if(M<=2){Y--;M+=12;}
  const A=Math.floor(Y/100), B=2-A+Math.floor(A/4);
  return Math.floor(365.25*(Y+4716))+Math.floor(30.6001*(M+1))+D+B-1524.5;
}
function seedFrom(...xs){
  let s = 1779033703;
  for(const x of xs){
    const str = String(x);
    for(let i=0;i<str.length;i++){
      s = Math.imul(s ^ str.charCodeAt(i), 3432918353);
      s = (s << 13) | (s >>> 19);
    }
  }
  return (s >>> 0);
}
function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function choice(rng, arr){ return arr[Math.floor(rng()*arr.length)] }
function pickN(rng, arr, n){
  const a=[...arr]; const out=[];
  while(out.length < Math.min(n,a.length)){ out.push(a.splice(Math.floor(rng()*a.length),1)[0]); }
  return out;
}
function uniq(arr){ return [...new Set(arr)]; }
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));

/* ========= 宿曜（Meeus系簡易） ========= */
function moonLon(utc){
  const t=(JD(utc)-2451545)/36525;
  const L0=norm360(218.3164477+481267.88123421*t-0.0015786*t*t+t*t*t/538841-t*t*t*t/65194000);
  const D =norm360(297.8501921+445267.1114034*t-0.0018819*t*t+t*t*t/545868-t*t*t*t/113065000);
  const M =norm360(357.5291092+35999.0502909*t-0.0001536*t*t+t*t*t/24490000);
  const M1=norm360(134.9633964+477198.8675055*t+0.0087414*t*t+t*t*t/69699-t*t*t*t/14712000);
  const F =norm360(93.2720950 +483202.0175233*t-0.0036539*t*t-t*t*t/3526000+t*t*t*t/863310000);
  let lon=L0
    +6.289*Math.sin(d2r(M1))
    +1.274*Math.sin(d2r(2*D-M1))
    +0.658*Math.sin(d2r(2*D))
    +0.214*Math.sin(d2r(2*M1))
    +0.186*Math.sin(d2r(M))
    -0.114*Math.sin(d2r(2*F));
  return norm360(lon);
}
const SHUKU=["角木蛟","亢金龍","氐土貉","房日兎","心月狐","尾火虎","箕水豹","斗木獬","女土蝠","虚日鼠","危月燕","室火猪","壁水貐","奎木狼","婁金狗","胃土雉","昴日鵠","畢月烏","觜火猴","参水猿","井木犴","鬼金羊","柳土獐","星日馬","張月鹿","翼火蛇","軫水蚓"];
function shukuOf(utc){ const lon=moonLon(utc); const idx=Math.floor(lon/(360/27)); return {name:SHUKU[idx], idx}; }

/* ========= 数字タイプ（数秘） ========= */
const sumDigits=n=>String(n).split("").reduce((a,b)=>a+Number(b),0);
function reduceNum(n){ if([11,22,33].includes(n))return n; let r=n; while(r>9) r=sumDigits(r); return r; }
const lifePath=(y,m,d)=>{const t=sumDigits(y)+sumDigits(m)+sumDigits(d); return [11,22,33].includes(t)?t:reduceNum(t);};
const birthNumber=d=>([11,22].includes(d)?d:reduceNum(d));
const pYear=(bY,bM,bD,year)=>reduceNum(reduceNum(bM+bD)+reduceNum(year));
const pMonth=(pyear,month)=>reduceNum(pyear+month);

/* ========= 惹かれる人（20→10行） ========= */
const ATTRACTION_PATTERNS=[
  "自然体で笑える人","感情を共有してくれる人","静かな優しさのある人","芯がありながら穏やかな人",
  "無理に盛り上げなくても居心地がいい人","直感で通じる人","小さな気配りを見逃さない人",
  "一緒に沈黙を楽しめる人","感情を言葉で説明してくれる人","自分を否定しない人",
  "連絡がマメで安心感をくれる人","生活リズムが似ている人","お金や将来の価値観が近い人",
  "距離を尊重してくれる人","一緒に成長できる人","感性が似ている人","家族を大切にする人",
  "ありがとうを言える人","責任感がある人","感情の波が穏やかな人"
];

/* ========= 100+職種（具体） ========= */
const JOBS_MASTER=[
  "教師","保育士","スクールカウンセラー","公務員","市役所職員","図書館司書",
  "警察官","消防士","救急救命士","自衛官",
  "看護師","准看護師","理学療法士","作業療法士","言語聴覚士","薬剤師","臨床検査技師","放射線技師",
  "臨床心理士アシスタント","医療事務","医療ソーシャルワーカー","介護福祉士","訪問介護","児童指導員",
  "ブライダルプランナー","司会/MC","ホテルフロント","コンシェルジュ","ツアーガイド","CA",
  "美容部員","理容師","美容師","ネイリスト","エステティシャン",
  "飲食店店長","バリスタ","パティシエ","シェフ","ソムリエ","フードコート運営","キッチンカー運営",
  "製造業","製造業ライン管理","品質管理(QA)","生産管理","倉庫管理","物流コーディネーター","在庫管理",
  "不動産仲介","不動産管理","リロケーション支援","建築施工管理","内装デザイン",
  "販売職(家電)","販売職(アパレル)","百貨店外商","バイヤー","店舗SV",
  "営業(法人)","インサイドセールス","フィールドセールス","ルート営業",
  "接客(家電量販)","カスタマーサポート","コールセンターSV","カスタマーサクセス",
  "経理","財務","総務","法務アシスタント","人事","採用担当","労務",
  "広報","PRプランナー","コピーライター","編集者","校正","動画編集","フォトグラファー",
  "デザイナー(Web)","デザイナー(UI/UX)","フロントエンド","バックエンド","データアナリスト","データサイエンティスト","PM/プロジェクトマネージャー","プロダクトマネージャー","SRE/運用",
  "セキュリティエンジニア","SOCアナリスト","脆弱性診断",
  "法律事務所スタッフ","特許事務","パラリーガル",
  "翻訳/通訳","ローカライズ","テクニカルライター",
  "イベントプランナー","展示会運営","コミュニティマネージャー",
  "NPO/NGO職員","国際協力(事務)","被災地支援コーディネーター",
  "金融リレーション","証券リテール","保険プランナー","不動産ファイナンス",
  "物流企画","貿易実務","海運手配","航空地上職",
  "農業プロデュース","道の駅運営","地域おこし協力隊",
  "ゲームプランナー","シナリオライター","QAテスター(ゲーム)",
  "スポーツトレーナー","ジムインストラクター","ヨガインストラクター",
  "芸能マネージャー","舞台監督","音響/照明",
  "アートディレクター","ブランドデザイナー","DTPオペレーター",
  "IR/投資家対応","事業企画","経営企画","新規事業開発","DXコンサル",
  "通販運営","SNS運用","広告運用","CRM運用","マーケリサーチ",
  "コンサルタント(戦略)","コンサルタント(業務改善)","研修講師",
  "学校事務","塾講師","通信教育運営"
];

/* ========= 仕事タグ化＋重み（数字タイプ×宿曜） ========= */
const JOB_TAG_RULES = [
  {re:/(教師|塾|学校|講師|スクール|学校事務)/, tag:"education"},
  {re:/(公務員|市役所|図書館|警察|消防|救急|自衛)/, tag:"public"},
  {re:/(看護|医療|薬剤|臨床|放射線|検査技師|ソーシャルワーカー|介護|訪問介護|児童)/, tag:"care"},
  {re:/(営業|セールス|外商|IR|リレーション|保険)/, tag:"sales"},
  {re:/(デザイン|デザイナー|UI|UX|編集|コピー|広報|PR|動画|フォト|シナリオ|アート|ブランド|DTP)/, tag:"creative"},
  {re:/(データ|アナリスト|SRE|セキュリ|SOC|脆弱性|バックエンド|フロントエンド|エンジニア|PM|プロダクト|QAテスター|ゲーム)/, tag:"tech"},
  {re:/(経理|財務|法務|総務|人事|労務|事務|校正|在庫|生産|品質|物流|倉庫|貿易|海運|航空地上|不動産|建築|施工|管理)/, tag:"ops"},
  {re:/(飲食|バリスタ|パティシエ|シェフ|ソムリエ|キッチンカー|ホテル|コンシェルジュ|ツアー|CA|観光|地域)/, tag:"service"},
  {re:/(マーケ|SNS|広告|CRM|リサーチ|コミュニティ|イベント|展示|通販)/, tag:"growth"},
  {re:/(スポーツ|ヨガ|トレーナー|ジム)/, tag:"wellness"}
];
function jobTags(name){
  const tags=new Set();
  for(const r of JOB_TAG_RULES){ if(r.re.test(name)) tags.add(r.tag); }
  if(!tags.size) tags.add("ops");
  return [...tags];
}
const LP_WEIGHTS = {
  1:{sales:3,growth:3,tech:2,ops:1,public:1},
  2:{care:3,education:2,service:2,public:1},
  3:{creative:3,growth:2,education:1,service:1},
  4:{ops:3,public:2,tech:2,care:1},
  5:{growth:3,service:2,sales:2,tech:1},
  6:{care:3,education:2,service:2,ops:1},
  7:{tech:3,education:2,ops:2,creative:1},
  8:{sales:3,ops:2,public:2,growth:1},
  9:{care:2,creative:2,education:2,public:1,service:1},
  11:{creative:3,education:2,care:1,growth:1},
  22:{ops:3,tech:2,public:2,sales:1},
  33:{care:3,education:2,creative:1,service:1}
};
const SH_WEIGHTS = {
  "参水猿":{growth:3,sales:2,tech:2,creative:1},
  "觜火猴":{tech:3,creative:2,education:1},
  "奎木狼":{creative:3,tech:2,ops:1},
  "房日兎":{creative:3,service:2,growth:1},
  "昴日鵠":{creative:3,sales:2,service:1},
  "翼火蛇":{growth:3,tech:2,sales:2},
  "星日馬":{growth:3,service:2,public:1},
  "女土蝠":{care:3,education:2,service:1},
  "井木犴":{education:3,care:2,public:1},
  "軫水蚓":{care:3,service:2,education:1},
  "氐土貉":{ops:3,public:2,tech:1},
  "室火猪":{ops:3,public:2,care:1},
  "壁水貐":{ops:3,tech:2,public:1},
  "婁金狗":{ops:3,care:2,public:1},
  "斗木獬":{public:2,ops:2,service:1},
  "胃土雉":{service:3,ops:2,public:1},
  "角木蛟":{growth:2,sales:2,creative:1},
  "亢金龍":{public:2,ops:2,education:1},
  "心月狐":{care:2,creative:2,service:1},
  "尾火虎":{sales:2,growth:2,public:1},
  "虚日鼠":{ops:2,public:1},
  "危月燕":{growth:2,service:2},
  "畢月烏":{ops:3,public:1},
  "張月鹿":{creative:3,service:1,sales:1}
};
function scoreJobByLPShuku(jobName, lp, shName){
  const tags = jobTags(jobName);
  const lpw = LP_WEIGHTS[lp] || {};
  const shw = SH_WEIGHTS[shName] || {};
  let score = 0;
  for(const t of tags){ score += (lpw[t]||0) + (shw[t]||0); }
  if(/(教師|公務員|製造|飲食|看護|営業|経理|デザ)/.test(jobName)) score += 0.5;
  return score;
}

/* ========= 相性（関係名・スコア） ========= */
const REL_TONE={
  "命":"似た者同士で深く分かり合える相性。似すぎるゆえの張り合いは、役割分担で回避。",
  "友":"自然体で支え合える相性。日常がそのまま愛になる。",
  "成":"段取りがハマり現実が進む相性。共同作業で深まる。",
  "栄":"お互いを引き上げ合う華の縁。見せ場があるほど加速。",
  "安":"安心と癒やしの相性。ぬくもりと生活感が鍵。",
  "胎":"育ち合う縁。ゆっくりの歩みが大きな実りに。",
  "衰":"力を抜く学びの縁。等身大で向き合うと味わい深い。",
  "業":"課題の縁。小出しの支え合いが成長に変わる。",
  "危":"刺激が強い。境界線とクールダウンが長続きの鍵。",
  "壊":"価値観のズレが出やすい。ルール設計で守りながら進む。"
};
const REL_NAME=["命","危","安","—","壊","—","—","—","業","友","—","—","—","栄","衰","—","—","—","成","胎","—","—","壊","—","安","危","—"];
function relationByDistance(d){
  const base=REL_NAME[d];
  if(base && base!=="—") return base;
  if(d===0) return "命";
  if(d===13) return "栄";
  if(d===14) return "衰";
  if(d===4||d===23) return "壊";
  if(d===8) return "業";
  if(d===19) return "胎";
  if(d<=2) return "安";
  if(d<=9) return "友";
  if(d<=18) return "成";
  return "衰";
}
const REL_BASE_SCORE={ "命":85,"栄":82,"友":80,"成":78,"安":76,"胎":74,"衰":68,"業":62,"危":60,"壊":55 };
function lpCompatDelta(a,b){ const diff=Math.abs(a-b); if(diff<=1) return +8; if(diff<=3) return +4; if(diff<=5) return 0; return -4; }
function compatScore(rel,lpA,lpB){ const base=REL_BASE_SCORE[rel]??70; const delta=lpCompatDelta(lpA,lpB); return clamp(base+delta,40,99); }

/* ========= 文章生成（やさしい言葉） ========= */
let variantOffset=0;

// LPごとの自然文（専門用語なし）
const LP_NATURAL = {
  1:["自分で道を切りひらく力があります。","はっきり決めると周りがついてきます。","迷ったら小さく一歩でOK。","短い言葉で伝えると進みが早いです。","競うより『始める人』になると輝きます。"],
  2:["人の気持ちに気づけるやさしさがあります。","橋渡し役になると場が落ち着きます。","安心できる雰囲気を作るのが得意です。","静かな配慮が大きな力になります。","急がず丁寧にが成功の近道。"],
  3:["発想と表現が豊かです。","言葉・写真・映像で心を動かせます。","まず出して、あとで整えると伸びます。","遊び心が解決策を連れてきます。","褒めると周りが動きます。"],
  4:["コツコツ積み上げる力があります。","仕組みを作ると成果が安定します。","約束を守る姿勢が信頼になります。","丁寧さが最大の武器です。","予定は余裕を持つと続きます。"],
  5:["変化を味方にできます。","新しい場所や挑戦で元気が出ます。","自由度があるほど力を発揮します。","型にハマらない提案が得意です。","環境を変えると一気に進みます。"],
  6:["面倒見がよく、周りを安心させます。","小さな美しさや整えが得意です。","人の役に立つとやる気が湧きます。","家庭やチームで光ります。","やさしさを言葉にすると伝わります。"],
  7:["静かに深める時間が力になります。","本質を見抜く目があります。","必要な言葉だけで十分に伝わります。","結論を急がないと良さが出ます。","一人時間が燃料です。"],
  8:["結果を出す実行力があります。","数字で見せると信頼が一気に高まります。","交渉やまとめ役が向いています。","大きな目標ほど燃えます。","責任感が魅力です。"],
  9:["思いやりが強く、人の気持ちを受け止められます。","広い視点で物事を見られます。","表現や支え合いで輝きます。","誰かのためが力になります。","感謝を言葉にすると道が開きます。"],
  11:["ひらめきが多く、直感が冴えています。","ふっと来たアイデアを試すと広がります。","言葉にすると伝わりやすくなります。","感性を大切にすると上手くいきます。","静かな集中が味方です."],
  22:["大きな計画を形にできます。","バラバラをまとめるのが得意です。","役割分担で一気に進みます。","長い目で見ると成果が出ます。","現実と理想の橋をかけられます。"],
  33:["やさしさと芸術性が光ります。","人をあたためる言葉が届けられます。","ケアが必要な場で力を発揮します。","小さな思いやりが大きく響きます。","笑顔が周りを救います。"]
};
// 誕生日の数字（bn）による日常のクセ一言（専門語なし）
const BN_HINT = {
  1:"思い立ったらすぐ動けるタイプです。",
  2:"相手の表情から空気を読み取れます。",
  3:"楽しい雰囲気を作るのが得意です。",
  4:"段取りを整えると安心して進めます。",
  5:"予定に遊びを入れると調子が上がります。",
  6:"身近な人を大切にすると運が動きます。",
  7:"深呼吸してから話すと伝わります。",
  8:"やると決めたことは最後まで続けられます。",
  9:"言い方をやわらかくすると通じやすいです.",
  11:"ひらめきをメモ → その日のうちに試すと良いです。",
  22:"大枠を決めてから細かく進めると早いです。",
  33:"やさしい言葉で周りが動きます。"
};
function naturalProfileText(lp, shuku, bn, rng){
  const lines = LP_NATURAL[lp] || ["等身大でOK。小さく進めば必ず前に進みます。"];
  const bnLine = BN_HINT[bn] || "";
  const picked = pickN(rng, lines, Math.min(5, lines.length));
  const env = {
    1:"自分で決められる場",
    2:"安心して話せる場",
    3:"自由に発信できる場",
    4:"落ち着いて積み重ねられる場",
    5:"新しい刺激のある場",
    6:"人の役に立てる場",
    7:"静かに集中できる場",
    8:"結果や数字が追える場",
    9:"人に寄りそえる場",
    11:"ひらめきを試せる場",
    22:"大きな計画を動かす場",
    33:"人を癒やせる場"
  }[lp] || "自分らしくいられる場";
  const shLine = {
    "参水猿":"新しいことに飛び込むほど力が出ます。",
    "觜火猴":"言葉と技術で道を開けます。",
    "奎木狼":"企画や編集の力が光ります。",
    "房日兎":"見せ方が上手で注目を集めます。",
    "心月狐":"やわらかさで人を安心させます。",
    "翼火蛇":"勝ち筋を読むのが得意です。"
  }[shuku] || "あなたらしい雰囲気が周りの空気を良くします。";
  return `
    <p class="lead">🌟 あなたは<strong>${shuku}</strong>の雰囲気をまとったタイプ。次のような良さがあります。</p>
    <ul class="clean">
      ${picked.map(s=>`<li>${s}</li>`).join("")}
      <li>${bnLine}</li>
      <li><strong>力が出る場所：</strong>${env}。</li>
      <li><strong>周りに伝わる魅力：</strong>${shLine}</li>
      <li><strong>今日の合言葉：</strong>「小さく始める → 反応を見る → ひとつ整える」</li>
    </ul>`;
}

/* ========= 惹かれる人＆職業 ========= */
function renderAttractionAndJobs(ulAttract, ulJobs, lp, shuku, rng){
  ulAttract.innerHTML = pickN(rng, ATTRACTION_PATTERNS, 10).map(x=>`<li>${x}</li>`).join("");
  const scored = JOBS_MASTER.map(name=>({name,score:scoreJobByLPShuku(name, lp, shuku)}));
  scored.sort((a,b)=> (b.score - a.score) || (rng()-0.5));
  const picked=[]; const seenTags=new Set();
  for(const it of scored){
    if(picked.length>=8) break;
    const t=jobTags(it.name);
    const hasNew=t.some(x=>!seenTags.has(x));
    if(hasNew || picked.length<4 || it.score>0){ picked.push(it.name); t.forEach(x=>seenTags.add(x)); }
  }
  let idx=0; while(picked.length<8 && idx<scored.length){ const nm=scored[idx++].name; if(!picked.includes(nm)) picked.push(nm); }
  ulJobs.innerHTML = picked.map(x=>`<li>${x}</li>`).join("");
}

/* ========= 相性の長文 ========= */
function compatDeepNarrative(rel,lpA,lpB,shA,shB,rng){
  const tone=REL_TONE[rel]||"";
  const do3=pickN(rng, ["週1回『ありがとう』を言葉で伝える","予定共有を先に（返信ペース合意）","家事・お金・時間の役割をメモ化","短時間でも会う習慣","“見える思い出”を残す","一人時間を確保する"],3);
  const dont3=pickN(rng, ["感情のまま長文を送る","相手の予定に踏み込みすぎる","過去の失敗を掘り返す","即レスの強要","“察して”で伝える"],3);
  const TALK_TOPICS=[
    "最近うれしかった小さなことを1つずつ話す","来月やってみたいことを3つ出して1つ選ぶ",
    "お互いの“得意な家事”を宣言する","今年のうちに終わらせたいことを共有",
    "休みの日の“完璧じゃない過ごし方”を提案","理想の寝る前ルーティンを決める"
  ];
  const DATE_IDEAS=[
    "90分だけの近所カフェはしご","静かな公園で季節の写真を撮る",
    "展示会→感想を3つだけ言い合う","短編配信の同時視聴＋3行レビュー"
  ];
  const REPAIR_STEPS=[
    "5分黙る→深呼吸→『今いちばん困ってること』を1つだけ言う",
    "事実/気持ち/望みの順で1分ずつ話す（タイマー使用）",
    "“ごめん/ありがとう/これからこうする”で締める"
  ];
  const MONEY_RULES=[
    "割り勘か交互払いかを先に決める","月1回“お金・時間・家事”の10分会議",
    "プレゼントの上限を決める"
  ];
  const closeness = choice(rng, ["寝る前の5分ハグor手をつなぐ時間","苦手なスキンシップは“しない”合意","『疲れてる合図』を決めて先に休む"]);
  return `
    <p class="lead"><strong>関係の空気：</strong>${tone}</p>
    <p>ふたりは考え方や感じ方が似ています。そのため理解が早く、安心感も大きい関係です。一方で、同じ所が重なるぶん、主導権の取り合いになりやすいことも。最初に<strong>「任せること・お願いすること」</strong>を決めると、ぶつかりにくくなります。</p>
    <p><strong>すれ違いが起きやすい場面：</strong>疲れているのに話を深めてしまう／予定の共有が遅い／善意の助言が“指示”に聞こえる。<br>合図を作りましょう（例：「今日は静かデー」）。言い合いになる前に休憩をはさむと立て直せます。</p>
    <div class="box">
      <p><strong>やること3つ：</strong>①${do3[0]}　②${do3[1]}　③${do3[2]}</p>
      <p><strong>やらないこと3つ：</strong>①${dont3[0]}　②${dont3[1]}　③${dont3[2]}</p>
      <p><strong>会話のタネ：</strong>${choice(rng, TALK_TOPICS)}</p>
      <p><strong>デート案：</strong>${choice(rng, DATE_IDEAS)}</p>
      <p><strong>仲直りの段取り：</strong>${choice(rng, REPAIR_STEPS)}</p>
      <p><strong>お金のルール：</strong>${choice(rng, MONEY_RULES)}</p>
      <p><strong>距離感：</strong>${closeness}</p>
    </div>`;
}
function renderCompat(target, y,m,d, shA, lpA, tzSel){
  const rng=mulberry32(seedFrom("compat",y,m,d,shA.idx,variantOffset));
  const dB=document.getElementById("birthB").value;
  if(!dB){ target.innerHTML=`<p class="small">相手の生年月日を入れると、ふたりの詳しい取り扱い説明書が表示されます。</p>`; return; }
  const utcB=toDateTZ(dB, document.getElementById("timeB").value||"", tzSel);
  const lpB=lifePath(utcB.getUTCFullYear(),utcB.getUTCMonth()+1,utcB.getUTCDate());
  const shB=shukuOf(utcB);
  const N=27, cw=(shB.idx-shA.idx+N)%N, ccw=(shA.idx-shB.idx+N)%N, dist=Math.min(cw,ccw);
  const rel=relationByDistance(dist);
  const score=compatScore(rel,lpA,lpB);
  target.innerHTML=`
    <div class="row">
      <div class="box"><strong>あなた</strong><br>雰囲気：${shA.name}／数字タイプ：${lpA}</div>
      <div class="box"><strong>お相手</strong><br>雰囲気：${shB.name}／数字タイプ：${lpB}</div>
    </div>
    <p class="lead">ふたりのバランス目安：<strong>${score}/100</strong>｜関係名：<strong>${rel}</strong></p>
    ${compatDeepNarrative(rel,lpA,lpB,shA.name,shB.name,rng)}`;
}

/* ========= カレンダー（36ヶ月固定＝3年） ========= */
function monthLabels(pm,shuku){
  const tags=[]; const add=(l,cls)=>{ if(tags.length<3) tags.push([l,cls]); };
  if(pm===6) add("結婚の話が進みやすい","t-marry");
  if(pm===8) add("昇格・交渉の追い風","t-promo");
  if(pm===1||pm===5||pm===8) add("転職・挑戦に追い風","t-job");
  if(pm===2||pm===6) add("恋愛が育ちやすい","t-love");
  if([1,3,5].includes(pm)) add("出会いのチャンス","t-meet");
  if(pm===5) add("引越しの追い風","t-move");
  if(tags.length<3 && (pm===3||pm===4||pm===8)) add("仕事運：成果に結びつく月","t-work");
  const goodS=["角木蛟","房日兎","尾火虎","箕水豹","昴日鵠","張月鹿","翼火蛇","奎木狼","室火猪","星日馬","軫水蚓"];
  const warnS=["虚日鼠","鬼金羊"];
  if(tags.length<3 && goodS.includes(shuku)) add("雰囲気の追い風","t-meet");
  if(tags.length<3 && warnS.includes(shuku)) add("少し慎重に計画を","t-work");
  return tags;
}
function renderCalendar(root,by,bm,bd,shuku,filters){
  root.innerHTML="";
  const now=new Date();
  const start=new Date(Date.UTC(now.getFullYear(),now.getMonth(),1));
  for(let i=0;i<36;i++){ // ← 36ヶ月固定（3年）
    const d=new Date(Date.UTC(start.getUTCFullYear(),start.getUTCMonth()+i,1));
    const py=pYear(by,bm,bd,d.getUTCFullYear()), pm=pMonth(py,d.getUTCMonth()+1);
    let tags=monthLabels(pm,shuku).filter(([label,cls])=>(
      (cls==="t-love" && filters.love) ||
      (cls==="t-meet" && filters.meet) ||
      (cls==="t-marry" && filters.marry) ||
      (cls==="t-move" && filters.move) ||
      (cls==="t-job" && filters.job) ||
      (cls==="t-work" && filters.work) ||
      (cls==="t-promo" && filters.promo)
    ));
    const box=document.createElement("div");
    const isNow = (d.getUTCFullYear()===now.getFullYear() && d.getUTCMonth()===now.getMonth());
    box.className="mon"+(isNow?" now":"");
    box.innerHTML=`<div class="head"><strong>📅 ${d.getUTCFullYear()}年${d.getUTCMonth()+1}月</strong><span class="small">個人月 ${pm}</span></div>
      <div class="tags">${tags.map(t=>`<span class="tag ${t[1]}">#${t[0]}</span>`).join("")||'<span class="small muted">#準備・休息に良い月</span>'}</div>`;
    root.appendChild(box);
  }
}

/* ========= メイン描画 ========= */
function renderAll(changeOnlyCopy=false){
  const dA=document.getElementById("birthA").value;
  if(!dA){alert("あなたの生年月日を入力してください");return;}
  const tzSel=document.getElementById("tz").value||"";
  const utcA=toDateTZ(dA, document.getElementById("timeA").value||"", tzSel);
  const y=utcA.getUTCFullYear(), m=utcA.getUTCMonth()+1, d=utcA.getUTCDate();
  const shA=shukuOf(utcA), lpA=lifePath(y,m,d), bn=birthNumber(d);

  // KPI
  document.getElementById("lifePath").textContent=lpA;
  document.getElementById("birthNum").textContent=bn;
  document.getElementById("shukuA").textContent=shA.name;
  document.getElementById("pyear").textContent=pYear(y,m,d,(new Date()).getFullYear());

  // 表現バリエーション
  if(!changeOnlyCopy) variantOffset=0; else variantOffset++;
  const rng=mulberry32(seedFrom(y,m,d,shA.idx,variantOffset));

  // 設計図（やさしい言葉）
  document.getElementById("designText").innerHTML = naturalProfileText(lpA, shA.name, bn, rng);

  // 惹かれる人 & 職業
  renderAttractionAndJobs(document.getElementById("attractList"), document.getElementById("jobsList"), lpA, shA.name, rng);

  // 相性
  renderCompat(document.getElementById("compat"), y,m,d, shA, lpA, tzSel);

  // カレンダー（3年固定）
  const filters={}; document.querySelectorAll(".ft").forEach(cb=>filters[cb.value]=cb.checked);
  renderCalendar(document.getElementById("calendar"), y,m,d, shA.name, filters);
}

/* ========= イベント ========= */
document.getElementById("run").addEventListener("click", ()=>renderAll(false));
document.getElementById("shuffle").addEventListener("click", ()=>renderAll(true));
document.getElementById("applyFilter").addEventListener("click", ()=>renderAll(true));
</script>
</body>
</html>
