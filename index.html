<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>四柱推命＋数秘術 Pro（総合リーディング強化＋3年時期）</title>
<style>
:root{--bg:#0b0c10;--card:#151821;--ink:#f5f7ff;--sub:#b6c0d6;--acc:#7ee1b5;--line:#23283a;--good:#66bb6a;--warn:#ffb74d;--bad:#ef5350}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",Roboto,Arial;line-height:1.6}
header{padding:14px 14px 8px;background:linear-gradient(180deg,rgba(0,0,0,.55),transparent)}
h1{margin:0;font-size:18px}small{color:var(--sub)}main{padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
.row{display:flex;gap:8px;flex-wrap:wrap}.col{flex:1 1 160px;min-width:150px}
label{display:block;font-size:12px;color:var(--sub);margin:4px 0 6px}
input,select,button{font-size:16px}input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0e111a;color:#f5f7ff}
.btn{width:100%;padding:12px;border:none;border-radius:12px;font-weight:700;background:var(--acc);color:#0a0a0a}
.kv{display:flex;gap:8px;flex-wrap:wrap}.chip{background:#0e111a;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:13px}
.note{font-size:12px;color:var(--sub)}.small{font-size:12px;color:#9fb0d6}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}th{white-space:nowrap;color:#cfe0ff;text-align:left}
.bars{display:flex;gap:8px;align-items:flex-end;height:150px;border-bottom:1px dashed var(--line);padding:6px 2px}
.bar{flex:1;min-width:40px;border-radius:8px 8px 0 0;background:linear-gradient(180deg,#67e8f9,#22d3ee)}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
.err{display:none;background:#331a1a;color:#ffc9c9;border:1px solid #5b2a2a;padding:8px;border-radius:8px;margin-top:6px;font-size:13px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;margin:2px;color:#e0f2f1}
.hr{height:1px;background:var(--line);margin:8px 0}
.good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
@media(max-width:560px){.grid2{grid-template-columns:1fr}}
.kcell{border:1px solid var(--line);border-radius:10px;padding:8px}
.kcal{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.km{border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center}
.km b{display:block;margin-bottom:4px}
.hitBoth{border-color:#7ee1b5;background:rgba(126,225,181,.12)}
.hitNum{border-color:#4fc3f7;background:rgba(79,195,247,.08)}
.hitSi{border-color:#ffb74d;background:rgba(255,183,77,.10)}
.marry{outline:2px solid #ffd166; box-shadow:0 0 0 3px rgba(255,209,102,.18) inset}
</style></head>
<body>
<header>
  <h1>四柱推命＋数秘術 Pro</h1>
  <small>性格・恋愛観・仕事の向き・長所/短所・相性・結婚/出会い/転職/独立の時期（3年）</small>
</header>

<main>
  <!-- 入力 -->
  <div class="card">
    <div class="row">
      <div class="col"><label>年(西暦)</label><input id="y" type="number" value="1990"></div>
      <div class="col"><label>月</label><input id="m" type="number" min="1" max="12" value="1"></div>
      <div class="col"><label>日</label><input id="d" type="number" min="1" max="31" value="1"></div>
      <div class="col"><label>出生時刻（24h, 例 12:00）</label><input id="hm" value="12:00"></div>
    </div>
    <div class="row">
      <div class="col"><label>蔵干を五行に含める</label><select id="zOpt"><option value="on">含める</option><option value="off">含めない</option></select></div>
      <div class="col"><label>蔵干ウェイト</label><select id="zW"><option value="eq">等分</option><option value="pri">主0.6/次0.25/末0.15</option></select></div>
      <div class="col"><label>月柱の判定</label><select id="setu"><option value="const">高精度：定気法</option><option value="mean">簡易：平均節入り</option></select></div>
      <div class="col"><label>　</label><button class="btn" id="run">鑑定する</button></div>
    </div>
    <div id="err" class="err">日付/時刻を見直してね</div>
  </div>

  <!-- 命式 -->
  <div class="card">
    <h3>◆ 命式（四柱）＋やさしい読み方</h3>
    <div class="kv" id="ms"></div>
    <div id="tbl" style="margin-top:8px"></div>
  </div>

  <!-- 五行 -->
  <div class="card">
    <h3>◆ 五行バランス（性格の配合）</h3>
    <small class="note">🌱成長 / 🔥伝える / 🏠安心 / ✨整える / 💬つなぐ</small>
    <div class="note">棒＝“材料配合”。多い→それを看板に／少ない→習慣で補強。</div>
    <div id="bars" class="bars"></div>
    <div id="fftags" style="margin-top:6px"></div>
    <div id="fiveExplain" style="margin-top:8px"></div>
    <div id="fiveMore" style="margin-top:8px"></div>
  </div>

  <!-- 総合リーディング -->
  <div class="card">
    <h3>◆ 総合リーディング（四柱＋数秘）</h3>
    <div class="kcell"><b>宿曜アドバイス</b><div id="shukuLine"></div></div>

    <div class="grid2">
      <div class="kcell"><b>性格・才能・人間関係の傾向</b><div id="traits"></div></div>
      <div class="kcell"><b>恋愛観（四柱＋数秘・長文）</b><div id="loveView"></div></div>
      <div class="kcell"><b>おすすめのビジネス／働き方</b><div id="business"></div></div>
      <div class="kcell"><b>長所・短所（使い方のコツ：深掘り）</b><div id="strengths"></div></div>
    </div>

    <div class="grid2" style="margin-top:8px">
      <div class="kcell"><b>転職アドバイス（宿曜×四柱×数秘：ロング）</b><div id="jobAdvice"></div></div>
      <div class="kcell"><b>引越しアドバイス（宿曜×四柱×数秘：ロング）</b><div id="moveAdvice"></div></div>
      <div class="kcell"><b>結婚アドバイス（宿曜×四柱×数秘：ロング）</b><div id="marryAdvice"></div></div>
    </div>

    <div class="hr"></div>
    <div class="kcell"><b>深掘りリーディング（テーマ＆合言葉）</b><div id="deepRead" class="note" style="margin-top:4px"></div></div>
  </div>

  <!-- 相性 -->
  <div class="card">
    <h3>◆ 相性（四柱＋数秘：恋愛／友情／ビジネス）</h3>
    <div class="row">
      <div class="col"><label>相手の年</label><input id="py2" type="number" value="1995"></div>
      <div class="col"><label>相手の月</label><input id="pm2" type="number" min="1" max="12" value="8"></div>
      <div class="col"><label>相手の日</label><input id="pd2" type="number" min="1" max="31" value="15"></div>
      <div class="col"><label>相手の出生時刻（任意）</label><input id="phm2" placeholder="例 07:20"></div>
      <div class="col"><label>　</label><button class="btn" id="compatBtn">相性を診断</button></div>
    </div>
    <div id="compatOut" style="margin-top:6px"></div>
  </div>

  <!-- 時期 -->
  <div class="card">
    <h3>◆ 時期のサイン（これから3年）</h3>
    <div class="note">色：<span class="hitBoth">四柱＋数秘の両方で◎</span>／<span class="hitNum">数秘で◎</span>／<span class="hitSi">四柱で◎</span>　💍＝結婚に特に良い月</div>
    <div id="timing" class="kcal" style="margin-top:6px"></div>
    <div class="small" id="timingLegend"></div>
    <div class="hr"></div>
    <div class="small" id="marryList"></div>
  </div>
</main>

<script>
// ===== 干支/五行 基本 =====
var S=["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"],
    SE={"甲":"木","乙":"木","丙":"火","丁":"火","戊":"土","己":"土","庚":"金","辛":"金","壬":"水","癸":"水"},
    SY={"甲":"陽","乙":"陰","丙":"陽","丁":"陰","戊":"陽","己":"陰","庚":"陽","辛":"陰","壬":"陽","癸":"陰"};
var B=["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"],
    MB=["寅","卯","辰","巳","午","未","申","酉","戌","亥","子","丑"];
var ZM={"子":["壬"],"丑":["己","癸","辛"],"寅":["甲","丙","戊"],"卯":["乙"],"辰":["戊","乙","癸"],"巳":["丙","戊","庚"],"午":["丁","己"],"未":["己","丁","乙"],"申":["庚","壬","戊"],"酉":["辛"],"戌":["戊","辛","丁"],"亥":["壬","甲"]};
var E=["木","火","土","金","水"],
    GEN={"木":"火","火":"土","土":"金","金":"水","水":"木"},
    CTL={"木":"土","土":"水","水":"火","火":"金","金":"木"};
var HEX=[["子","丑"],["寅","亥"],["卯","戌"],["辰","酉"],["巳","申"],["午","未"]];
var CHONG=[["子","午"],["丑","未"],["寅","申"],["卯","酉"],["辰","戌"],["巳","亥"]];
var BR_E={"子":"水","丑":"土","寅":"木","卯":"木","辰":"土","巳":"火","午":"火","未":"土","申":"金","酉":"金","戌":"土","亥":"水"};
var PEACH_BY_DAY={"寅":"卯","午":"卯","戌":"卯","申":"酉","子":"酉","辰":"酉","亥":"子","卯":"子","未":"子","巳":"午","酉":"午","丑":"午"};

// ===== ユーティリティ =====
function parseHM(s){if(!s)return[12,0];var m=/^(\d{1,2}):(\d{2})$/.exec(s);if(!m)return[12,0];var h=+m[1],mm=+m[2];return[Math.min(23,Math.max(0,h)),Math.min(59,Math.max(0,mm))];}
function JDN(y,m,d){var a=Math.floor((14-m)/12),y2=y+4800-a,m2=m+12*a-3;return d+Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045;}
function sexIdx(j){var base=JDN(1984,2,2);var diff=j-base;var r=diff%60;if(r<0)r+=60;return r;}
function dayP(y,m,d){var idx=sexIdx(JDN(y,m,d));return [S[idx%10], B[idx%12]];}
function hourB(h){if(h>=23||h<1)return"子";var M=["丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];return M[Math.floor((h-1)/2)];}
function hourS(ds,hb){var m={"甲":"甲","己":"甲","乙":"丙","庚":"丙","丙":"戊","辛":"戊","丁":"庚","壬":"庚","戊":"壬","癸":"壬"},base=m[ds],off={"子":0,"丑":1,"寅":2,"卯":3,"辰":4,"巳":5,"午":6,"未":7,"申":8,"酉":9,"戌":10,"亥":11};return S[(S.indexOf(base)+off[hb])%10];}
function tenGod(d,o){var me=SE[d],my=SY[d],oe=SE[o],oy=SY[o];
  if(oe===me)return my===oy?"比肩":"劫財";
  if(GEN[oe]===me)return my===oy?"偏印":"印綬";
  if(GEN[me]===oe)return my===oy?"傷官":"食神";
  if(CTL[me]===oe)return my===oy?"偏財":"正財";
  if(CTL[oe]===me)return my===oy?"偏官":"正官";
  return "";
}
function cnt(stems){var c={"木":0,"火":0,"土":0,"金":0,"水":0}; for(var i=0;i<stems.length;i++){var s=stems[i]; if(SE[s]) c[SE[s]]+=1;} return c;}
function add(dst,src,w){w=w||1; for(var k in dst){dst[k]+= (src[k]||0)*w;}}
function inPairs(list,a,b){for(var i=0;i<list.length;i++){var p=list[i]; if((p[0]==a&&p[1]==b)||(p[0]==b&&p[1]==a)) return true;} return false;}

// ===== 二十四節気（定気法・JST 簡易） =====
function toJD(date){return JDN(date.getUTCFullYear(),date.getUTCMonth()+1,date.getUTCDate()) + (date.getUTCHours()-12)/24 + date.getUTCMinutes()/1440;}
function sunLonDeg(jd){var T=(jd-2451545.0)/36525;var L0=(280.46646+36000.76983*T+0.0003032*T*T)%360;var M=357.52911+35999.05029*T-0.0001537*T*T;var C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(M*Math.PI/180)+(0.019993-0.000101*T)*Math.sin(2*M*Math.PI/180)+0.000289*Math.sin(3*M*Math.PI/180);var trueLon=L0+C;return (trueLon+360)%360;}
function findTermJST(year){
  var out=[],targets=[315,345,15,45,75,105,135,165,195,225,255,285];
  for(var i=0;i<targets.length;i++){
    var approx=new Date(Date.UTC(year, i<11?i+1:0, 4, 6, 0));
    var jd0=toJD(approx), step=0.5/24, best=jd0, last=999;
    for(var k=-240;k<=240;k++){
      var jd=jd0+k*step, lon=sunLonDeg(jd), diff=((lon - targets[i] + 540)%360)-180;
      if(Math.abs(diff)<last){last=Math.abs(diff);best=jd;}
    }
    var d=new Date((best-2440587.5)*86400000); var jst=new Date(d.getTime()+9*3600000);
    out.push(jst);
  }
  return out;
}
var meanSetu=[{m:2,d:4},{m:3,d:6},{m:4,d:5},{m:5,d:6},{m:6,d:6},{m:7,d:7},{m:8,d:7},{m:9,d:7},{m:10,d:8},{m:11,d:7},{m:12,d:7},{m:1,d:6}];
function yearP(y,m,d){
  try{
    var terms=findTermJST(y);var risshun=terms[0];var cur=new Date(y,m-1,d,12);
    var jy=(cur<risshun)?(y-1):y;var yi=((jy-1984)%60+60)%60;
    return [S[yi%10],B[yi%12]];
  }catch(e){
    var before=(m<2)||(m==2&&d<4),jy=before?y-1:y;var yi=((jy-1984)%60+60)%60;return [S[yi%10],B[yi%12]];
  }
}
function monthP(y,m,d,ys){
  function autoIndex(){
    try{
      var terms=findTermJST(y);var cur=new Date(y,m-1,d,12);var idx=-1;
      for(var i=0;i<12;i++){var a=terms[i],b=(i<11?terms[i+1]:findTermJST(y+1)[0]);if(cur>=a&&cur<b){idx=i;break;}}
      return (idx<0)?11:idx;
    }catch(e){
      var arr=[],i;for(i=0;i<12;i++){var t=meanSetu[i],yy=y,mmm=t.m;if(mmm==1)yy=y+1;arr.push({y:yy,m:mmm,d:t.d,idx:i});}
      var v=y*10000+m*100+d;for(i=0;i<12;i++){var a=arr[i],tv=a.y*10000+a.m*100+a.d;if(v<tv)return (i+11)%12;}return 11;
    }
  }
  var idx=(document.getElementById("setu").value==="const")?autoIndex(): (function(){var arr=[],i;for(i=0;i<12;i++){var t=meanSetu[i],yy=y,mmm=t.m;if(mmm==1)yy=y+1;arr.push({y:yy,m:mmm,d:t.d,idx:i});}var v=y*10000+m*100+d;for(i=0;i<12;i++){var a=arr[i],tv=a.y*10000+a.m*100+a.d;if(v<tv)return (i+11)%12;}return 11;})();
  var br=MB[idx]; var map={"甲":"丙","己":"丙","乙":"戊","庚":"戊","丙":"庚","辛":"庚","丁":"壬","壬":"壬","戊":"甲","癸":"甲"}, st=map[ys], si=S.indexOf(st);
  return [S[(si+idx)%10], br];
}

// ===== 数秘 =====
function pad(n){return (n<10?"0":"")+n;}
function reduceNum(n){
  n=(""+n).replace(/\D/g,"");var s=0;for(var i=0;i<n.length;i++) s+=(+n[i]);
  if(s===11||s===22||s===33) return s;
  while(s>9){var t=0;var str=""+s;for(var j=0;j<str.length;j++) t+=(+str[j]); if(t===11||t===22||t===33){s=t;break;} s=t;}
  return s;
}
function lifePath(y,m,d){return reduceNum(""+y+pad(m)+pad(d));}
function birthdayNum(d){return (d>=10)?reduceNum(""+d):d;}
function personalYear(m,d,curY){return reduceNum(reduceNum(""+curY)+reduceNum(""+m)+reduceNum(""+d));}
function personalMonth(py, calMonth){return reduceNum(py + calMonth);}

// ===== 宿曜（厳密/近似/DB/相性） =====
var SHUKU_NAMES=["角","亢","氐","房","心","尾","箕","斗","女","虚","危","室","壁","奎","婁","胃","昴","畢","觜","参","井","鬼","柳","星","張","翼","軫"];
var SHUKU_DB={
"角":{e:"木",n:"芽出し・スタート",love:"主導を握りすぎず“任せる日”を作る",work:"企画/営業/開拓に吉",meet:"朝活/新規スポット",str:["行動力","開拓"],cau:["焦り","続かない"]},
"亢":{e:"木",n:"誇り・美意識",love:"謝る速さが魅力を増幅",work:"品質/デザイン",meet:"美術館/セレショ",str:["矜持","審美"],cau:["頑固","批判"]},
"氐":{e:"土",n:"基礎・安定",love:"安心の頻度設計が鍵",work:"経理/不動産",meet:"地元/常連店",str:["堅実","継続"],cau:["保守"]},
"房":{e:"火",n:"人気・華",love:"褒めは具体的に",work:"広報/接客/エンタメ",meet:"人の集まる場",str:["社交","表現"],cau:["浪費","目移り"]},
"心":{e:"火",n:"情熱・直感",love:"熱→クールダウンもセット",work:"研究/芸術/スピ",meet:"夜/水辺",str:["集中","霊感"],cau:["燃え尽き"]},
"尾":{e:"火",n:"完遂・締め",love:"約束厳守が最大の色気",work:"締切/QA",meet:"達成の場",str:["責任感","完了"],cau:["杓子定規"]},
"箕":{e:"木",n:"情報・発信",love:"短文＋絵文字でテンポ",work:"SNS/編集/営業",meet:"オンライン/イベント",str:["拡散","交渉"],cau:["散漫"]},
"斗":{e:"水",n:"守り・蓄財",love:"節約に工夫と温かさ",work:"財務/倉庫",meet:"リユース/倉庫型",str:["守備","貯蓄"],cau:["守り過多"]},
"女":{e:"水",n:"共感・受容",love:"相手の物語を要約して返す",work:"ケア/接客/HR",meet:"カフェ/サロン",str:["共感","癒し"],cau:["受け身"]},
"虚":{e:"金",n:"理想・革新",love:"理想→今日の1歩に落とす",work:"IT/戦略/新規",meet:"コワーキング",str:["構想","改革"],cau:["地に足不足"]},
"危":{e:"金",n:"冒険・スリル",love:"刺激は“安心の契約”とセット",work:"スタートアップ/投資",meet:"ナイトシーン",str:["挑戦","突破"],cau:["無謀"]},
"室":{e:"水",n:"整備・秩序",love:"段取り＝愛情表現",work:"法務/運用/PM",meet:"図書館/役所",str:["構築","保守"],cau:["硬直"]},
"壁":{e:"土",n:"守護・境界",love:"“嫌は嫌”の線引きが魅力",work:"セキュリティ/監査",meet:"会員制/クローズド",str:["防御","規律"],cau:["閉鎖"]},
"奎":{e:"木",n:"知性・文芸",love:"要点3つで伝える",work:"編集/教育",meet:"書店/学び場",str:["知性","文章"],cau:["理屈っぽい"]},
"婁":{e:"土",n:"管理・整頓",love:"スケジュール共有が愛",work:"物流/管理職",meet:"ホームセンター",str:["整頓","運用"],cau:["融通不足"]},
"胃":{e:"土",n:"滋養・育成",love:"“一緒に食べる”が開運",work:"飲食/農/育成",meet:"市場/食",str:["育む","実務"],cau:["過干渉"]},
"昴":{e:"金",n:"鋭敏・分析",love:"批評の前に称賛を一言",work:"分析/監査/医療",meet:"ラボ",str:["観察","分析"],cau:["批判的"]},
"畢":{e:"金",n:"収穫・まとめ",love:"終わらせる勇気が次を呼ぶ",work:"締切/納品/会計",meet:"仕事終わり",str:["完結","刈取り"],cau:["潔癖"]},
"觜":{e:"水",n:"言語・学習",love:"学び合う関係が長続き",work:"教育/通訳/PR",meet:"勉強会",str:["言語化","学習"],cau:["言い過ぎ"]},
"参":{e:"木",n:"戦略・実行",love:"作戦会議→実行→振返り",work:"戦略/施工",meet:"現場/工房",str:["計画","遂行"],cau:["硬直"]},
"井":{e:"水",n:"共同体・共有",love:"“みんなで”を恋にも",work:"コミュニティ",meet:"ローカル場",str:["共有","互助"],cau:["依存"]},
"鬼":{e:"木",n:"独創・オカルト",love:"マニアックは武器。翻訳して魅せる",work:"研究/スピ/企画",meet:"マニア界隈",str:["独創","洞察"],cau:["孤立"]},
"柳":{e:"水",n:"柔軟・流通",love:"受け流し＋肯定の相槌",work:"貿易/流通/接遇",meet:"水辺",str:["柔軟","緩衝"],cau:["優柔不断"]},
"星":{e:"火",n:"名声・演出",love:"見せ方＝優しさ。裏方も忘れず",work:"動画/舞台/広報",meet:"劇場/配信",str:["演出","注目"],cau:["承認欲求"]},
"張":{e:"火",n:"拡大・布陣",love:"“二人の目標”を文字にする",work:"営業/陣形",meet:"展示会",str:["展開","布陣"],cau:["背伸び"]},
"翼":{e:"木",n:"支援・移動",love:"相手の翼になる一言を",work:"旅/交通/サポート",meet:"駅/空港",str:["支援","移動"],cau:["流浪"]},
"軫":{e:"水",n:"慈愛・まとめ",love:"“ありがとう”を先に",work:"医療/福祉/調停",meet:"相談室",str:["慈悲","調停"],cau:["抱え込み"]}
};
// 近似
var SHUKU_BASE=new Date("1900-01-01T00:00:00Z");
function computeHonmeishukuApprox(y,m,d){var dt=new Date(Date.UTC(y,m-1,d));var diff=Math.floor((dt-SHUKU_BASE)/(86400000));var idx=((diff%27)+27)%27;return SHUKU_NAMES[idx];}
function shukuyoLineHTML(name){var x=SHUKU_DB[name]||{e:"",n:"",love:"",work:"",meet:"",str:[],cau:[]};return '本命宿：<b>'+name+'</b>（'+x.e+'／'+x.n+'）｜恋愛：'+x.love+'｜仕事：'+x.work+'｜出会い：'+x.meet+'｜長所：'+(x.str||[]).join("・")+'｜注意：'+(x.cau||[]).join("・");}
// 厳密（朔→通日）
var SYNODIC=29.530588861, REF_NEW_MOON_UTC=Date.UTC(2000,0,6,18,14,0);
function jstMidnightUTC(y,m,d){return Date.UTC(y,m-1,d,-9,0,0);}
function nearestNewMoonUTC(ts){var k=Math.floor((ts-REF_NEW_MOON_UTC)/(SYNODIC*86400000));var nm=REF_NEW_MOON_UTC+k*SYNODIC*86400000;if(nm>ts)nm-=SYNODIC*86400000;return nm;}
function lunarDayJST(y,m,d){var j=jstMidnightUTC(y,m,d),nm=nearestNewMoonUTC(j);return Math.floor((j-nm)/86400000)+1;}
var SHUKU_OFFSET=0;
function computeHonmeishukuStrict(y,m,d){var ld=lunarDayJST(y,m,d);var idx=((ld-1+SHUKU_OFFSET)%27+27)%27;return SHUKU_NAMES[idx];}
// 相性タイプ
var SHUKU_PAIR_TABLE={
 "0":{type:"命",brief:"同質・同調。鏡。",advice:"似ているほど“役割”を分けて衝突回避。"},
 "1":{type:"友",brief:"仲間・対等。軽快。",advice:"合言葉を作り、得意を褒め合う。"},
 "2":{type:"栄",brief:"発展。華やぐ。",advice:"目標共有と拍手の量を増やす。"},
 "3":{type:"安",brief:"安心・暮らし向き。",advice:"頻度と約束を言葉に。生活基準を揃える。"},
 "4":{type:"成",brief:"現実化・前進。",advice:"期日と担当を決め小さく進める。"},
 "5":{type:"衰",brief:"クールダウン。",advice:"休息とメンテ。言葉の温度を1段下げる。"},
 "6":{type:"危",brief:"刺激・冒険。",advice:"合意した“安全策”の中で冒険を。"},
 "7":{type:"壊",brief:"刷新。",advice:"関係の“目的”を再定義。時間制限を。"},
 "8":{type:"障",brief:"摩擦。訓練。",advice:"要約→合意→小実験で信頼を積む。"},
 "9":{type:"殺",brief:"遠距離・縁薄。",advice:"境界線を丁寧に。短いセッションで区切る。"}
};
function shukuyoPairType(a,b){var ia=SHUKU_NAMES.indexOf(a),ib=SHUKU_NAMES.indexOf(b);if(ia<0||ib<0)return{type:"",brief:"",advice:""};var d=Math.min((ib-ia+54)%27,(ia-ib+54)%27);return SHUKU_PAIR_TABLE[String(d)]||SHUKU_PAIR_TABLE["9"];}
// 宿曜近似スコア（ブレンド用）
function shukuyoCompatApprox(a,b){var ia=SHUKU_NAMES.indexOf(a),ib=SHUKU_NAMES.indexOf(b);if(ia<0||ib<0)return{type:"",score:75,label:"◯",note:""};var dist=Math.min(Math.abs(ia-ib),27-Math.abs(ia-ib));var t="",s=0;if(dist===0){t="命";s=90}else if(dist<=2){t="友/栄";s=86}else if(dist<=4){t="安/成";s=82}else if(dist<=6){t="衰/危";s=74}else if(dist<=8){t="壊/障";s=68}else{t="殺";s=62}var face=(s>=86?"◎":(s>=80?"◯":(s>=74?"△":"▲")));return{type:t,score:s,label:face,note:"（宿曜近似スコア）"};}

// ===== 会話テンプレ（五行別） =====
function talkPatternByElem(elem){
  return {
    "木":"気持ち → 一言ほめる → 次の一歩",
    "火":"想い → 短い言葉 → すぐ行動",
    "土":"要点 → 約束 → 日にちを決める",
    "金":"結論 → 理由 → 提案",
    "水":"気持ち → 要約 → 質問"
  }[elem] || "結論 → 理由 → 提案";
}

// ===== 鑑定本体 =====
function run(){
  var y=+document.getElementById("y").value, m=+document.getElementById("m").value, d=+document.getElementById("d").value;
  var hm=document.getElementById("hm").value, t=parseHM(hm), hh=t[0];
  if(!(y>0&&m>=1&&m<=12&&d>=1&&d<=31)){document.getElementById("err").style.display="block";return;}
  document.getElementById("err").style.display="none";

  var dp=dayP(y,m,d), ds=dp[0], db=dp[1];
  var yp=yearP(y,m,d), ys=yp[0], yb=yp[1];
  var mp=monthP(y,m,d,ys), ms=mp[0], mb=mp[1];
  var hb=hourB(hh), hs=hourS(ds,hb);

  // 命式
  document.getElementById("ms").innerHTML=[
    '年：<b>'+ys+yb+'</b>（育ち/家）','月：<b>'+ms+mb+'</b>（社会/仕事）','日：<b>'+ds+db+'</b>（中心）','時：<b>'+hs+hb+'</b>（考え/将来）'
  ].map(x=>'<div class="chip">'+x+'</div>').join('');

  var TGtxt={"比肩":"自分でやる力","劫財":"仲間と突破","食神":"表現と楽しさ","傷官":"改善と分析","偏財":"ご縁とチャンス","正財":"約束と信頼","偏官":"挑戦と行動","正官":"役割と評価","偏印":"ひらめき","印綬":"学びと理解"};
  function row(p){var tg=tenGod(ds,p[1]), easy={"比肩":"自立/自分軸","劫財":"仲間で突破","食神":"楽しく表現","傷官":"改善/分析","偏財":"ご縁・行動","正財":"約束・信頼","偏官":"小さく挑戦","正官":"役割・評価","偏印":"直感を試す","印綬":"学びで強化"}[tg]||"";return '<tr><th>'+p[0]+'</th><td>'+p[1]+'</td><td>'+p[2]+'</td><td>'+tg+'</td><td>'+(TGtxt[tg]||"")+'</td><td class="small">'+p[3]+'｜'+easy+'</td></tr>';}
  document.getElementById("tbl").innerHTML='<table><thead><tr><th>柱</th><th>天干</th><th>地支</th><th>通変星</th><th>意味</th><th>やさしい読み方</th></tr></thead><tbody>'+[["年柱",ys,yb,"家の雰囲気"],["月柱",ms,mb,"社会での顔"],["日柱",ds,db,"性格の核心"],["時柱",hs,hb,"考え/将来像"]].map(row).join('')+'</tbody></table>';

  // 五行（蔵干込み）
  function zWeights(z){var l=ZM[z]||[]; if(l.length==1)return[1]; if(document.getElementById("zW").value==="eq"){return l.map(()=>1/l.length);} return l.length==2?[0.65,0.35]:[0.6,0.25,0.15].slice(0,l.length);}
  var vis=cnt([ys,ms,ds,hs]), zc={"木":0,"火":0,"土":0,"金":0,"水":0}, pillars=[[ys,yb],[ms,mb],[ds,db],[hs,hb]];
  for(var i=0;i<pillars.length;i++){var zlist=ZM[pillars[i][1]]||[], w=zWeights(pillars[i][1]); for(var j=0;j<zlist.length;j++){add(zc,cnt([zlist[j]]), w[j]||0);}}
  var useZ=document.getElementById("zOpt").value==="on", total={}; E.forEach(e=>total[e]=(vis[e]||0)+(useZ?zc[e]||0:0));
  var mx=Math.max.apply(null,E.map(e=>total[e]||0));
  var FIVE_LABEL={"木":"🌱 成長（木）","火":"🔥 伝える（火）","土":"🏠 安心（土）","金":"✨ 整える（金）","水":"💬 つなぐ（水)"};
  function showFive(k){return (FIVE_LABEL[k]||k);}
  var bars = E.map(function(e){var h=mx?Math.round((total[e]||0)/mx*140)+6:6;return '<div style="flex:1;text-align:center"><div class="bar" style="height:'+h+'px"></div><div class="small" style="padding-top:6px">'+showFive(e)+' '+(total[e]||0).toFixed(2)+'</div></div>';}).join('');
  document.getElementById("bars").innerHTML=bars; var ord=E.slice().sort((a,b)=>(total[b]||0)-(total[a]||0));
  document.getElementById("fftags").innerHTML='<span class="badge">強み：'+showFive(ord[0])+'</span><span class="badge">育てどき：'+showFive(ord[4])+'</span>';

  var meaning={
    "木":{mean:"“伸びしろ”を見つけ育てる力",strong:"あなたが関わると、人や企画が伸びます。小さな芽に光を当てるのが得意。",weak:"伸び悩む時は“朝の光・新しいヒント・1行の発信”を足すと根が強くなります。"},
    "火":{mean:"想いを伝えて人を動かす力",strong:"声・表情・一言の熱量で空気を変えられます。『伝える回数』が成果に直結。",weak:"冷えを感じたら“体を温める→短文で想いを言う→小さく行動”の順で火を点け直す。"},
    "土":{mean:"段取りと継続で安心を作る力",strong:"あなたの段取りが、周りの自信になります。チェックリストは金脈。",weak:"先延ばしは土台不足のサイン。“5分でできる”小さな締切を置くと進みます。"},
    "金":{mean:"いらないものを削り価値を際立てる力",strong:"基準を決め、整えて、品質を守れる人。『削る』ほど良さが立ち上がります。",weak:"散らかりはチャンス。今日は“捨て1・整え5分・基準1つ決める”で切れ味が戻る。"},
    "水":{mean:"情報と気持ちをつないで流す力",strong:"聴いて、まとめて、共有するのが上手。橋渡し役で信頼が溜まります。",weak:"考えが詰まったら“3行日記→15分散歩→要約1ページ”。水路が開通します。"}
  };
  var sumVal=E.reduce((a,k)=>a+(total[k]||0),0)||1;
  var avg=sumVal/5;
  function lv(v){if(v>=avg*1.15)return"強め（看板に）"; if(v<=avg*0.85)return"弱め（習慣で育てる）"; return"ほどよい（このまま◎）";}
  document.getElementById("fiveExplain").innerHTML=E.map(function(k){
    var v=(total[k]||0), state=lv(v);
    var tip=state.indexOf("強め")>=0?meaning[k].strong:state.indexOf("弱め")>=0?meaning[k].weak:"今のバランスをそのまま活かせばOK。";
    var stateNice=state.replace("強め（看板に）","<b>あなたの武器</b>").replace("弱め（習慣で育てる）","<b>いま育てどき</b>").replace("ほどよい（このまま◎）","<b>ちょうど良い</b>");
    return '<div class="tag">'+showFive(k)+'：'+meaning[k].mean+' ／ '+stateNice+' → '+tip+'</div>';
  }).join('');

  var goodE=ord[0], badE=ord[4];
  var goodLine={
    "木":"“人や企画の芽を見つける→1つだけ光を当てる”。これがあなたの勝ち筋です。",
    "火":"“短く伝える回数”を増やすだけで景色が変わります。まずは一言でOK。",
    "土":"“手順を見える化”すると周りが走りやすくなります。あなたが合図役です。",
    "金":"“いらない1つを手放す”たびに軸が立ちます。磨くほど信頼が増えます。",
    "水":"“聴く→まとめる→共有”の3拍子で人が動きます。橋をかけるのが得意分野。"
  }[goodE];
  var badLine={
    "木":"朝の光を浴びて、新しいヒントを1つ取り入れる。夜は“ありがとう”を1つ贈る。",
    "火":"体を温めて声を出す→短文で想いを伝える→小さく動く。これで火が点きます。",
    "土":"“5分だけ”の小さな締切を置く。やる日/休む日を分けると前に進めます。",
    "金":"捨て1・整え5分・基準1つ。小さな整えが、大きな自信につながります。",
    "水":"3行日記→15分散歩→要約1ページ。流れが戻れば、自然に動けます。"
  }[badE];
  var daily={
    "木":"🌱 朝：日光3分／昼：新しい芽を1つ探す／夜：“ありがとう”を1つ送る",
    "火":"🔥 朝：体を温める／昼：短文で想いを一言発信／夜：今日の“良かった”を1つ共有",
    "土":"🏠 朝：片付け5分／昼：チェックリストで1タスク完了／夜：明日の小締切を1つ設定",
    "金":"✨ 朝：捨て1／昼：整え5分／夜：基準を1行更新（“これはOK/これはNO”）",
    "水":"💬 朝：3行日記／昼：散歩15分／夜：今日の学びを要約1ページ"
  }[badE];
  document.getElementById("fiveMore").innerHTML=
    '<div class="kcell"><b>伸ばす：'+showFive(goodE)+'</b><div class="note">'+goodLine+'</div></div>'+
    '<div class="kcell" style="margin-top:6px"><b>育てどき：'+showFive(badE)+'</b><div class="note">'+badLine+'</div></div>'+
    '<div class="kcell" style="margin-top:6px"><b>毎日の型（'+showFive(badE)+'）</b><div class="note">'+daily+'</div></div>';

  // ==== 恋愛観（2割短縮＆平易） ====
  function longLoveText(lp,eCore,tgLead,db){
    var base={"木":"恋は“育てる”。小さな会話をコツコツ重ねるほど安心が育つ。","火":"恋は“温度”。想いは短い言葉と行動で伝える。シンプルが最強。","土":"恋は“設計”。連絡の頻度やお金のルールを先に決めると一気に進む。","金":"恋は“ていねい”。清潔感とマナーが信頼になる。ルールは2つでOK。","水":"恋は“対話”。気持ちを言葉にしよう。散歩しながら話すと本音が出る。"}[eCore];
    var lpAdd={1:"リード上手。先に相手の気持ちを聞けるともっと信頼される。",2:"寄り添い名人。無理な時はやさしく“NO”を言おう。",3:"楽しい場づくりが得意。約束だけは軽くしないで。",4:"安定派。将来のイメージを共有すると決断が早い。",5:"自由重視。連絡ルールを決めるとケンカが減る。",6:"面倒見◎。自分のケア日も作るとバランスが良い。",7:"一人時間が燃料。沈黙は“拒否”ではないと伝えておく。",8:"頼れる人。強く出る時ほど言葉はやさしく。",9:"共感力が武器。境界線は忘れずに。",11:"心の通い合いに価値。急がず安心を育てる。",22:"大きな目標を二人で。共同プロジェクトが接着剤。",33:"包容力。抱え込み過ぎないよう“助けて”と言う日を。"}[lp];
    var tgAdd={"比肩":"“私はこうしたい”を素直に。合わせ過ぎない。","劫財":"作戦会議が効く。共同目標を一つ持とう。","食神":"笑顔とユーモアが最大の魅力。良かった所を一言で返す。","傷官":"ダメ出しは“提案の形”で渡す。","偏財":"会う回数＝安心。誘いは軽く早めに。","正財":"誠実さが武器。小さな約束を積み上げる。","偏官":"熱は宝。結論の前にワンクッション。","正官":"礼儀が色気。落ち着いた場所で丁寧に。","偏印":"直感は当たる。言葉で補助線を引く。","印綬":"学びを要約して渡すと刺さる。"}[tgLead]||"";
    var peach=PEACH_BY_DAY[db]?("桃花（出会いの風）：「"+PEACH_BY_DAY[db]+"」"):"";
    return ['<p class="note">【恋の軸】'+base+'</p>',(lpAdd?'<p class="note">【あなたの強み】'+lpAdd+'</p>':''),(tgAdd?'<p class="note">【伝え方のコツ】'+tgAdd+'</p>':''),(peach?'<p class="note">【出会いの合図】'+peach+' の月・人に注目。</p>':'')].join("");
  }
  var lp=lifePath(y,m,d), bd=birthdayNum(d);

  // top通変星算出
  var tgAll={}, pillarsGan=[ys,ms,hs];
  pillarsGan.forEach(g=>{var t=tenGod(ds,g); if(t) tgAll[t]=(tgAll[t]||0)+1;});
  (ZM[db]||[]).forEach(zg=>{var t=tenGod(ds,zg); if(t) tgAll[t]=(tgAll[t]||0)+1;});
  var topTG=Object.keys(tgAll).sort((a,b)=>(tgAll[b]||0)-(tgAll[a]||0));

  var loveLongHTML=longLoveText(lp,SE[ds],(topTG[0]||""),db);
  document.getElementById("loveView").innerHTML=loveLongHTML;

  // 宿曜ライン
  var shuku=(function(){try{return computeHonmeishukuStrict(y,m,d);}catch(e){return computeHonmeishukuApprox(y,m,d);}})();
  document.getElementById("shukuLine").innerHTML='<div class="tag">'+shukuyoLineHTML(shuku)+'</div>';

  // ビジネス
  var strong=ord[0], weak=ord[4];
  var bizMap={"木":"教育/育成/企画","火":"広報/販売/エンタメ","土":"管理/総務/品質","金":"法務/財務/審査/デザイン","水":"IT/情報/研究/伝達"};
  var lpJob={1:"起業/営業/企画/管理",2:"人事/秘書/接客/ケア",3:"デザイン/広報/教育",4:"経理/行政/建築/品質",5:"営業/旅行/マーケ/通訳",6:"医療/福祉/美容/教育",7:"研究/分析/開発/コンサル",8:"管理職/不動産/金融",9:"教育/福祉/企画/広報",11:"アート/表現/カウンセリング",22:"経営/社会事業/建設/仕組み化",33:"教育/ケア/表現/コミュニティ"};
  var roleTip={"木":"企画/育成の役","火":"広報/推進の役","土":"進行/品質の役","金":"監査/整備の役","水":"情報/分析の役"}[strong];
  document.getElementById("business").innerHTML=[
    '五行の強み：<b>'+showFive(strong)+'</b> → '+bizMap[strong],
    '数秘の適職：<b>'+lp+'</b> → '+lpJob[lp],
    'チームでの役割：<b>'+roleTip+'</b>',
    '弱み（育てる）：<b>'+showFive(weak)+'</b> → '+{"木":"朝日×ストレッチ×“ありがとう”の声出し","火":"体を温めて1日1回“想いを言葉に”","土":"小さな締切で“やる日/休む日”を分ける","金":"捨て1・整え5分・情報1ページ整理","水":"3行日記・散歩"}[weak]
  ].map(x=>'<div class="note" style="margin:4px 0">'+x+'</div>').join("");

  // 長所/短所 深掘り（宿曜mix）
  var deepShort={"木":{pro:"面倒見と成長力。人の芽を見つける名人。", con:"優しさが“後回し”に化けること。"},"火":{pro:"想いで人を動かす。応援される星。", con:"熱量過多で相手が疲れること。"},"土":{pro:"安定と継続。信頼の貯金ができる。", con:"慎重がブレーキになり機会損失。"},"金":{pro:"基準を作り、品質を守る才能。", con:"完璧主義でスピードが落ちる。"},"水":{pro:"情報収集・分析・伝達で価値を生む。", con:"考え過ぎて動けなくなる。"}};
  var strengths=[
    '長所：<b>'+showFive(strong)+'</b>の良さ（'+deepShort[strong].pro+'）を前へ出す。',
    '短所：<b>'+showFive(weak)+'</b>が不足 → '+deepShort[weak].con+'　だから“'+({"木":"毎朝5分の学び","火":"声を出す/体を温める","土":"小さな締切を置く","金":"5分片付け/基準決め","水":"3行日記/散歩/対話"}[weak])+'”を習慣化。',
    '合言葉：<b>'+({"木":"育てて伸ばす","火":"伝えて動く","土":"整えて続ける","金":"磨いて絞る","水":"つないで巡らす"}[strong])+'</b>。迷ったらこれに戻る。'
  ];
  if((topTG[0]||"")==="傷官") strengths.push('［注意］批判が強くなりやすい → ダメ出しは“提案”の形で渡す。時間を区切って出す。');
  document.getElementById("strengths").innerHTML=strengths.map(x=>'<div class="note" style="margin:4px 0">'+x+'</div>').join("");

  function shukuTone(name){var soft=["女","井","軫","室","柳"], hot=["房","心","星","張","尾"];return soft.includes(name)?"soft":(hot.includes(name)?"hot":"cool");}
  function lpVoice(v){return {1:"結論先行で背中を押す",2:"安心と同意を重ねる",3:"軽やかに具体例で魅せる",4:"手順化＆地図で示す",5:"選択肢を提示し自由を保障",6:"思いやりと合意形成",7:"理由と静かな確信",8:"目標と責任の明確化",9:"俯瞰と物語で腑に落とす",11:"言葉の温度と余白",22:"ビジョン→現実の橋渡し",33:"包容とセルフケアの両立"}[v]||"自然体";}
  function spearPhrase(shuku, elem, topTG){var base={"木":"育てて伸ばす。","火":"伝えて動く。","土":"整えて続ける。","金":"磨いて絞る。","水":"つないで巡らす。"}[elem]||"自然体で良い。";var tg={"比肩":"私はこうしたい、を素直に。","劫財":"二人で作戦会議を。","食神":"“楽しかった”を言葉で返す。","傷官":"ダメ出しは提案の形に。","偏財":"会う回数＝安心感。","正財":"小さな約束を守り切る。","偏官":"ワンクッション置く。","正官":"礼節は最大の色気。","偏印":"直感に補助線を引く。","印綬":"学びを要約して渡す。"}[topTG]||"";var color={hot:"速く、熱く。",soft:"優しく、丁寧に。",cool:"静かに、明晰に。"}[shukuTone(shuku)];return base+" "+tg+" "+color;}
  function buildStrengthsDeep({strong,weak,topTG,shuku}){
    var pro={"木":"芽を見つけ育てる才能。","火":"周りを温め動かす力。","土":"仕組みと継続。","金":"基準づくりと磨き上げ。","水":"情報を集め言葉にする。"}[strong];
    var con={"木":"後回し癖。","火":"熱すぎ注意。","土":"慎重すぎ注意。","金":"完璧主義。","水":"考え過ぎ。"}[weak];
    var hack={"木":"朝日3分＋新しい本要約＋“ありがとう”。","火":"体を温めて短文発信。","土":"締切を小分け。","金":"捨て1/整え5分/基準1。","水":"3行日記＋散歩＋要約1P。"}[weak];
    var shHint={"hot":"勢いに“間”を足す。","soft":"やさしさに“境界線”。","cool":"正確さに“温度”。"}[shukuTone(shuku)];
    return ['<p class="note">【長所】'+pro+'前へ出す。</p>','<p class="note">【短所】'+con+' → 対策：'+hack+'</p>','<p class="note">【宿曜の差し味】'+shHint+'</p>'].join("");
  }
  document.getElementById("strengths").innerHTML+=buildStrengthsDeep({strong:strong,weak:weak,topTG:(topTG[0]||""),shuku:shuku});

  // 恋愛ロング（宿曜ミックス・短文化）
  function buildLoveDeep({lp,dayElem,topTG,db,shuku}){
    var axis={"木":"育てる恋。小さな会話を重ねる。","火":"温度の恋。短い言葉＋行動。","土":"設計の恋。ルールを先に決める。","金":"ていねいな恋。基準を共有。","水":"対話の恋。言語化で誤解なし。"}[dayElem]||"自然体の恋。";
    var routine={"木":"週1の“ふたり会議”で次の一歩を決める。","火":"デート後に“良かった所”を一言で送る。","土":"連絡頻度とお金ルールを早めに共有。","金":"ルールは2つだけ決めて守る。","水":"散歩しながら話す。要約を一言添える。"}[dayElem];
    var talk='話し方は「'+talkPatternByElem(dayElem)+'」。';
    var spear=(function(elem,tg){var base={"木":"育てて伸ばす。","火":"伝えて動く。","土":"整えて続ける。","金":"磨いて絞る。","水":"つないで巡らす。"}[elem]||"自然体でOK。";var tgline={"比肩":"“私はこうしたい”を素直に。","劫財":"一緒に作戦会議。","食神":"“楽しかった”を言葉で。","傷官":"指摘は提案の形で。","偏財":"会う回数＝安心。","正財":"小さな約束を守る。","偏官":"ワンクッション置く。","正官":"礼節が最大の色気。","偏印":"直感に補助線。","印綬":"学びを要約で渡す。"}[tg]||"";return base+' '+tgline;})(dayElem,topTG);
    var peach=PEACH_BY_DAY[db]?'桃花（出会いの風）：「'+PEACH_BY_DAY[db]+'」':'';
    return ['<p class="note">【恋の軸】'+axis+'</p>','<p class="note">【今日からやること】'+routine+' '+talk+'</p>',(peach?'<p class="note">【出会いの合図】'+peach+' に出会いが増える。</p>':''),'<p class="note">【合言葉】'+spear+'</p>'].join("");
  }
  document.getElementById("loveView").innerHTML+=buildLoveDeep({lp:lp,dayElem:SE[ds],topTG:(topTG[0]||""),db:db,shuku:shuku});

  // 深掘りテーマ
  var theme=({"木":"人を育てる先生タイプ","火":"周りを明るくする太陽タイプ","土":"土台を作る職人タイプ","金":"整えて美しくする審美タイプ","水":"情報をつなぐナビタイプ"}[strong]);
  var deep='人生のテーマ：<b>'+theme+'</b>。今期は「'+({"比肩":"自分で決めて進む","劫財":"仲間と協力する","食神":"楽しく表現する","傷官":"質を高める","偏財":"外へ出てご縁を広げる","正財":"信用を積む","偏官":"小さく挑戦する","正官":"役割を明確にする","偏印":"ひらめきを試す","印綬":"学びを形にする"}[topTG[0]]||"流れに乗る")+'」が鍵。';
  document.getElementById("deepRead").innerHTML=deep;

  // 転職/引越し/結婚（ロング：やさしい）
  function buildJobAdvice({lp,yearGanzhiElem,monthElem,shuku}){
    var lane={"木":"企画・教育・成長産業","火":"広報・販売・エンタメ","土":"管理・品質・会計・不動産","金":"法務・監査・金融・デザイン","水":"IT・分析・研究・編集"}[yearGanzhiElem]||"現職の延長線";
    var style=lpVoice(lp);
    var sline=spearPhrase(shuku,monthElem,"正官");
    return ['<p class="note">【狙うレーン】'+lane+'（面接の話法：<b>'+style+'</b>）</p>',
            '<p class="note">【職務要約】数字→役割→学び→再現性の順で1分。</p>',
            '<p class="note">【最短突破】紹介経由＋一次は結論先＋実例3。</p>',
            '<p class="note">【宿曜の差し味】面接の一言：'+sline+'</p>'].join("");
  }
  function buildMoveAdvice({lp,dayElem,shuku}){
    var town={"木":"図書館・公園近く","火":"駅近・明るい街","土":"静かで治安◎","金":"整った管理/ゴミ出し楽","水":"カフェ/川沿い/歩ける導線"}[dayElem]||"暮らしやすさ優先";
    var rule={"木":"朝日が入る/観葉植物が育つ","火":"照明◎/南向き/音出しOK","土":"遮音◎/収納多め","金":"掃除しやすい/段差少ない","水":"スーパー/カフェ徒歩5分"}[dayElem];
    var sline=spearPhrase(shuku,dayElem,"正財");
    return ['<p class="note">【街の相性】'+town+'</p>',
            '<p class="note">【部屋の条件】'+rule+'</p>',
            '<p class="note">【内見のコツ】朝/夕の騒音チェック→ネット速度→ゴミ出し導線。</p>',
            '<p class="note">【宿曜の差し味】決め言葉：'+sline+'</p>'].join("");
  }
  function buildMarryAdvice({lp,dayElem,shuku,peachBranch}){
    var base={"木":"育て合う結婚。小さな会話を毎日。","火":"温度の結婚。感謝は短く早く。","土":"設計の結婚。家計と家事をルール化。","金":"ていねいな結婚。礼儀と清潔感を大事に。","水":"対話の結婚。週1のふたり会議。"}[dayElem]||"自然体の結婚。";
    var style=lpVoice(lp);
    var meet=peachBranch?('桃花の月（'+peachBranch+'）はご縁が増える。'):'';
    var sline=spearPhrase(shuku,dayElem,"正財");
    return ['<p class="note">【基本方針】'+base+'</p>',
            '<p class="note">【話し合いの型】'+talkPatternByElem(dayElem)+'（伝え方の声色：<b>'+style+'</b>）</p>',
            '<p class="note">【実務】貯金ルール/家事分担/連絡頻度を紙にする。</p>',
            (meet?'<p class="note">【出会い強化】'+meet+'</p>':''),
            '<p class="note">【宿曜の差し味】約束の言葉：'+sline+'</p>'].join("");
  }
  document.getElementById("jobAdvice").innerHTML=buildJobAdvice({lp:lp,yearGanzhiElem:SE[ys],monthElem:SE[ms],shuku:shuku});
  document.getElementById("moveAdvice").innerHTML=buildMoveAdvice({lp:lp,dayElem:SE[ds],shuku:shuku});
  document.getElementById("marryAdvice").innerHTML=buildMarryAdvice({lp:lp,dayElem:SE[ds],shuku:shuku,peachBranch:PEACH_BY_DAY[db]||""});

  // ===== 相性ボタン =====
  document.getElementById("compatBtn").onclick=function(){
    var y2=+document.getElementById("py2").value, m2=+document.getElementById("pm2").value, d2=+document.getElementById("pd2").value;
    var hm2=document.getElementById("phm2").value||"12:00", t2=parseHM(hm2), hh2=t2[0];
    if(!(y2>0&&m2>=1&&m2<=12&&d2>=1&&d2<=31)){document.getElementById("compatOut").innerHTML="<div class='err' style='display:block'>相手の生年月日を正しく入れてね</div>"; return;}

    var dp2=dayP(y2,m2,d2), ds2=dp2[0], db2=dp2[1];
    var hb2=hourB(hh2), hs2=hourS(ds2,hb2);

    function gScore(a,b){var s=50,ea=SE[a],eb=SE[b]; if(GEN[ea]===eb)s+=12; if(GEN[eb]===ea)s+=12; if(CTL[ea]===eb)s-=14; if(CTL[eb]===ea)s-=14; if(SY[a]===SY[b])s+=6; else s-=4;return Math.max(0,Math.min(100,s));}
    var H={ "六合":HEX, "冲":CHONG, "害":[["子","未"],["丑","午"],["寅","巳"],["卯","辰"],["申","亥"],["酉","戌"]] };
    function zScore(a,b){var s=50; if(inPairs(H["六合"],a,b))s+=20; if(inPairs(H["冲"],a,b))s-=18; if(inPairs(H["害"],a,b))s-=8; return Math.max(0,Math.min(100,s));}
    var siJuScore=Math.round(gScore(ds,ds2)*0.6 + zScore(db,db2)*0.4);

    var lp1=lifePath(y,m,d), lp2=lifePath(y2,m2,d2);
    var NCbase={1:{1:70,2:78,3:85,4:76,5:82,6:74,7:80,8:88,9:75,11:86,22:84,33:80},2:{1:78,2:72,3:77,4:82,5:74,6:86,7:80,8:70,9:83,11:85,22:76,33:84},3:{1:85,2:77,3:75,4:72,5:88,6:80,7:78,8:79,9:84,11:86,22:78,33:90},4:{1:76,2:82,3:72,4:74,5:70,6:80,7:85,8:86,9:73,11:78,22:88,33:76},5:{1:82,2:74,3:88,4:70,5:76,6:73,7:80,8:78,9:84,11:86,22:80,33:82},6:{1:74,2:86,3:80,4:80,5:73,6:78,7:76,8:82,9:88,11:84,22:80,33:86},7:{1:80,2:80,3:78,4:85,5:80,6:76,7:74,8:82,9:79,11:88,22:84,33:78},8:{1:88,2:70,3:79,4:86,5:78,6:82,7:82,8:76,9:80,11:84,22:90,33:80},9:{1:75,2:83,3:84,4:73,5:84,6:88,7:79,8:80,9:76,11:86,22:82,33:88},11:{1:86,2:85,3:86,4:78,5:86,6:84,7:88,8:84,9:86,11:82,22:86,33:90},22:{1:84,2:76,3:78,4:88,5:80,6:80,7:84,8:90,9:82,11:86,22:84,33:86},33:{1:80,2:84,3:90,4:76,5:82,6:86,7:78,8:80,9:88,11:90,22:86,33:84}};
    var numScore=(NCbase[lp1]&&NCbase[lp1][lp2])||75;

    // 宿曜
    var shuku1=(function(){try{return computeHonmeishukuStrict(y,m,d);}catch(e){return computeHonmeishukuApprox(y,m,d);}})();
    var shuku2=(function(){try{return computeHonmeishukuStrict(y2,m2,d2);}catch(e){return computeHonmeishukuApprox(y2,m2,d2);}})();
    var pair=shukuyoPairType(shuku1,shuku2);
    var shy=shukuyoCompatApprox(shuku1,shuku2);

    // 合成スコア
    var loveScore=Math.round(siJuScore*0.5 + numScore*0.3 + shy.score*0.2);
    var friendScore=Math.round(siJuScore*0.45 + numScore*0.4 + shy.score*0.15);
    var roleBoost=0; if(GEN[SE[ds]]===SE[ds2]) roleBoost+=4; if(CTL[SE[ds]]===SE[ds2]) roleBoost+=3;
    var bizScore=Math.max(0,Math.min(100, Math.round(siJuScore*0.5 + numScore*0.35 + shy.score*0.15 + roleBoost)));

    function face(s){return s>=86?"◎":(s>=80?"◯":(s>=74?"△":"▲"));}

    // アドバイス（+50%増量）
    function loveAdvice(s){
      var a=[], pat = talkPatternByElem(SE[ds]);
      a.push('話し方は「'+pat+'」。');
      if(inPairs(HEX, db, db2))a.push("六合：会う回数で絆UP。");
      if(inPairs(CHONG, db, db2))a.push("冲：先に“共通の目的”を決めてから話す。");
      a.push("やること①：デート後に“良かった所”を一言で送る。");
      a.push("やること②：連絡の頻度を決める（例：平日1回・休日2回）。");
      a.push("やること③：次いつ会うかをその場で決める。");
      a.push("定番：『"+({"木":"散歩/読書","火":"ライブ/外食","土":"家ごはん/整える日","金":"美術館/静かな店","水":"カフェで長話"}[SE[ds]])+"』が相性◎。");
      if(s<75)a.push("注意：長引く議論は休憩を挟む。タイマー15分で切り替え。");
      return a.join(" ");
    }
    function friendAdvice(s){
      var a=[], pat = talkPatternByElem(SE[ds]);
      a.push('やり取りは「'+pat+'」。');
      a.push("共有物を1つ作る（アルバム/ToDo/地図）。");
      a.push("頻度を決める：週1または隔週の固定連絡。");
      a.push((CTL[SE[ds]]===SE[ds2]||CTL[SE[ds2]]===SE[ds])?
            "担当分け（企画・まとめ・連絡）で摩擦を回避。":
            "共通の趣味時間をカレンダーで固定。");
      a.push("褒め→要望→お礼の順で伝える。");
      if(s<75)a.push("作戦：短い時間で会う（30〜45分）→成功体験を重ねる。");
      return a.join(" ");
    }
    function bizAdvice(s){
      var a=[], pat = talkPatternByElem(SE[ds]);
      a.push('会議冒頭で「決める人→順番→期限」を宣言。');
      a.push('説明は「'+pat+'」で1分以内に。');
      a.push("役割：あなた＝"+({"木":"企画/育成","火":"推進/広報","土":"進行/品質","金":"監査/整備","水":"情報/分析"}[SE[ds]])+"／相手はそれを補うポジションに。");
      a.push("資料は1枚要約＋詳細リンク。");
      a.push("タスクはクラウドToDoで透明化。期限は日付で書く。");
      if(s<80)a.push("衝突時：相手の要点を一度“要約→確認”してから提案。");
      return a.join(" ");
    }

    // 相性ロング
    function buildCompatLong({ds, db, lp1, ds2, db2, lp2, shuku1, shuku2, sComp, siJuScore, numScore}){
      var tempo = (SE[ds]===SE[ds2])?"心のテンポが近い。疲れにくい。":"テンポは違う。相手の間合いを尊重すれば強い.";
      var yin = (SY[ds]===SY[ds2])?"価値観が似て安心が早い。":"価値観の違いが武器。";
      var pair = shukuyoPairType(shuku1, shuku2);
      var talk1 = '話し方：「'+ talkPatternByElem(SE[ds]) +'」';
      var talk2 = '相手には「'+ talkPatternByElem(SE[ds2]) +'」で返すと伝わる。';
      return [
        '<div class="hr"></div>',
        '<div class="small">【総評】四柱:'+siJuScore+'/100／数秘:'+numScore+'/100。'+tempo+' '+yin+' '+talk1+'／'+talk2+'</div>',
        '<p class="note">【恋愛アドバイス】やること：①“良かった所”を一言で送る ②連絡頻度を決める ③次に会う日をその場で決定。NG：寝る前の長文バトル。短く区切る。</p>',
        '<p class="note">【友情アドバイス】共有アルバムやToDoで“見える化”。会う時間は短めでも“固定化”が効く。褒め→要望→お礼で摩擦が減る。</p>',
        '<p class="note">【ビジネスアドバイス】会議冒頭に“決める人→順→期限”。要約1枚＋詳細リンク。タスクは期限を日付で書く。衝突時は要約→確認→提案。</p>',
        '<p class="note">【宿曜タイプ】<b>'+pair.type+'</b>：'+pair.brief+'／実践：'+pair.advice+'</p>'
      ].join("");
    }

    var html='';
    html+='<div class="kv"><div class="chip">あなた：<b>'+ds+db+'</b> / 運命数<b>'+lp1+'</b> / 宿曜<b>'+shuku1+'</b></div><div class="chip">相手：<b>'+ds2+db2+'</b> / 運命数<b>'+lp2+'</b> / 宿曜<b>'+shuku2+'</b></div></div><div class="hr"></div>';
    html+='<div><b>四柱の相性</b>：'+siJuScore+'/100　<b>数秘の相性</b>：'+numScore+'/100　<b>宿曜</b>：'+shy.label+'（'+shy.type+'）</div><div class="hr"></div>';
    html+='<div><b>総合（恋愛）</b>：'+loveScore+'/100 '+face(loveScore)+'<br><span class="small">'+loveAdvice(loveScore)+'</span></div>';
    html+='<div style="margin-top:6px"><b>総合（友情）</b>：'+friendScore+'/100 '+face(friendScore)+'<br><span class="small">'+friendAdvice(friendScore)+'</span></div>';
    html+='<div style="margin-top:6px"><b>総合（ビジネス）</b>：'+bizScore+'/100 '+face(bizScore)+'<br><span class="small">'+bizAdvice(bizScore)+'</span></div>';
    html+= buildCompatLong({ds, db, lp1, ds2, db2, lp2, shuku1, shuku2, sComp:shy, siJuScore, numScore});
    document.getElementById("compatOut").innerHTML=html;
  };

  // ====== 時期判定（これから3年：36か月） ======
  function bestNumMonths(kind){var sets={love:[2,3,6], meet:[3,5], job:[1,5,8], ind:[1,8]}; return sets[kind||'love']||[2,3,6];}
  var meE=SE[ds], wealthE=CTL[meE];
  var controlsMeE=(function(){for(var k in CTL){if(CTL[k]===meE)return k;}return null;})();
  function monthBranch(y,m,d){ return monthP(y,m,d,yearP(y,m,d)[0])[1]; }

  var today=new Date(), startY=today.getFullYear(), startM=today.getMonth()+1;
  var cells=[], marryMonths=[];
  for(var i=0;i<36;i++){
    var Y=startY+Math.floor((startM-1+i)/12);
    var M=((startM-1+i)%12)+1;

    var br=monthBranch(Y,M,15), brE=BR_E[br];
    var curPY=personalYear(m,d,Y), pm=personalMonth(curPY,M);

    var numLove=bestNumMonths('love').indexOf(pm)>=0;
    var numMeet=bestNumMonths('meet').indexOf(pm)>=0;
    var numJob =bestNumMonths('job').indexOf(pm)>=0;
    var numInd =bestNumMonths('ind').indexOf(pm)>=0;

    var siMeet = (br===PEACH_BY_DAY[db]);    // 出会い（桃花）
    var siLove = (brE===wealthE) || siMeet;  // 恋愛/結婚：財or桃花
    var siJob  = (brE===controlsMeE);        // 転職：官
    var siInd  = (brE===wealthE) || (SE[ms]===meE); // 独立：財 or 自分強化

    function cls(b1,b2){return b1&&b2?"hitBoth":(b1?"hitNum":(b2?"hitSi":""));}

    var marryHit = ( (numLove && siLove) || (siLove && siMeet) || (numLove && siMeet) );

    var divCls=cls((numLove||numMeet||numJob||numInd),(siLove||siJob||siInd)) + (marryHit?' marry':'');
    var label=Y+"年"+M+"月（"+br+"）";
    var detail=[];
    if(numLove||siLove) detail.push("恋愛◎");
    if(numMeet||siMeet) detail.push("出会い◎");
    if(numJob ||siJob ) detail.push("転職◎");
    if(numInd ||siInd ) detail.push("独立◎");
    if(marryHit) { detail.push("💍結婚◎"); marryMonths.push(label); }
    if(detail.length===0) detail.push("様子見");

    cells.push('<div class="km '+divCls+'"><b>'+label+'</b>'+detail.join("・")+'</div>');
  }
  document.getElementById("timing").innerHTML=cells.join('');
  document.getElementById("timingLegend").innerHTML="※ “恋/結婚”は数秘（2/3/6）＋四柱の財の月/桃花月、“転職”は数秘（1/5/8）＋四柱の官の月、“独立”は数秘（1/8）＋四柱の財/自分強化で判定。色はW◎/数秘◎/四柱◎。";
  document.getElementById("marryList").innerHTML = (marryMonths.length? "💍 <b>結婚に良い月：</b> "+marryMonths.join("、") : "💍 結婚は焦らず、準備の年。");
}

// 初期化
function init(){ document.getElementById("run").addEventListener("click",run); document.getElementById("compatBtn").addEventListener("click",function(){}); run(); }
document.addEventListener("DOMContentLoaded",init);
</script>
</body></html>
