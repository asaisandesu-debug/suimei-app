<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>四柱推命＋数秘術 Pro（やさしい解説・相性＆具体月）</title>
<style>
:root{--bg:#0b0c10;--card:#151821;--ink:#f5f7ff;--sub:#b6c0d6;--acc:#7ee1b5;--line:#23283a;--warn:#ffb74d;--good:#66bb6a;--bad:#ef5350}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",Roboto,Arial}
header{padding:14px 14px 8px;background:linear-gradient(180deg,rgba(0,0,0,.55),transparent)}
h1{margin:0;font-size:18px}small{color:var(--sub)}main{padding:12px 12px 96px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
.row{display:flex;gap:8px;flex-wrap:wrap}.col{flex:1 1 140px;min-width:130px}
label{display:block;font-size:12px;color:var(--sub);margin:4px 0 6px}
input,select,button{font-size:16px}input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0e111a;color:var(--ink)}
.btn{width:100%;padding:12px;border:none;border-radius:12px;font-weight:700;background:var(--acc);color:#0a0a0a}
.kv{display:flex;gap:8px;flex-wrap:wrap}.chip{background:#0e111a;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:13px}
.note{font-size:12px;color:var(--sub)}table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}th{white-space:nowrap;color:#cfe0ff;text-align:left}
.bars{display:flex;gap:8px;align-items:flex-end;height:150px;border-bottom:1px dashed var(--line);padding:6px 2px}
.bar{flex:1;min-width:40px;border-radius:8px 8px 0 0;background:linear-gradient(180deg,#67e8f9,#22d3ee)}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
.err{display:none;background:#331a1a;color:#ffc9c9;border:1px solid #5b2a2a;padding:8px;border-radius:8px;margin-top:6px;font-size:13px}
.tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;margin:2px;color:#e0f2f1}
.good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.section-title{margin:0 0 6px}
.help{font-size:13px;color:#b6c0d6;margin-top:6px;line-height:1.6}
.hr{height:1px;background:var(--line);margin:8px 0}
</style></head>
<body>
<header>
  <h1>四柱推命＋数秘術 Pro（やさしい解説・相性＆具体月）</h1>
  <small>生年月日＋出生時間 → 命式・通変星・蔵干・五行・相性・進路アドバイス・数秘術（相性/具体月）</small>
</header>

<main>
  <!-- 入力 -->
  <div class="card">
    <div class="row">
      <div class="col"><label>年(西暦)</label><input id="y" type="number" value="1990"></div>
      <div class="col"><label>月</label><input id="m" type="number" min="1" max="12" value="1"></div>
      <div class="col"><label>日</label><input id="d" type="number" min="1" max="31" value="1"></div>
      <div class="col"><label>出生時刻（24h, 例 14:35）</label><input id="hm" value="12:00"></div>
    </div>
    <div class="row">
      <div class="col"><label>蔵干を五行に含める</label><select id="zOpt"><option value="on">含める</option><option value="off">含めない</option></select></div>
      <div class="col"><label>蔵干ウェイト</label><select id="zW"><option value="eq">等分</option><option value="pri">主0.6/次0.25/末0.15</option></select></div>
      <div class="col"><label>節入り（月柱）</label><select id="setu"><option value="auto">自動（平均節入り・±1日）</option><option value="manual">手動で節月を指定</option></select></div>
      <div class="col" id="manualCol" style="display:none"><label>節月（手動）</label><select id="manualMonth"></select></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><button class="btn" id="run">鑑定する</button></div>
    </div>
    <div id="err" class="err">日付を正しく入れてね</div>
    <div class="help">用語ミニ解説：<b>通変星</b>＝性格タイプ、<b>蔵干</b>＝本音、<b>五行</b>＝木火土金水のバランス（多い＝得意／少ない＝意識で補う）。</div>
  </div>

  <!-- 命式 -->
  <div class="card">
    <h3 class="section-title">◆ 命式（四柱）＋やさしい読み方</h3>
    <div class="help">四本の柱で性格の土台。<b>年柱</b>＝育ち/ご先祖、<b>月柱</b>＝社会/仕事の顔、<b>日柱</b>＝あなたの核（最重要）、<b>時柱</b>＝思考・将来像。</div>
    <div id="ms" class="kv" style="margin-top:6px"></div>
    <div id="tbl" style="margin-top:8px"></div>
  </div>

  <!-- 五行 -->
  <div class="card">
    <h3 class="section-title">◆ 五行バランス（木火土金水）</h3>
    <div class="help">多い＝出しやすい良さ。少ない＝伸びしろ。偏りは“悪”ではなく「使い方」。</div>
    <div id="bars" class="bars"></div>
    <div id="fftags" style="margin-top:6px"></div>
  </div>

  <!-- 相性（干支クイック） -->
  <div class="card">
    <h3 class="section-title">◆ 相性（干支クイック）</h3>
    <div class="help">十干（外向きの相性）＋十二支（ご縁/巡り）の簡易スコア。</div>
    <div class="row">
      <div class="col"><label>相手の十干</label><select id="cxg"></select></div>
      <div class="col"><label>相手の十二支</label><select id="cxz"></select></div>
    </div>
    <div id="cxout" style="margin-top:6px"></div>
  </div>

  <!-- 要約（長文・やさしい） -->
  <div class="card">
    <h3 class="section-title">◆ プロ用要約（やさしい言葉・長文）</h3>
    <div id="sum" class="help"></div>
  </div>

  <!-- 進路アドバイス（近い年順＋具体“月”） -->
  <div class="card">
    <h3 class="section-title">◆ 進路アドバイス（近い年順＋おすすめ“月”）</h3>
    <div class="help">「結婚に追い風の年」「転職/独立に向く年」を<b>今年に近い順</b>で表示。各年の中で<b>おすすめ“月”</b>（数秘の個人月＋節入り）も出します。◎＝強め、○＝まずまず。</div>
    <div id="advice"></div>
  </div>

  <!-- 数秘術（プロフィール＋相性） -->
  <div class="card">
    <h3 class="section-title">◆ 数秘術（プロフィール）</h3>
    <div class="help">生年月日から「運命数（ライフパス）＝人生の方向」「誕生数＝得意分野」「個人年＝今年の流れ」を読みます。人物像・向く仕事・恋愛傾向も“やさしく”表示。</div>
    <div id="num" style="margin-top:6px"></div>
    <div class="hr"></div>
    <h3 class="section-title">◆ 数秘 相性（生年月日で判定）</h3>
    <div class="help">相手の生年月日を入れて、運命数どうしの相性を判定。コメントもわかりやすく表示。</div>
    <div class="row">
      <div class="col"><label>相手の年</label><input id="py2" type="number" value="1995"></div>
      <div class="col"><label>相手の月</label><input id="pm2" type="number" min="1" max="12" value="8"></div>
      <div class="col"><label>相手の日</label><input id="pd2" type="number" min="1" max="31" value="15"></div>
      <div class="col"><label>　</label><button class="btn" id="matchBtn">相性チェック</button></div>
    </div>
    <div id="ncompat" style="margin-top:6px"></div>
  </div>
</main>

<script>
// ====== 四柱データ ======
var S=["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"], SE={"甲":"木","乙":"木","丙":"火","丁":"火","戊":"土","己":"土","庚":"金","辛":"金","壬":"水","癸":"水"}, SY={"甲":"陽","乙":"陰","丙":"陽","丁":"陰","戊":"陽","己":"陰","庚":"陽","辛":"陰","壬":"陽","癸":"陰"};
var B=["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"], MB=["寅","卯","辰","巳","午","未","申","酉","戌","亥","子","丑"];
var ZM={"子":["壬"],"丑":["己","癸","辛"],"寅":["甲","丙","戊"],"卯":["乙"],"辰":["戊","乙","癸"],"巳":["丙","戊","庚"],"午":["丁","己"],"未":["己","丁","乙"],"申":["庚","壬","戊"],"酉":["辛"],"戌":["戊","辛","丁"],"亥":["壬","甲"]};
var E=["木","火","土","金","水"], GEN={"木":"火","火":"土","土":"金","金":"水","水":"木"}, CTL={"木":"土","土":"水","水":"火","火":"金","金":"木"};
var meanSetu=[{m:2,d:4},{m:3,d:6},{m:4,d:5},{m:5,d:6},{m:6,d:6},{m:7,d:7},{m:8,d:7},{m:9,d:7},{m:10,d:8},{m:11,d:7},{m:12,d:7},{m:1,d:6}];
var TGtxt={"比肩":"自立・主張","劫財":"突破・横連携","食神":"表現・回復","傷官":"創作・批評","偏財":"機動・縁","正財":"堅実・信頼","偏官":"挑戦・統率","正官":"役割・評価","偏印":"ひらめき","印綬":"学習・理解"};
var HEX=[["子","丑"],["寅","亥"],["卯","戌"],["辰","酉"],["巳","申"],["午","未"]], CHONG=[["子","午"],["丑","未"],["寅","申"],["卯","酉"],["辰","戌"],["巳","亥"]];
var PEACH_BY_DAY={"寅":"卯","午":"卯","戌":"卯","申":"酉","子":"酉","辰":"酉","亥":"子","卯":"子","未":"子","巳":"午","酉":"午","丑":"午"};

// ====== ユーティリティ（四柱） ======
function parseHM(s){var m=/^(\d{1,2}):(\d{2})$/.exec(s||"");if(!m)return[12,0];var h=+m[1],mm=+m[2];return[Math.min(23,Math.max(0,h)),Math.min(59,Math.max(0,mm))];}
function JDN(y,m,d){var a=Math.floor((14-m)/12),y2=y+4800-a,m2=m+12*a-3;return d+Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045;}
function sexIdx(j){var base=JDN(1984,2,2);var diff=j-base;var r=diff%60;if(r<0)r+=60;return r;}
function dayP(y,m,d){var idx=sexIdx(JDN(y,m,d));return [S[idx%10], B[idx%12]];}
function yearP(y,m,d){var before=(m<2)||(m==2&&d<4),jy=before?y-1:y;var yi=((jy-1984)%60+60)%60;return [S[yi%10],B[yi%12]];}
function monthP(y,m,d,ys){function afterSetu(y,m,d){var arr=[],i;for(i=0;i<12;i++){var t=meanSetu[i],yy=y,mm=t.m;if(mm==1)yy=y+1;arr.push({y:yy,m:mm,d:t.d,idx:i});}var v=y*10000+m*100+d;for(i=0;i<12;i++){var a=arr[i],tv=a.y*10000+a.m*100+a.d;if(v<tv)return (i+11)%12;}return 11;}
  var idx=afterSetu(y,m,d), br=MB[idx], map={"甲":"丙","己":"丙","乙":"戊","庚":"戊","丙":"庚","辛":"庚","丁":"壬","壬":"壬","戊":"甲","癸":"甲"}, st=map[ys], si=S.indexOf(st); return [S[(si+idx)%10], br];}
function hourB(h){if(h>=23||h<1)return"子";var M=["丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];return M[Math.floor((h-1)/2)];}
function hourS(ds,hb){var m={"甲":"甲","己":"甲","乙":"丙","庚":"丙","丙":"戊","辛":"戊","丁":"庚","壬":"庚","戊":"壬","癸":"壬"},base=m[ds],off={"子":0,"丑":1,"寅":2,"卯":3,"辰":4,"巳":5,"午":6,"未":7,"申":8,"酉":9,"戌":10,"亥":11};return S[(S.indexOf(base)+off[hb])%10];}
function tenGod(d,o){var me=SE[d],my=SY[d],oe=SE[o],oy=SY[o]; if(oe===me)return my===oy?"比肩":"劫財"; if(GEN[oe]===me)return my===oy?"偏印":"印綬"; if(GEN[me]===oe)return my===oy?"傷官":"食神"; if(CTL[me]===oe)return my===oy?"偏財":"正財"; if(CTL[oe]===me)return my===oy?"偏官":"正官"; return ""; }
function cnt(stems){var c={"木":0,"火":0,"土":0,"金":0,"水":0}; for(var i=0;i<stems.length;i++){var s=stems[i]; if(SE[s]) c[SE[s]]+=1;} return c;}
function add(dst,src,w){w=w||1; for(var k in dst){dst[k]+= (src[k]||0)*w;}}
function inPairs(list,a,b){for(var i=0;i<list.length;i++){var p=list[i]; if((p[0]==a&&p[1]==b)||(p[0]==b&&p[1]==a)) return true;} return false;}

// ====== 数秘（基礎） ======
function reduceNum(n){n=(""+n).replace(/\D/g,""); var s=0; for(var i=0;i<n.length;i++) s+=(+n[i]); if(s===11||s===22||s===33) return s; while(s>9){var t=0; var str=""+s; for(var j=0;j<str.length;j++) t+=(+str[j]); if(t===11||t===22||t===33){s=t;break;} s=t;} return s;}
function pad(n){return (n<10?"0":"")+n;}
function lifePath(y,m,d){return reduceNum(""+y+pad(m)+pad(d));}
function birthdayNum(d){return (d>=10)?reduceNum(""+d):d;}
function personalYear(m,d,curY){return reduceNum(reduceNum(""+curY)+reduceNum(""+m)+reduceNum(""+d));}
function personalMonth(py, calMonth){return reduceNum(py + calMonth);} // 個人年＋暦月

// 数秘の説明（人物像・適職・恋愛・苦手）
var LPtxt={
  1:{p:"リーダー気質。自分軸で進むと成功。遠慮しすぎず一歩前へ。", job:["起業","営業","企画","マネジメント"], love:"主導権を握りがち。相手の意見を聴くと◎", weak:"頑固・孤立に注意"},
  2:{p:"聞き上手で調整役。チームで力が出る。", job:["秘書・人事","接客","医療/ケア","調整役"], love:"思いやり◎。合わせすぎに注意", weak:"決められない・我慢しすぎ"},
  3:{p:"発想と表現。明るくムードメーカー。", job:["広報","デザイン","エンタメ","教育"], love:"楽しい恋愛◎。飽きやすさに注意", weak:"計画不足・三日坊主"},
  4:{p:"安定と積み上げ。実務・管理に強い。", job:["経理・総務","建築","品質管理","行政"], love:"安心感重視。ペース乱されるのが苦手", weak:"頑固・変化に弱い"},
  5:{p:"変化と自由。動くほど運が開く。", job:["営業/外回り","旅行/観光","IT/マーケ","通訳"], love:"刺激的な恋◎。束縛は苦手", weak:"衝動・飽きっぽさ"},
  6:{p:"面倒見と美意識。人や暮らしを整える。", job:["医療/福祉","美容","フード","教育"], love:"家族的。お世話のしすぎ注意", weak:"完璧主義・抱え込み"},
  7:{p:"探究心と分析。学びが栄養。", job:["研究","分析","IT/開発","コンサル"], love:"一人時間大事。理解者と長続き", weak:"閉じこもり・疑いすぎ"},
  8:{p:"実行と成果。責任ある立場で開花。", job:["管理職","不動産","金融","経営"], love:"頼れるタイプ。強引さに注意", weak:"支配的・休まない"},
  9:{p:"共感とまとめ。人の役に立つと輝く。", job:["教育","医療/福祉","企画","広報"], love:"やさしさ◎。自己犠牲に注意", weak:"優柔不断・完了苦手"},
  11:{p:"直感・ひらめき強。感性の橋渡し。", job:["アート","表現","カウンセリング","スピ×実務"], love:"深い心のつながり重視", weak:"繊細さ・疲れやすい"},
  22:{p:"大きな構想を現実化。器が大きい。", job:["経営","社会事業","建設","仕組み化"], love:"共通の大きな目標で絆UP", weak:"過負荷・現実離れ"},
  33:{p:"愛と奉仕のカリスマ。包む力。", job:["教育","ケア","表現","コミュニティ"], love:"深い包容。自分のケア忘れず", weak:"疲労・境界薄い"}
};
var PYtxt={1:"スタートの年（新規/転職◎）",2:"準備と協力",3:"発信・拡散",4:"基礎固め/資格",5:"変化とチャンス（移動◎）",6:"人間関係・家庭",7:"内省・研究",8:"評価・結果",9:"完了・整理"};

// 数秘の相性（運命数×運命数のベーススコア：体感の良さ）
var NCbase={
  1:{1:70,2:78,3:85,4:76,5:82,6:74,7:80,8:88,9:75,11:86,22:84,33:80},
  2:{1:78,2:72,3:77,4:82,5:74,6:86,7:80,8:70,9:83,11:85,22:76,33:84},
  3:{1:85,2:77,3:75,4:72,5:88,6:80,7:78,8:79,9:84,11:86,22:78,33:90},
  4:{1:76,2:82,3:72,4:74,5:70,6:80,7:85,8:86,9:73,11:78,22:88,33:76},
  5:{1:82,2:74,3:88,4:70,5:76,6:73,7:80,8:78,9:84,11:86,22:80,33:82},
  6:{1:74,2:86,3:80,4:80,5:73,6:78,7:76,8:82,9:88,11:84,22:80,33:86},
  7:{1:80,2:80,3:78,4:85,5:80,6:76,7:74,8:82,9:79,11:88,22:84,33:78},
  8:{1:88,2:70,3:79,4:86,5:78,6:82,7:82,8:76,9:80,11:84,22:90,33:80},
  9:{1:75,2:83,3:84,4:73,5:84,6:88,7:79,8:80,9:76,11:86,22:82,33:88},
  11:{1:86,2:85,3:86,4:78,5:86,6:84,7:88,8:84,9:86,11:82,22:86,33:90},
  22:{1:84,2:76,3:78,4:88,5:80,6:80,7:84,8:90,9:82,11:86,22:84,33:86},
  33:{1:80,2:84,3:90,4:76,5:82,6:86,7:78,8:80,9:88,11:90,22:86,33:84}
};

// ====== 鑑定 ======
function run(){
  // 入力
  var y=+document.getElementById("y").value, m=+document.getElementById("m").value, d=+document.getElementById("d").value;
  var hm=document.getElementById("hm").value, t=parseHM(hm), hh=t[0];
  if(!(y>0&&m>=1&&m<=12&&d>=1&&d<=31)){var e=document.getElementById("err");e.style.display="block";return;}
  document.getElementById("err").style.display="none";

  // 柱
  var dp=dayP(y,m,d), ds=dp[0], db=dp[1];
  var yp=yearP(y,m,d), ys=yp[0], yb=yp[1];
  var mp=(document.getElementById("setu").value==="manual")
        ? (function(){var br=document.getElementById("manualMonth").value; var map={"甲":"丙","己":"丙","乙":"戊","庚":"戊","丙":"庚","辛":"庚","丁":"壬","壬":"壬","戊":"甲","癸":"甲"}, st=map[ys], si=S.indexOf(st), idx=MB.indexOf(br); return [S[(si+idx)%10], br];})()
        : monthP(y,m,d,ys);
  var ms=mp[0], mb=mp[1];
  var hb=hourB(hh), hs=hourS(ds,hb);

  // 命式表示
  document.getElementById("ms").innerHTML=[
    '年：<b>'+ys+yb+'</b>（育ち/家系の風）',
    '月：<b>'+ms+mb+'</b>（社会/仕事の顔）',
    '日：<b>'+ds+db+'</b>（本人の核）',
    '時：<b>'+hs+hb+'</b>（思考・将来像）'
  ].map(x=>'<div class="chip">'+x+'</div>').join('');
  var rows=[["年柱",ys,yb,"ご先祖・育ち/ルーツ"],["月柱",ms,mb,"外から見える顔・仕事傾向"],["日柱",ds,db,"性格の中心。<b>ここ最重視</b>"],["時柱",hs,hb,"思考/学び・家庭/将来像"]].map(function(p){
    var tg=tenGod(ds,p[1]);
    return '<tr><th>'+p[0]+'</th><td>'+p[1]+'</td><td>'+p[2]+'</td><td>'+tg+'</td><td>'+(TGtxt[tg]||"")+'</td><td class="note">'+p[3]+'</td></tr>';
  }).join('');
  document.getElementById("tbl").innerHTML='<table><thead><tr><th>柱</th><th>天干</th><th>地支</th><th>通変星</th><th>性格ヒント</th><th>読み方</th></tr></thead><tbody>'+rows+'</tbody></table>';

  // 五行（蔵干込み可）
  function zWeights(z){var l=ZM[z]||[]; if(l.length==1)return[1]; if(document.getElementById("zW").value==="eq"){return l.map(()=>1/l.length);} return l.length==2?[0.65,0.35]:[0.6,0.25,0.15].slice(0,l.length);}
  var vis=cnt([ys,ms,ds,hs]), zc={"木":0,"火":0,"土":0,"金":0,"水":0}, pillars=[[ys,yb],[ms,mb],[ds,db],[hs,hb]];
  for(var i=0;i<pillars.length;i++){var zlist=ZM[pillars[i][1]]||[], w=zWeights(pillars[i][1]); for(var j=0;j<zlist.length;j++){add(zc,cnt([zlist[j]]), w[j]||0);}}
  var useZ=document.getElementById("zOpt").value==="on", total={}; E.forEach(e=>total[e]=(vis[e]||0)+(useZ?zc[e]||0:0));
  var mx=Math.max.apply(null,E.map(e=>total[e])), bars=E.map(function(e){var h=mx?Math.round(total[e]/mx*140)+6:6;return '<div style="flex:1;text-align:center"><div class="bar" style="height:'+h+'px"></div><div style="font-size:12px;color:#b6c0d6;padding-top:6px">'+e+' '+(total[e]||0).toFixed(2)+'</div></div>';}).join('');
  document.getElementById("bars").innerHTML=bars; var ord=E.slice().sort((a,b)=>total[b]-total[a]);
  document.getElementById("fftags").innerHTML='<span class="badge">強：'+ord[0]+'</span><span class="badge">弱：'+ord[4]+'</span><span class="badge">偏り＝悪ではない（出し方）</span>';

  // 相性（干支）
  function gScore(a,b){var s=50,ea=SE[a],eb=SE[b]; if(GEN[ea]===eb)s+=12; if(GEN[eb]===ea)s+=12; if(CTL[ea]===eb)s-=14; if(CTL[eb]===ea)s-=14; if(SY[a]===SY[b])s+=6; else s-=4;return Math.max(0,Math.min(100,s));}
  var H={ "六合":HEX, "冲":CHONG, "害":[["子","未"],["丑","午"],["寅","巳"],["卯","辰"],["申","亥"],["酉","戌"]] };
  function zScore(a,b){var s=50; if(inPairs(H["六合"],a,b))s+=20; if(inPairs(H["冲"],a,b))s-=18; if(inPairs(H["害"],a,b))s-=8; return Math.max(0,Math.min(100,s));}
  document.getElementById("cxg").innerHTML=S.map(x=>'<option>'+x+'</option>').join('');
  document.getElementById("cxz").innerHTML=B.map(x=>'<option>'+x+'</option>').join('');
  var cg=document.getElementById("cxg").value||ys, cz=document.getElementById("cxz").value||yb;
  var GS=gScore(ds,cg), ZS=zScore(db,cz), TS=Math.round(GS*0.55+ZS*0.45);
  document.getElementById("cxout").innerHTML='あなた：'+ds+db+' ／ 相手：'+cg+cz+' → 総合 <b>'+TS+'/100</b>（十干:'+GS+'／十二支:'+ZS+'）';

  // 要約（長文・やさしい）
  var tgAll={}, pillarsGan=[ys,ms,hs]; pillarsGan.forEach(g=>{var t=tenGod(ds,g); if(t) tgAll[t]=(tgAll[t]||0)+1;}); (ZM[db]||[]).forEach(zg=>{var t=tenGod(ds,zg); if(t) tgAll[t]=(tgAll[t]||0)+1;});
  var topTG=Object.keys(tgAll).sort((a,b)=>(tgAll[b]||0)-(tgAll[a]||0)).slice(0,3);
  var core1=topTG[0]||"", core2=topTG[1]||"", core3=topTG[2]||"";
  var msg=[];
  msg.push("あなたの中心（日柱）は「"+ds+db+"」。ここが性格のコアです。");
  msg.push("通変星では <b>"+[core1,core2,core3].filter(Boolean).join("・")+"</b> が目立ちます。これは「"+(TGtxt[core1]||"自分の芯")+"」を土台に、"+(TGtxt[core2]||"周囲との関わり")+"を伸ばし、"+(TGtxt[core3]||"補助力")+"でバランスを取るタイプという意味。");
  msg.push("五行は <b>強："+ord[0]+"</b>／<b>弱："+ord[4]+"</b>。強い要素は“出し方”を整え、弱い要素は習慣（学び・環境）で補えば、実力がまっすぐ発揮されます。");
  msg.push("実務ヒント：面談では日柱→月柱（仕事の顔）→時柱（将来像）の順に話すと伝わりやすい。");
  document.getElementById("sum").innerHTML=msg.join("<br><br>");

  // 進路アドバイス（年は近い順、各年のおすすめ“月”）
  function marriageScore(ys, yb){var s=0, tg=tenGod(ds,ys); if(tg==="正財"||tg==="偏財"||tg==="正官"||tg==="偏官") s+=2; if(inPairs(HEX, db, yb)) s+=2; if(PEACH_BY_DAY[db]===yb) s+=2; return s;}
  function careerScore(ys, yb){var s=0, tg=tenGod(ds,ys); if(tg==="偏官"||tg==="傷官"||tg==="偏財"||tg==="食神") s+=2; if(inPairs(CHONG, mb, yb)) s+=2; return s;}
  var now=new Date(), marry=[], job=[];
  for(var yx=now.getFullYear(); yx<now.getFullYear()+16; yx++){
    var yp2=yearP(yx,1,1), scM=marriageScore(yp2[0], yp2[1]), scC=careerScore(yp2[0], yp2[1]);
    marry.push({y:yx, s:scM}); job.push({y:yx, s:scC});
  }
  marry.sort((a,b)=>a.y-b.y); job.sort((a,b)=>a.y-b.y);

  // 数秘の個人月：各年の中でおすすめ“月”を抽出
  function bestMonthsForMarriage(y, m, d, year){var py=personalYear(m,d,year), list=[]; for(var mon=1; mon<=12; mon++){var pm=personalMonth(py, mon); if([2,3,6].indexOf(pm)>=0) list.push(mon);} return list;}
  function bestMonthsForCareer(y, m, d, year){var py=personalYear(m,d,year), list=[]; for(var mon=1; mon<=12; mon++){var pm=personalMonth(py, mon); if([1,5,8].indexOf(pm)>=0) list.push(mon);} return list;}

  // 節入り（平均）で“だいたいこの月”の注意文を付与
  function monthLabel(mon){return mon+"月（節入り±1日）";}

  function lineYearsWithMonths(arr,label,isMarriage){
    var out=[];
    for(var i=0;i<arr.length;i++){
      if(arr[i].s>0){
        var months = isMarriage ? bestMonthsForMarriage(y,m,d,arr[i].y) : bestMonthsForCareer(y,m,d,arr[i].y);
        if(months.length){
          var mark=arr[i].s>=4?"◎":(arr[i].s>=2?"○":"");
          out.push('<div class="tag">'+arr[i].y+'年'+(mark?('（'+mark+'）'):'')+'：'+months.slice(0,4).map(monthLabel).join('・')+'</div>');
        }
      }
    }
    if(!out.length) return "<div class='note'>該当年が少ない → ご縁/準備づくりの年に。</div>";
    return out.join('');
  }
  var advHtml = "";
  advHtml += "<div><b>結婚/恋愛に追い風の年（近い順）</b></div>"+lineYearsWithMonths(marry,true,true);
  advHtml += "<div class='note'>根拠：財/官の年＋日支と六合＋桃花の年。数秘では個人月2/3/6がご縁向き。</div>";
  advHtml += "<div style='margin-top:8px'><b>転職/独立に向く年（近い順）</b></div>"+lineYearsWithMonths(job,false,false);
  advHtml += "<div class='note'>根拠：偏官・傷官・偏財・食神など“動く星”＋月支と冲。数秘では個人月1/5/8が動き向き。</div>";
  document.getElementById("advice").innerHTML=advHtml;

  // 数秘プロフィール
  var lp=lifePath(y,m,d), bd=birthdayNum(d), py=personalYear(m,d, now.getFullYear());
  function arrToText(a){return (a||[]).join("・");}
  var N=LPtxt[lp]||{p:"",job:[],love:"",weak:""};
  var nmsg=[];
  nmsg.push("・運命数（ライフパス） <b>"+lp+"</b>： "+N.p);
  nmsg.push("・誕生数（得意分野） <b>"+bd+"</b>： "+((LPtxt[bd]&&LPtxt[bd].p)||"得意の出し方が強まる数字。"));
  nmsg.push("・今年の個人年 <b>"+py+"</b>： "+(PYtxt[py]||""));
  nmsg.push("<b>人物像</b>："+N.p);
  nmsg.push("<b>向く仕事</b>："+arrToText(N.job));
  nmsg.push("<b>恋愛のクセ</b>："+N.love);
  nmsg.push("<b>苦手・注意</b>："+N.weak);
  nmsg.push("<span class='note'>補足：11/22/33 は“マスターナンバー”。直感/構想/奉仕が強く出やすい。</span>");
  document.getElementById("num").innerHTML=nmsg.map(x=>"<div style='margin:6px 0'>"+x+"</div>").join("");

  // 数秘 相性（ボタンで計算）
  document.getElementById("matchBtn").onclick=function(){
    var y2=+document.getElementById("py2").value, m2=+document.getElementById("pm2").value, d2=+document.getElementById("pd2").value;
    if(!(y2>0&&m2>=1&&m2<=12&&d2>=1&&d2<=31)){document.getElementById("ncompat").innerHTML="<div class='bad'>相手の生年月日を正しく入れてね</div>"; return;}
    var lp2=lifePath(y2,m2,d2);
    var base=(NCbase[lp]&&NCbase[lp][lp2])||75;
    // 相性コメント（カップルの雰囲気）
    var feel = base>=86?"相性はとてもスムーズ。放っておいても自然にかみ合う関係。":
               base>=80?"相性は良好。共通の楽しみを増やすと長続き。":
               base>=74?"普通〜やや良い。会話の頻度と約束を大事に。":
               "課題も出やすいが、役割分担を決めると安定。";
    // 補足：得意/注意の相性（簡易）
    var tip = "";
    if((lp===1&&lp2===2)||(lp===2&&lp2===1)) tip="決める1×支える2：ありがとうを言葉で。";
    else if((lp===3&&lp2===6)||(lp===6&&lp2===3)) tip="楽しい3×面倒見6：家と外のバランスを。";
    else if((lp===4&&lp2===8)||(lp===8&&lp2===4)) tip="基盤4×成果8：計画→実行で最高。";
    else if((lp===5&&lp2===7)||(lp===7&&lp2===5)) tip="自由5×研究7：一人時間と冒険の両立。";
    else if((lp===9&&lp2===2)||(lp===2&&lp2===9)) tip="共感9×調整2：優しさ過多→境界線を。";
    else tip="お互いの違いを“役割”にすると強い。似てる点は長所として褒め合う。";

    document.getElementById("ncompat").innerHTML=
      '<div class="kv"><div class="chip">あなたの運命数：<b>'+lp+'</b></div><div class="chip">相手の運命数：<b>'+lp2+'</b></div><div class="chip">相性：<b>'+base+'/100</b></div></div>'+
      '<div class="help" style="margin-top:6px"><b>雰囲気</b>：'+feel+'<br><b>コツ</b>：'+tip+'</div>';
  };
}

// 初期化
function init(){
  // セレクト・イベント
  document.getElementById("manualMonth").innerHTML=MB.map(x=>'<option>'+x+'</option>').join('');
  document.getElementById("setu").addEventListener("change",e=>{
    document.getElementById("manualCol").style.display=(e.target.value==="manual")?"block":"none";
  });
  document.getElementById("cxg").innerHTML=S.map(x=>'<option>'+x+'</option>').join('');
  document.getElementById("cxz").innerHTML=B.map(x=>'<option>'+x+'</option>').join('');
  document.getElementById("run").addEventListener("click",run);
  // 初回自動
  run();
}
document.addEventListener("DOMContentLoaded",init);
</script>
</body></html>
