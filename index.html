<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>四柱推命＋数秘＋宿曜 Pro（やさしい総合＋3年時期）</title>
<style>
:root{--bg:#0b0c10;--card:#151821;--ink:#f5f7ff;--sub:#b6c0d6;--acc:#7ee1b5;--line:#23283a;--good:#66bb6a;--warn:#ffb74d;--bad:#ef5350}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",Roboto,Arial;line-height:1.6}
header{padding:14px 14px 8px;background:linear-gradient(180deg,rgba(0,0,0,.55),transparent)}
h1{margin:0;font-size:18px}small{color:var(--sub)}main{padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
.row{display:flex;gap:8px;flex-wrap:wrap}.col{flex:1 1 160px;min-width:150px}
label{display:block;font-size:12px;color:var(--sub);margin:4px 0 6px}
input,select,button{font-size:16px}input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0e111a;color:#f5f7ff}
.btn{width:100%;padding:12px;border:none;border-radius:12px;font-weight:700;background:var(--acc);color:#0a0a0a}
.kv{display:flex;gap:8px;flex-wrap:wrap}.chip{background:#0e111a;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:13px}
.note{font-size:13px;color:#cfd7f7;line-height:1.8}.small{font-size:12px;color:#9fb0d6}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}th{white-space:nowrap;color:#cfe0ff;text-align:left}
.bars{display:flex;gap:8px;align-items:flex-end;height:150px;border-bottom:1px dashed var(--line);padding:6px 2px}
.bar{flex:1;min-width:40px;border-radius:8px 8px 0 0;background:linear-gradient(180deg,#67e8f9,#22d3ee)}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
.tag{display:block;margin:6px 0;padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#0e111a}
.hr{height:1px;background:var(--line);margin:8px 0}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
@media(max-width:560px){.grid2{grid-template-columns:1fr}}
.kcell{border:1px solid var(--line);border-radius:10px;padding:8px}
.kcal{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.km{border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center}
.km b{display:block;margin-bottom:4px}
.hitBoth{border-color:#7ee1b5;background:rgba(126,225,181,.12)}
.hitNum{border-color:#4fc3f7;background:rgba(79,195,247,.08)}
.hitSi{border-color:#ffb74d;background:rgba(255,183,77,.10)}
.marry{outline:2px solid #ffd166; box-shadow:0 0 0 3px rgba(255,209,102,.18) inset}
.err{display:none;background:#331a1a;color:#ffc9c9;border:1px solid #5b2a2a;padding:8px;border-radius:8px;margin-top:6px;font-size:13px}
</style></head>
<body>
<header>
  <h1>四柱推命＋数秘＋宿曜 Pro</h1>
  <small>やさしい言葉で、恋愛・性格・仕事・相性・時期（3年）</small>
</header>

<main>
  <!-- 入力 -->
  <div class="card">
    <div class="row">
      <div class="col"><label>年(西暦)</label><input id="y" type="number" value="1990"></div>
      <div class="col"><label>月</label><input id="m" type="number" min="1" max="12" value="1"></div>
      <div class="col"><label>日</label><input id="d" type="number" min="1" max="31" value="1"></div>
      <div class="col"><label>出生時刻（24h, 任意 例 12:00）</label><input id="hm" value="12:00"></div>
    </div>
    <div class="row">
      <div class="col"><label>蔵干を五行に含める</label><select id="zOpt"><option value="on">含める</option><option value="off">含めない</option></select></div>
      <div class="col"><label>蔵干ウェイト</label><select id="zW"><option value="eq">等分</option><option value="pri">主0.6/次0.25/末0.15</option></select></div>
      <div class="col"><label>月柱の判定</label><select id="setu"><option value="const">高精度：定気法</option><option value="mean">簡易：平均節入り</option></select></div>
      <div class="col"><label>　</label><button class="btn" id="run">鑑定する</button></div>
    </div>
    <div id="err" class="err">日付/時刻を見直してね</div>
  </div>

  <!-- 命式 -->
  <div class="card">
    <h3>◆ 命式（四柱）＋やさしい読み方</h3>
    <div class="kv" id="ms"></div>
    <div id="tbl" style="margin-top:8px"></div>
  </div>

  <!-- 五行 -->
  <div class="card">
    <h3>◆ 五行バランス（🌱育てる／🔥あたためる／🏠整える／✨磨く／💬つなぐ）</h3>
    <div class="note">棒＝“材料の配合”。多い→看板に、少ない→毎日の小さな習慣で育てる。</div>
    <div id="bars" class="bars"></div>
    <div id="fftags" style="margin-top:6px"></div>
    <div id="fiveExplain" style="margin-top:8px"></div>
  </div>

  <!-- 総合リーディング -->
  <div class="card">
    <h3>◆ 総合リーディング（四柱＋数秘＋宿曜・やさしい解説）</h3>
    <div class="grid2">
      <div class="kcell"><b>性格・才能・人間関係の傾向</b><div id="traits"></div></div>
      <div class="kcell"><b>恋愛観（短めやさしい長文）</b><div id="loveView"></div></div>
      <div class="kcell"><b>おすすめのビジネス／働き方</b><div id="business"></div></div>
      <div class="kcell"><b>長所・短所・やさしい直し方</b><div id="strengths"></div></div>
    </div>
    <div class="hr"></div>
    <div class="kcell"><b>宿曜アドバイス（27宿・やさしい言葉）</b><div id="shukuOut" class="note" style="margin-top:4px"></div></div>
  </div>

  <!-- 相性 -->
  <div class="card">
    <h3>◆ 相性（四柱＋数秘＋宿曜：恋愛／友情／ビジネス）</h3>
    <div class="row">
      <div class="col"><label>相手の年</label><input id="py2" type="number" value="1995"></div>
      <div class="col"><label>相手の月</label><input id="pm2" type="number" min="1" max="12" value="8"></div>
      <div class="col"><label>相手の日</label><input id="pd2" type="number" min="1" max="31" value="15"></div>
      <div class="col"><label>相手の出生時刻（任意）</label><input id="phm2" placeholder="例 07:20"></div>
      <div class="col"><label>　</label><button class="btn" id="compatBtn">相性を診断</button></div>
    </div>
    <div id="compatOut" style="margin-top:6px"></div>
  </div>

  <!-- 時期 -->
  <div class="card">
    <h3>◆ 時期のサイン（これから3年）</h3>
    <div class="note">色：<span class="hitBoth">四柱＋数秘の両方で◎</span>／<span class="hitNum">数秘で◎</span>／<span class="hitSi">四柱で◎</span>　💍＝結婚に特に良い月</div>
    <div id="timing" class="kcal" style="margin-top:6px"></div>
    <div class="small" id="timingLegend"></div>
    <div class="hr"></div>
    <div class="small" id="marryList"></div>
  </div>
</main>

<script>
// ===== 干支・五行 基本 =====
var S=["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"],
    SE={"甲":"木","乙":"木","丙":"火","丁":"火","戊":"土","己":"土","庚":"金","辛":"金","壬":"水","癸":"水"},
    SY={"甲":"陽","乙":"陰","丙":"陽","丁":"陰","戊":"陽","己":"陰","庚":"陽","辛":"陰","壬":"陽","癸":"陰"};
var B=["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"],
    MB=["寅","卯","辰","巳","午","未","申","酉","戌","亥","子","丑"];
var ZM={"子":["壬"],"丑":["己","癸","辛"],"寅":["甲","丙","戊"],"卯":["乙"],"辰":["戊","乙","癸"],"巳":["丙","戊","庚"],"午":["丁","己"],"未":["己","丁","乙"],"申":["庚","壬","戊"],"酉":["辛"],"戌":["戊","辛","丁"],"亥":["壬","甲"]};
var E=["木","火","土","金","水"], GEN={"木":"火","火":"土","土":"金","金":"水","水":"木"}, CTL={"木":"土","土":"水","水":"火","火":"金","金":"木"};
var HEX=[["子","丑"],["寅","亥"],["卯","戌"],["辰","酉"],["巳","申"],["午","未"]];
var CHONG=[["子","午"],["丑","未"],["寅","申"],["卯","酉"],["辰","戌"],["巳","亥"]];
var BR_E={"子":"水","丑":"土","寅":"木","卯":"木","辰":"土","巳":"火","午":"火","未":"土","申":"金","酉":"金","戌":"土","亥":"水"};
var PEACH_BY_DAY={"寅":"卯","午":"卯","戌":"卯","申":"酉","子":"酉","辰":"酉","亥":"子","卯":"子","未":"子","巳":"午","酉":"午","丑":"午"};

// ===== ユーティリティ（日付→干支） =====
function parseHM(s){if(!s)return[12,0];var m=/^(\d{1,2}):(\d{2})$/.exec(s);if(!m)return[12,0];var h=+m[1],mm=+m[2];return[Math.min(23,Math.max(0,h)),Math.min(59,Math.max(0,mm))];}
function JDN(y,m,d){var a=Math.floor((14-m)/12),y2=y+4800-a,m2=m+12*a-3;return d+Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045;}
function sexIdx(j){var base=JDN(1984,2,2);var diff=j-base;var r=diff%60;if(r<0)r+=60;return r;}
function dayP(y,m,d){var idx=sexIdx(JDN(y,m,d));return [S[idx%10], B[idx%12]];}
function hourB(h){if(h>=23||h<1)return"子";var M=["丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];return M[Math.floor((h-1)/2)];}
function hourS(ds,hb){var m={"甲":"甲","己":"甲","乙":"丙","庚":"丙","丙":"戊","辛":"戊","丁":"庚","壬":"庚","戊":"壬","癸":"壬"},base=m[ds],off={"子":0,"丑":1,"寅":2,"卯":3,"辰":4,"巳":5,"午":6,"未":7,"申":8,"酉":9,"戌":10,"亥":11};return S[(S.indexOf(base)+off[hb])%10];}
function tenGod(d,o){var me=SE[d],my=SY[d],oe=SE[o],oy=SY[o]; if(oe===me)return my===oy?"比肩":"劫財"; if(GEN[oe]===me)return my===oy?"偏印":"印綬"; if(GEN[me]===oe)return my===oy?"傷官":"食神"; if(CTL[me]===oe)return my===oy?"偏財":"正財"; if(CTL[oe]===me)return my===oy?"偏官":"正官"; return ""; }
function cnt(stems){var c={"木":0,"火":0,"土":0,"金":0,"水":0}; for(var i=0;i<stems.length;i++){var s=stems[i]; if(SE[s]) c[SE[s]]+=1;} return c;}
function add(dst,src,w){w=w||1; for(var k in dst){dst[k]+= (src[k]||0)*w;}}
function inPairs(list,a,b){for(var i=0;i<list.length;i++){var p=list[i]; if((p[0]==a&&p[1]==b)||(p[0]==b&&p[1]==a)) return true;} return false;}

// ===== 二十四節気（定気法・JST）簡易 =====
function toJD(date){return JDN(date.getUTCFullYear(),date.getUTCMonth()+1,date.getUTCDate()) + (date.getUTCHours()-12)/24 + date.getUTCMinutes()/1440;}
function sunLonDeg(jd){var T=(jd-2451545.0)/36525;var L0=(280.46646+36000.76983*T+0.0003032*T*T)%360;var M=357.52911+35999.05029*T-0.0001537*T*T;var C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(M*Math.PI/180)+(0.019993-0.000101*T)*Math.sin(2*M*Math.PI/180)+0.000289*Math.sin(3*M*Math.PI/180);var trueLon=L0+C;return (trueLon+360)%360;}
function findTermJST(year){
  var out=[],targets=[315,345,15,45,75,105,135,165,195,225,255,285];
  for(var i=0;i<targets.length;i++){
    var approx=new Date(Date.UTC(year, i<11?i+1:0, 4, 6, 0));
    var jd0=toJD(approx), step=0.5/24, best=jd0, last=999;
    for(var k=-240;k<=240;k++){
      var jd=jd0+k*step, lon=sunLonDeg(jd), diff=((lon - targets[i] + 540)%360)-180;
      if(Math.abs(diff)<last){last=Math.abs(diff);best=jd;}
    }
    var d=new Date((best-2440587.5)*86400000); var jst=new Date(d.getTime()+9*3600000);
    out.push(jst);
  }
  return out;
}
var meanSetu=[{m:2,d:4},{m:3,d:6},{m:4,d:5},{m:5,d:6},{m:6,d:6},{m:7,d:7},{m:8,d:7},{m:9,d:7},{m:10,d:8},{m:11,d:7},{m:12,d:7},{m:1,d:6}];
function yearP(y,m,d){try{var terms=findTermJST(y);var risshun=terms[0];var cur=new Date(y,m-1,d,12);var jy=(cur<risshun)?(y-1):y;var yi=((jy-1984)%60+60)%60;return [S[yi%10],B[yi%12]];}catch(e){var before=(m<2)||(m==2&&d<4),jy=before?y-1:y;var yi=((jy-1984)%60+60)%60;return [S[yi%10],B[yi%12]];}}
function monthP(y,m,d,ys){
  function autoIndex(){try{var terms=findTermJST(y);var cur=new Date(y,m-1,d,12);var idx=-1;for(var i=0;i<12;i++){var a=terms[i],b=(i<11?terms[i+1]:findTermJST(y+1)[0]);if(cur>=a&&cur<b){idx=i;break;}}return (idx<0)?11:idx;}catch(e){var arr=[],i;for(i=0;i<12;i++){var t=meanSetu[i],yy=y,mmm=t.m;if(mmm==1)yy=y+1;arr.push({y:yy,m:mmm,d:t.d,idx:i});}var v=y*10000+m*100+d;for(i=0;i<12;i++){var a=arr[i],tv=a.y*10000+a.m*100+a.d;if(v<tv)return (i+11)%12;}return 11;}}
  var idx=(document.getElementById("setu").value==="const")?autoIndex(): (function(){var arr=[],i;for(i=0;i<12;i++){var t=meanSetu[i],yy=y,mmm=t.m;if(mmm==1)yy=y+1;arr.push({y:yy,m:mmm,d:t.d,idx:i});}var v=y*10000+m*100+d;for(i=0;i<12;i++){var a=arr[i],tv=a.y*10000+a.m*100+a.d;if(v<tv)return (i+11)%12;}return 11;})();
  var br=MB[idx]; var map={"甲":"丙","己":"甲","乙":"丙","庚":"丙","丙":"戊","辛":"戊","丁":"壬","壬":"壬","戊":"甲","癸":"甲"}, st=map[ys], si=S.indexOf(st);
  return [S[(si+idx)%10], br];
}

// ===== 数秘 =====
function pad(n){return (n<10?"0":"")+n;}
function reduceNum(n){n=(""+n).replace(/\D/g,"");var s=0;for(var i=0;i<n.length;i++) s+=(+n[i]);if(s===11||s===22||s===33) return s;while(s>9){var t=0;var str=""+s;for(var j=0;j<str.length;j++) t+=(+str[j]);if(t===11||t===22||t===33){s=t;break;}s=t;}return s;}
function lifePath(y,m,d){return reduceNum(""+y+pad(m)+pad(d));}
function birthdayNum(d){return (d>=10)?reduceNum(""+d):d;}
function personalYear(m,d,curY){return reduceNum(reduceNum(""+curY)+reduceNum(""+m)+reduceNum(""+d));}
function personalMonth(py, calMonth){return reduceNum(py + calMonth);}

// ===== 宿曜（27宿） =====
var SHUKU_NAMES=["角","亢","氐","房","心","尾","箕","斗","女","虚","危","室","壁","奎","婁","胃","昴","畢","觜","参","井","鬼","柳","星","張","翼","軫"];
var SHUKU_BASE=new Date("2000-01-06T18:14:00Z"); // 近似
function getShuku(y,m,d){var dt=new Date(Date.UTC(y,m-1,d));var diff=Math.floor((dt-SHUKU_BASE)/(1000*60*60*24));return SHUKU_NAMES[((diff%27)+27)%27];}
var SHUKU_SOFT_DB={ /* 27宿フル（やさしい長文・癒し系） */
"角":{e:"木",intro:"『芽ぶきの星』。だれより早く“おもしろい”を見つけて動ける人。",love:"恋はゆっくり育てよう。短い合図（『どう思う？』）で安心を積み重ねてね。",work:"はじめの一歩の名人。新規・企画・開拓に◎。",meet:"朝の散歩・新しいカフェ・学びの場。",care:"深呼吸3回。『今日はここまででOK』と言おう。",charm:"🌱小さな芽でも本気で伸びてる。"},
"亢":{e:"木",intro:"『誇りの星』。正直で美意識が高い人。",love:"不器用でも誠実が一番の魅力。『寂しかった』と素直に言えると近づける。",work:"品質・編集・デザイン・基準作り。",meet:"美術館・セレクト店・静かな喫茶。",care:"完璧で苦しくなったら“今日はここまで”。",charm:"🌿やさしい誇りでいこう。"},
"氐":{e:"土",intro:"『安定の星』。コツコツ信頼される土台作りの人。",love:"小さな思いやりを毎日ひとつ。相手の安心がふえていくよ。",work:"管理・経理・運用・サポートに◎。",meet:"地元の商店街・行きつけ・図書館。",care:"『大丈夫、私のペースでいい』と心に声かけ。",charm:"🏠焦らず、着実。"},
"房":{e:"火",intro:"『華やかさの星』。笑顔が周りを明るくする太陽。",love:"褒め言葉は短く早く。『今日のそれ素敵！』で距離が縮む。",work:"広報・接客・イベント・エンタメ。",meet:"ライブ・にぎやかな場所。",care:"にぎやか疲れはスマホ10分おやすみ。",charm:"🔥笑顔は私の光。"},
"心":{e:"火",intro:"『感受性の星』。感じる力がそのまま才能。",love:"言葉の前に一呼吸。やさしさがもっと届くよ。",work:"アート・研究・カウンセリングに◎。",meet:"夜の散歩・水辺・静かなバー。",care:"甘い物と深呼吸で鎮火。",charm:"💞心の炎は消えない。"},
"尾":{e:"火",intro:"『やり抜く星』。約束を守る姿が色気。",love:"デートの『時間・場所・何する』をメモで共有。安心が増える。",work:"締切管理・品質管理・完了の番人。",meet:"ゴールを祝う場。",care:"タスクは半分に割ってOK。",charm:"🔥今日も一歩、完了。"},
"箕":{e:"木",intro:"『情報の星』。話す・つなぐが得意。",love:"短文・テンポ良い連絡で心が近づく。",work:"営業・編集・PR・SNS運用に◎。",meet:"オンライン・勉強会・カフェ。",care:"“3行日記”で頭を整える。",charm:"💬ことばで心をつなごう。"},
"斗":{e:"水",intro:"『守りの星』。大切なものを守る番人。",love:"ルールはやさしい声で提案。『こうすると安心かな？』",work:"財務・保管・在庫・家計に強い。",meet:"リユース店・倉庫型店舗。",care:"不安は紙に書き、できることに丸。",charm:"💧守るって、やさしい。"},
"女":{e:"水",intro:"『聴く星』。相手の物語を受けとめる人。",love:"『つまりこう？』と要約で安心を作る。",work:"ケア・接客・HR・カウンセリング。",meet:"静かな公園・カフェ・サロン。",care:"耳を休める静かな10分。",charm:"💙やさしさは、私のつよさ。"},
"虚":{e:"金",intro:"『理想の星』。新しい形を想像する改革者。",love:"理想＋今日の一歩を見せると信頼が増す。",work:"IT・企画・戦略・新規事業に◎。",meet:"コワーキング・新店めぐり。",care:"机を3分整えると地に足がつく。",charm:"✨空想を、今日の一歩へ。"},
"危":{e:"金",intro:"『冒険の星』。前へ進む突破力。",love:"刺激は“安心の約束”とセットで。『ここまではOK？』",work:"スタートアップ・投資・第一線の営業。",meet:"ナイトイベント・アクティブな場。",care:"ぬるめのお風呂と早寝。",charm:"⚡勇気に、やさしいブレーキを。"},
"室":{e:"水",intro:"『整える星』。仕組みで安心を作る人。",love:"段取り＝愛。予定の見える化で信頼UP。",work:"法務・PM・運用・ルール作り。",meet:"図書館・役所・整った街。",care:"肩と首を回して深呼吸。",charm:"🏠整えば、やさしく進む。"},
"壁":{e:"土",intro:"『守護の星』。境界線を引ける頼れる人。",love:"『これは苦手、でもこれはOK』をやさしく伝える。",work:"セキュリティ・監査・規律運用。",meet:"会員制・クローズドな場。",care:"朝日を浴びて1分散歩。",charm:"🧱やさしい線引きは思いやり。"},
"奎":{e:"木",intro:"『知恵の星』。言葉で世界を明るくする人。",love:"要点3つ（結論→理由→お願い）でスッと届く。",work:"編集・教育・文章・広報。",meet:"本屋・学びの場・静かなカフェ。",care:"好きな詩を1編読む。",charm:"📘ことばは、やさしい光。"},
"婁":{e:"土",intro:"『整頓の星』。コツコツ支える主役。",love:"予定共有＝愛の形。",work:"物流・運用・管理。",meet:"ホームセンター・実用店。",care:"5分だけぼーっと。",charm:"📅整えれば、心がやすむ。"},
"胃":{e:"土",intro:"『育てる星』。ごはんとやさしさで満たす人。",love:"『一緒に食べる？』が愛のスイッチ。",work:"飲食・教育・ケア・実務。",meet:"市場・食イベント。",care:"“今必要なこと”を3つに絞る。",charm:"🍚いっしょに食べて、いっしょに笑おう。"},
"昴":{e:"金",intro:"『観察の星』。細やかさが信頼に。",love:"指摘の前に1つほめる。心のドアがひらく。",work:"分析・監査・医療・校正。",meet:"ラボ・専門店。",care:"遠くの景色を30秒見る。",charm:"🔍やさしい目で見て、やさしい手で直す。"},
"畢":{e:"金",intro:"『収穫と完結』。区切れる勇気が次を呼ぶ。",love:"“終わらせる”も愛。だから次へ進める。",work:"締切・納品・会計・クロージング。",meet:"仕事終わりのカフェ。",care:"80点提出で前進。",charm:"🌾区切るから、進める。"},
"觜":{e:"水",intro:"『学びの星』。教える・伝えるが得意。",love:"学び合う恋が長続き。",work:"教育・通訳・研修・PR。",meet:"セミナー・図書館。",care:"『伝えたかった気持ち』をメモ。",charm:"📖学んで、やさしく分け合う。"},
"参":{e:"木",intro:"『作戦の星』。地図を描いて進める人。",love:"作戦会議→小さく実行→振り返り。",work:"戦略・施工・現場運営。",meet:"工房・ワークショップ。",care:"肩回し＋『今日はここまで』。",charm:"🪶作戦は笑顔で始める。"},
"井":{e:"水",intro:"『助け合いの星』。コミュニティ運営の人。",love:"『相談の合図』を決めると安心。",work:"NPO・チーム運営・シェア系。",meet:"地域の場・公共スペース。",care:"温かいスープと早寝。",charm:"🍵助け合いは、やさしさの循環。"},
"鬼":{e:"木",intro:"『個性の星』。違う視点が宝物。",love:"『変わってるね』は褒め言葉。笑顔で『ありがとう』。",work:"研究・創作・スピ系。",meet:"専門店・小さなギャラリー。",care:"分かってくれる人に一言連絡。",charm:"👁変わってるは、輝いてる。"},
"柳":{e:"水",intro:"『流れの星』。柔らかく和ませる人。",love:"まず肯定の相槌『うん、そうだね』。",work:"調整・接客・通訳。",meet:"川沿い・風通しの良い店。",care:"選択肢を2つに減らす。",charm:"🌊やわらかさは強さ。"},
"星":{e:"火",intro:"『魅せる星』。演出と発信で心を動かす。",love:"『ありがとう』多めで恋が温まる。",work:"芸能・配信・ブランド。",meet:"劇場・フォトスポット。",care:"まず自分を褒める。",charm:"💫私の光で誰かが笑う。"},
"張":{e:"火",intro:"『拡張の星』。広げる力と人望。",love:"『ふたりの目標』を一行で文字に。",work:"営業・組織づくり・イベント。",meet:"展示会・新店舗。",care:"姿勢を正して休憩。",charm:"🌈大きくなっても優しく。"},
"翼":{e:"木",intro:"『支える星』。そっと背中を押す風。",love:"そばにいる事実が最大の愛。",work:"旅・輸送・案内。",meet:"駅・空港・旅先。",care:"足裏マッサージで落ち着く。",charm:"🪽わたしは風、やさしく運ぶ。"},
"軫":{e:"水",intro:"『包み込む星』。困っている人に寄りそえる。",love:"『ありがとう』を先に言うと恋が温まる。",work:"医療・受付・調整・相談。",meet:"ボランティア・喫茶店。",care:"“今・明日・今度”に分ける。",charm:"💞やさしさは減らない魔法。"}};

function shukuyoHTML(name){
  var x=SHUKU_SOFT_DB[name];
  if(!x) return '<div class="tag">本命宿：<b>'+name+'</b>（準備中）</div>';
  return '<div class="tag"><b>🌙 本命宿：'+name+'</b>（'+x.e+'の気質）</div>'
        +'<p class="note">【あなたは】'+x.intro+'</p>'
        +'<p class="note">【恋愛】'+x.love+'</p>'
        +'<p class="note">【お仕事】'+x.work+'</p>'
        +'<p class="note">【出会い】'+x.meet+'</p>'
        +'<p class="note">【こころケア】'+x.care+'</p>'
        +'<p class="note"><b>'+x.charm+'</b></p>';
}

// ===== 相性用・数秘ベーススコア（簡易） =====
var NCbase={1:{1:70,2:78,3:85,4:76,5:82,6:74,7:80,8:88,9:75,11:86,22:84,33:80},2:{1:78,2:72,3:77,4:82,5:74,6:86,7:80,8:70,9:83,11:85,22:76,33:84},3:{1:85,2:77,3:75,4:72,5:88,6:80,7:78,8:79,9:84,11:86,22:78,33:90},4:{1:76,2:82,3:72,4:74,5:70,6:80,7:85,8:86,9:73,11:78,22:88,33:76},5:{1:82,2:74,3:88,4:70,5:76,6:73,7:80,8:78,9:84,11:86,22:80,33:82},6:{1:74,2:86,3:80,4:80,5:73,6:78,7:76,8:82,9:88,11:84,22:80,33:86},7:{1:80,2:80,3:78,4:85,5:80,6:76,7:74,8:82,9:79,11:88,22:84,33:78},8:{1:88,2:70,3:79,4:86,5:78,6:82,7:82,8:76,9:80,11:84,22:90,33:80},9:{1:75,2:83,3:84,4:73,5:84,6:88,7:79,8:80,9:76,11:86,22:82,33:88},11:{1:86,2:85,3:86,4:78,5:86,6:84,7:88,8:84,9:86,11:82,22:86,33:90},22:{1:84,2:76,3:78,4:88,5:80,6:80,7:84,8:90,9:82,11:86,22:84,33:86},33:{1:80,2:84,3:90,4:76,5:82,6:86,7:78,8:80,9:88,11:90,22:86,33:84}};

// ===== 鑑定実行 =====
function run(){
  var y=+document.getElementById("y").value, m=+document.getElementById("m").value, d=+document.getElementById("d").value;
  var hm=document.getElementById("hm").value, t=parseHM(hm), hh=t[0];
  if(!(y>0&&m>=1&&m<=12&&d>=1&&d<=31)){document.getElementById("err").style.display="block";return;}
  document.getElementById("err").style.display="none";

  // 柱
  var dp=dayP(y,m,d), ds=dp[0], db=dp[1];
  var yp=yearP(y,m,d), ys=yp[0], yb=yp[1];
  var mp=monthP(y,m,d,ys), ms=mp[0], mb=mp[1];
  var hb=hourB(hh), hs=hourS(ds,hb);

  // 命式
  document.getElementById("ms").innerHTML=[
    '年：<b>'+ys+yb+'</b>（育ち/家）','月：<b>'+ms+mb+'</b>（社会/仕事）','日：<b>'+ds+db+'</b>（中心）','時：<b>'+hs+hb+'</b>（考え/将来）'
  ].map(x=>'<div class="chip">'+x+'</div>').join('');

  // 命式表（やさしい）
  var TGtxt={"比肩":"自分でやる力","劫財":"仲間と突破","食神":"表現と楽しさ","傷官":"改善と分析","偏財":"ご縁とチャンス","正財":"約束と信頼","偏官":"挑戦と行動","正官":"役割と評価","偏印":"ひらめき","印綬":"学びと理解"};
  function row(p){var tg=tenGod(ds,p[1]), easy={"比肩":"自立/自分軸","劫財":"仲間で突破","食神":"楽しく表現","傷官":"改善/分析","偏財":"ご縁・行動","正財":"約束・信頼","偏官":"小さく挑戦","正官":"役割・評価","偏印":"直感を試す","印綬":"学びで強化"}[tg]||"";return '<tr><th>'+p[0]+'</th><td>'+p[1]+'</td><td>'+p[2]+'</td><td>'+tg+'</td><td>'+TGtxt[tg]+'</td><td class="small">'+p[3]+'｜'+easy+'</td></tr>';}
  document.getElementById("tbl").innerHTML='<table><thead><tr><th>柱</th><th>天干</th><th>地支</th><th>通変星</th><th>意味</th><th>やさしい読み方</th></tr></thead><tbody>'+
    [["年柱",ys,yb,"家の雰囲気"],["月柱",ms,mb,"社会での顔"],["日柱",ds,db,"性格の核心"],["時柱",hs,hb,"考え/将来像"]].map(row).join('')+
  '</tbody></table>';

  // 五行（蔵干込み）＋やさしい言葉
  function zWeights(z){var l=ZM[z]||[]; if(l.length==1)return[1]; if(document.getElementById("zW").value==="eq"){return l.map(()=>1/l.length);} return l.length==2?[0.65,0.35]:[0.6,0.25,0.15].slice(0,l.length);}
  var vis=cnt([ys,ms,ds,hs]), zc={"木":0,"火":0,"土":0,"金":0,"水":0}, pillars=[[ys,yb],[ms,mb],[ds,db],[hs,hb]];
  for(var i=0;i<pillars.length;i++){var zlist=ZM[pillars[i][1]]||[], w=zWeights(pillars[i][1]); for(var j=0;j<zlist.length;j++){add(zc,cnt([zlist[j]]), w[j]||0);}}
  var useZ=document.getElementById("zOpt").value==="on", total={}; E.forEach(e=>total[e]=(vis[e]||0)+(useZ?zc[e]||0:0));
  var mx=Math.max.apply(null,E.map(e=>total[e]||0)), bars=E.map(function(e){var h=mx?Math.round((total[e]||0)/mx*140)+6:6;return '<div style="flex:1;text-align:center"><div class="bar" style="height:'+h+'px"></div><div class="small" style="padding-top:6px">'+({"木":"🌱育てる","火":"🔥あたためる","土":"🏠整える","金":"✨磨く","水":"💬つなぐ"}[e])+' '+(total[e]||0).toFixed(2)+'</div></div>';}).join('');
  document.getElementById("bars").innerHTML=bars; var ord=E.slice().sort((a,b)=>(total[b]||0)-(total[a]||0));
  document.getElementById("fftags").innerHTML='<span class="badge">強：'+({"木":"🌱育てる","火":"🔥あたためる","土":"🏠整える","金":"✨磨く","水":"💬つなぐ"}[ord[0]])+'</span><span class="badge">弱：'+({"木":"🌱育てる","火":"🔥あたためる","土":"🏠整える","金":"✨磨く","水":"💬つなぐ"}[ord[4]])+'</span>';

  // やさしい具体アドバイス
  var meaning={
    "木":{mean:"🌱育てる（学び・成長）", strong:"『育てる人』。教える・広めるで輝く。", weak:"朝日＋週1新しい本＋1日1アウトプットで根が伸びる。"},
    "火":{mean:"🔥あたためる（情熱・発信）", strong:"思いを声に乗せるほど道が開く。", weak:"体を温める・笑顔の挨拶・短いスピーチ練習。"},
    "土":{mean:"🏠整える（安定・計画）", strong:"段取りの神。手順書が金脈。", weak:"朝5分片付け・小さな締切で地盤固め。"},
    "金":{mean:"✨磨く（判断・ルール）", strong:"基準を決め守ると信頼が増える。", weak:"捨て1・整え5分・情報1ページ整理。"},
    "水":{mean:"💬つなぐ（情報・対話）", strong:"調べてまとめて橋渡し。", weak:"3行日記・独り言メモ・散歩で巡りが戻る。"}
  };
  var sumVal=E.reduce((a,k)=>a+(total[k]||0),0)||1, avg=sumVal/5;
  function lv(v){if(v>=avg*1.15)return"強め（看板に）"; if(v<=avg*0.85)return"弱め（育てる）"; return"ほどよい（このまま）";}
  document.getElementById("fiveExplain").innerHTML=E.map(function(k){
    var v=(total[k]||0), tip=(lv(v).indexOf("強め")>=0?meaning[k].strong:(lv(v).indexOf("弱め")>=0?meaning[k].weak:"いつも通りでOK"));
    return '<div class="tag">'+meaning[k].mean+' ／ <b>'+lv(v)+'</b> → '+tip+'</div>';
  }).join('');

  // 通変星カウント（深掘りの軸）
  var tgAll={}, pillarsGan=[ys,ms,hs];
  pillarsGan.forEach(g=>{var t=tenGod(ds,g); if(t) tgAll[t]=(tgAll[t]||0)+1;});
  (ZM[db]||[]).forEach(zg=>{var t=tenGod(ds,zg); if(t) tgAll[t]=(tgAll[t]||0)+1;});
  var topTG=Object.keys(tgAll).sort((a,b)=>(tgAll[b]||0)-(tgAll[a]||0));

  // 数秘
  var lp=lifePath(y,m,d), bd=birthdayNum(d);

  // 性格・人間関係（やさしい）
  var traits=[];
  if(topTG[0]) traits.push('性格の核：<b>'+topTG[0]+'</b>（'+{"比肩":"自分で決めて動ける力","劫財":"人を巻き込んで前へ進む力","食神":"楽しさと表現で周りを明るくする力","傷官":"細かく見て良くしていく力","偏財":"ご縁をつかむ行動力","正財":"コツコツ信頼をためる力","偏官":"挑戦して伸びる実戦力","正官":"役割を守って評価を上げる力","偏印":"ひらめきを形にする力","印綬":"学びを貯めて伝える力"}[topTG[0]]+'）');
  traits.push('人間関係：<b>'+(SE[ds]===SE[ms]?"似た強みを褒め合うと最強":"違いは“役割分担”にすると噛み合う")+'</b>');
  document.getElementById("traits").innerHTML=traits.map(x=>'<div class="tag">'+x+'</div>').join('');

  // 恋愛観（2割短縮・わかりやすい）
  function loveText(lp,eCore,tgLead,db){
    var base={
      "木":"恋は『育てる作業』。あせらず会話を重ねて、少しずつ安心を増やそう。",
      "火":"恋は『温度』。想いを言葉と行動で伝えるほど距離が縮む。",
      "土":"恋は『安心設計』。約束・連絡・お金のルールが整うと一気に進む。",
      "金":"恋は『ていねいさ』。清潔感と小さな気づかいで誠実さが伝わる。",
      "水":"恋は『対話』。気持ちを短い言葉で伝えると誤解が減る。"
    }[eCore];
    var lpAdd={1:"リード上手。相手の気持ちを先に聞くと信頼UP。",2:"寄りそう天才。我慢しすぎ注意。",3:"楽しい恋。予定のドタキャンだけ注意。",4:"安定重視。将来像の共有が決め手。",5:"自由派。連絡のルールを先に決めて平和。",6:"世話焼き。自分ケアの日を作ろう。",7:"一人時間が燃料。静かな理解者に惹かれる。",8:"頼れる人。がんばりすぎたら甘える日を。",9:"共感型。境界線も大事に。",11:"心の通い合い重視。焦らず育てよう。",22:"大きな目標を一緒に追うと最強。",33:"包容力の塊。抱え込みすぎ注意。"}[lp];
    var tgAdd={"比肩":"『私はこうしたい』を素直に。合わせすぎは魅力半減。","劫財":"一緒に作戦会議が近道。","食神":"笑顔とユーモアが武器。","傷官":"ダメ出しは『提案の形』で優しく。","偏財":"会う回数＝安心。軽い誘いを増やそう。","正財":"小さな約束を守るほど自然に結婚の話に。","偏官":"勢いは魅力、結論前に一呼吸。","正官":"礼儀と落ち着きが好印象。","偏印":"直感だけで判断しない。言葉で補足。","印綬":"学び合いが長続きの鍵。"}[tgLead]||"";
    var peach = PEACH_BY_DAY[db] ? "あなたの日支「"+db+"」の桃花は「"+PEACH_BY_DAY[db]+"」。その月や人は“出会いの風”。" : "";
    return [base,lpAdd,tgAdd,peach].filter(Boolean).map(s=>'<div class="note">'+s+'</div>').join("");
  }
  document.getElementById("loveView").innerHTML=loveText(lp,SE[ds],topTG[0],db);

  // ビジネス（やさしい）
  var strong=ord[0], weak=ord[4];
  var bizMap={"木":"教育/育成/企画","火":"広報/販売/エンタメ","土":"管理/総務/品質","金":"法務/財務/審査/デザイン","水":"IT/情報/研究/伝達"};
  var lpJob={1:"起業/営業/企画/管理",2:"人事/秘書/接客/ケア",3:"デザイン/広報/教育",4:"経理/行政/建築/品質",5:"営業/旅行/マーケ/通訳",6:"医療/福祉/美容/教育",7:"研究/分析/開発/コンサル",8:"管理職/不動産/金融",9:"教育/福祉/企画/広報",11:"アート/表現/カウンセリング",22:"経営/社会事業/建設/仕組み化",33:"教育/ケア/表現/コミュニティ"};
  var roleTip={"木":"企画/育成の役","火":"広報/推進の役","土":"進行/品質の役","金":"監査/整備の役","水":"情報/分析の役"}[strong];
  document.getElementById("business").innerHTML=[
    '五行の強み：<b>'+({"木":"🌱育てる","火":"🔥あたためる","土":"🏠整える","金":"✨磨く","水":"💬つなぐ"}[strong])+'</b> → '+bizMap[strong],
    '数秘の適職：<b>'+lp+'</b> → '+lpJob[lp],
    'チームでの役割：<b>'+roleTip+'</b>',
    '育てる所：<b>'+({"木":"🌱育てる","火":"🔥あたためる","土":"🏠整える","金":"✨磨く","水":"💬つなぐ"}[weak])+'</b> → '+{"木":"朝日とストレッチ＋“ありがとう”の声出し","火":"体を温めて想いを1言で伝える","土":"小さな締切で“やる日/休む日”を分ける","金":"捨て1・整え5分・情報1ページ整理","水":"3行日記・散歩・対話"}[weak]
  ].map(x=>'<div class="note">'+x+'</div>').join("");

  // 長所・短所（やさしい直し方）
  var deepShort={"木":{pro:"面倒見と成長力",con:"優しさが後回しに化ける"}, "火":{pro:"想いで人を動かす",con:"熱が強すぎて相手が疲れる"}, "土":{pro:"安定と継続",con:"慎重すぎて機会損失"}, "金":{pro:"基準と品質",con:"完璧主義でスピード低下"}, "水":{pro:"情報収集と伝達",con:"考えすぎて動けない"}};
  var fix={"木":"毎朝5分の学び","火":"声に出す/体を温める","土":"小さな締切を置く","金":"5分片付け/基準決め","水":"3行日記/散歩/対話"};
  var strengths=['長所：<b>'+({"木":"🌱育てる","火":"🔥あたためる","土":"🏠整える","金":"✨磨く","水":"💬つなぐ"}[strong])+'</b>（'+deepShort[strong].pro+'）を前に出す。',
                 '短所：<b>'+({"木":"🌱育てる","火":"🔥あたためる","土":"🏠整える","金":"✨磨く","水":"💬つなぐ"}[weak])+'</b>が不足 → '+deepShort[weak].con+'。だから“'+fix[weak]+'”を習慣に。'];
  if(topTG[0]==="傷官") strengths.push('［注意］ダメ出しは“提案の形”で。時間を区切って出す。');
  if(topTG[0]==="偏官") strengths.push('［注意］勢い余りやすい → 一呼吸置いてから話す。');
  if(topTG[0]==="正財") strengths.push('［注意］抱え込みすぎ → 役割分担と締切共有。');
  document.getElementById("strengths").innerHTML=strengths.map(x=>'<div class="note">'+x+'</div>').join("");

  // 宿曜
  var shuku=getShuku(y,m,d);
  document.getElementById("shukuOut").innerHTML=shukuyoHTML(shuku);

  // ===== 相性 =====
  document.getElementById("compatBtn").onclick=function(){
    var y2=+document.getElementById("py2").value, m2=+document.getElementById("pm2").value, d2=+document.getElementById("pd2").value;
    var hm2=document.getElementById("phm2").value||"12:00", t2=parseHM(hm2), hh2=t2[0];
    if(!(y2>0&&m2>=1&&m2<=12&&d2>=1&&d2<=31)){document.getElementById("compatOut").innerHTML="<div class='err' style='display:block'>相手の生年月日を正しく入れてね</div>"; return;}
    var dp2=dayP(y2,m2,d2), ds2=dp2[0], db2=dp2[1];
    var hb2=hourB(hh2), hs2=hourS(ds2,hb2);
    var lp1=lifePath(y,m,d), lp2=lifePath(y2,m2,d2);

    function gScore(a,b){var s=50,ea=SE[a],eb=SE[b]; if(GEN[ea]===eb)s+=12; if(GEN[eb]===ea)s+=12; if(CTL[ea]===eb)s-=14; if(CTL[eb]===ea)s-=14; if(SY[a]===SY[b])s+=6; else s-=4;return Math.max(0,Math.min(100,s));}
    var H={ "六合":HEX, "冲":CHONG, "害":[["子","未"],["丑","午"],["寅","巳"],["卯","辰"],["申","亥"],["酉","戌"]] };
    function zScore(a,b){var s=50; if(inPairs(H["六合"],a,b))s+=20; if(inPairs(H["冲"],a,b))s-=18; if(inPairs(H["害"],a,b))s-=8; return Math.max(0,Math.min(100,s));}
    var siJuScore=Math.round(gScore(ds,ds2)*0.6 + zScore(db,db2)*0.4);
    var numScore=(NCbase[lp1]&&NCbase[lp1][lp2])||75;
    var loveScore=Math.round(siJuScore*0.65 + numScore*0.35);
    var friendScore=Math.round(siJuScore*0.5 + numScore*0.5);
    var roleBoost=0; if(GEN[SE[ds]]===SE[ds2]) roleBoost+=4; if(CTL[SE[ds]]===SE[ds2]) roleBoost+=3;
    var bizScore=Math.max(0,Math.min(100, Math.round(siJuScore*0.6 + numScore*0.4 + roleBoost)));
    function face(s){return s>=86?"◎":(s>=80?"◯":(s>=74?"△":"▲"));}

    // テンプレの偏り回避：話し方を3種類ローテ
    var talkTips=["感想→理由→お願いの順で短く","まず相手の気持ちを要約→自分の気持ち→次の一歩","嬉しかった点→困った点→一緒に試したいこと"];
    var tt=talkTips[(y+m+d+y2+m2+d2)%talkTips.length];

    function loveAdvice(s){
      var a=[];
      if(s<75)a.push("すれ違いは『"+tt+"』でやさしく伝えてみて。");
      if(inPairs(HEX, db, db2))a.push("六合カップル：会う回数を少し増やすほど絆UP。");
      if(inPairs(CHONG, db, db2))a.push("冲カップル：先に“共通の目的”を一行で決めてから会話を。");
      a.push("デートは「"+({"木":"散歩や本屋","火":"ライブや外食","土":"家ごはんや整える日","金":"美術館やきれいな場所","水":"カフェで長話"}[SE[ds]])+"」が定番の勝ちパターン。");
      a.push("相手の日支は「"+db2+"」。あなたの桃花（月）「"+(PEACH_BY_DAY[db]||"—")+"」も意識して予定に入れよう。");
      return a.join(" ");
    }
    function friendAdvice(s){
      var a=[];
      if(s<75)a.push("連絡頻度（週1/隔週）を最初に合意しよう。");
      a.push((CTL[SE[ds]]===SE[ds2]||CTL[SE[ds2]]===SE[ds])?"担当分け（企画/まとめ/連絡）で摩擦回避。":"共通の趣味時間をカレンダー固定。");
      a.push("ありがとうは“その日のうち”に短文で。");
      return a.join(" ");
    }
    function bizAdvice(s){
      var a=[];
      if(GEN[SE[ds]]===SE[ds2])a.push("あなた→相手：育成/コーチ適性。");
      if(CTL[SE[ds]]===SE[ds2])a.push("あなた→相手：KPIや締切設計を担当。");
      if(CTL[SE[ds2]]===SE[ds])a.push("相手→あなた：進捗チェックを任せる。");
      a.push("会議は『決める人→順番→期限』を最初に宣言。共有メモで透明化。");
      return a.join(" ");
    }

    // 宿曜の相性：本命宿（近似）
    var sh1=getShuku(y,m,d), sh2=getShuku(y2,m2,d2);
    var shLine='宿曜：あなた「'+sh1+'」× 相手「'+sh2+'」。違う宿は価値観の違い＝武器。共通点は“安心”。';

    var html='';
    html+='<div class="kv"><div class="chip">あなた：<b>'+ds+db+'</b> / 運命数<b>'+lp1+'</b> / 宿：'+sh1+'</div><div class="chip">相手：<b>'+ds2+db2+'</b> / 運命数<b>'+lp2+'</b> / 宿：'+sh2+'</div></div><div class="hr"></div>';
    html+='<div><b>四柱の相性</b>：'+siJuScore+'/100　<b>数秘の相性</b>：'+numScore+'/100</div><div class="small">'+shLine+'</div><div class="hr"></div>';
    html+='<div><b>総合（恋愛）</b>：'+loveScore+'/100 '+face(loveScore)+'<br><span class="small">'+loveAdvice(loveScore)+'</span></div>';
    html+='<div style="margin-top:6px"><b>総合（友情）</b>：'+friendScore+'/100 '+face(friendScore)+'<br><span class="small">'+friendAdvice(friendScore)+'</span></div>';
    html+='<div style="margin-top:6px"><b>総合（ビジネス）</b>：'+bizScore+'/100 '+face(bizScore)+'<br><span class="small">'+bizAdvice(bizScore)+'</span></div>';
    document.getElementById("compatOut").innerHTML=html;
  };

  // ===== 時期（36か月） =====
  function bestNumMonths(kind){var sets={love:[2,3,6], meet:[3,5], job:[1,5,8], ind:[1,8]}; return sets[kind||'love']||[2,3,6];}
  var meE=SE[ds], wealthE=CTL[meE];
  var controlsMeE=(function(){for(var k in CTL){if(CTL[k]===meE)return k;}return null;})();
  function monthBranch(y,m,d){ return monthP(y,m,d,yearP(y,m,d)[0])[1]; }

  var today=new Date(), startY=today.getFullYear(), startM=today.getMonth()+1;
  var cells=[], marryMonths=[];
  for(var i=0;i<36;i++){
    var Y=startY+Math.floor((startM-1+i)/12);
    var M=((startM-1+i)%12)+1;

    var br=monthBranch(Y,M,15), brE=BR_E[br];
    var curPY=personalYear(m,d,Y), pm=personalMonth(curPY,M);

    var numLove=bestNumMonths('love').indexOf(pm)>=0;
    var numMeet=bestNumMonths('meet').indexOf(pm)>=0;
    var numJob =bestNumMonths('job').indexOf(pm)>=0;
    var numInd =bestNumMonths('ind').indexOf(pm)>=0;

    var siMeet = (br===PEACH_BY_DAY[db]);    // 出会い（桃花）
    var siLove = (brE===wealthE) || siMeet;  // 恋愛/結婚：財or桃花
    var siJob  = (brE===controlsMeE);        // 転職：官
    var siInd  = (brE===wealthE) || (SE[ms]===meE); // 独立：財 or 自分強化

    function cls(b1,b2){return b1&&b2?"hitBoth":(b1?"hitNum":(b2?"hitSi":""));}

    var marryHit = ( (numLove && siLove) || (siLove && siMeet) || (numLove && siMeet) );

    var divCls=cls((numLove||numMeet||numJob||numInd),(siLove||siJob||siInd)) + (marryHit?' marry':'');
    var label=Y+"年"+M+"月（"+br+"）";
    var detail=[];
    if(numLove||siLove) detail.push("恋愛◎");
    if(numMeet||siMeet) detail.push("出会い◎");
    if(numJob ||siJob ) detail.push("転職◎");
    if(numInd ||siInd ) detail.push("独立◎");
    if(marryHit) { detail.push("💍結婚◎"); marryMonths.push(label); }
    if(detail.length===0) detail.push("様子見");

    cells.push('<div class="km '+divCls+'"><b>'+label+'</b>'+detail.join("・")+'</div>');
  }
  document.getElementById("timing").innerHTML=cells.join('');
  document.getElementById("timingLegend").innerHTML="※ “恋/結婚”は数秘（2/3/6）＋四柱の財の月/桃花月、“転職”は数秘（1/5/8）＋四柱の官の月、“独立”は数秘（1/8）＋四柱の財/自分強化で判定。色はW◎/数秘◎/四柱◎。";
  document.getElementById("marryList").innerHTML = (marryMonths.length? "💍 <b>結婚に良い月：</b> "+marryMonths.join("、") : "💍 結婚は焦らず、準備の年。");
}

// 初期化
function init(){ document.getElementById("run").addEventListener("click",run); document.getElementById("compatBtn").addEventListener("click",function(){}); run(); }
document.addEventListener("DOMContentLoaded",init);
</script>
</body></html>
