<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ã‚ãªãŸã®é‘‘å®šï½œæ•°ç§˜ï¼‹å®¿æ›œï¼ˆé¢¨æ°´ãªã—ãƒ»çµ±åˆç‰ˆï¼‰</title>
<style>
  :root{
    --bg:#0b0f14;--ink:#eaf1ff;--muted:#9fb1cf;--line:#223049;
    --panel:#111826;--panel2:#0c1728;--accent:#22d3ee;--accent2:#34d399;
    --love:#f472b6;--meet:#34d399;--marry:#fbbf24;--move:#60a5fa;
    --job:#c084fc;--work:#ffd580;--promo:#a5b4fc;--bad:#f97316;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#05080c;color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;line-height:1.95}
  header{padding:26px 16px;text-align:center;background:linear-gradient(180deg,#0a0f13,#0a1320)}
  header h1{margin:0 0 6px;font-size:24px;letter-spacing:.04em}
  header p{margin:0;color:var(--muted)}
  main{max-width:1120px;margin:0 auto;padding:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 8px 24px rgba(0,0,0,.26)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1422;color:var(--ink)}
  button{cursor:pointer;background:linear-gradient(45deg,var(--accent),var(--accent2));border:none;font-weight:700}
  h2{margin:0 0 10px;font-size:20px}
  h3{margin:12px 0 6px;font-size:17px}
  p{margin:.55em 0}
  .muted{color:var(--muted)} .small{font-size:12px}
  .box{background:var(--panel2);border:1px dashed #27405f;padding:12px;border-radius:10px;margin:.6em 0}
  .lead{font-size:15px}
  .pill{display:inline-block;border:1px solid var(--line);padding:3px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .row{display:grid;gap:12px}
  @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .calendar{display:grid;gap:12px}
  .calendar{grid-template-columns:1fr}
  @media(min-width:680px){.calendar{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:960px){.calendar{grid-template-columns:repeat(3,1fr)}}
  .mon{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0b1422;position:relative}
  .mon.now{outline:2px solid var(--accent);box-shadow:0 0 0 4px rgba(34,211,238,.2)}
  .head{display:flex;justify-content:space-between;align-items:center}
  .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .tag{display:inline-flex;align-items:center;gap:4px;font-size:11px;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
  .t-love{color:var(--love)}
  .t-meet{color:var(--meet)}
  .t-marry{color:var(--marry)}
  .t-move{color:var(--move)}
  .t-job{color:var(--job)}
  .t-work{color:var(--work)}
  .t-promo{color:var(--promo)}
  .hr{height:1px;background:#1e2d44;margin:10px 0}
  .inline-hint{display:flex;flex-wrap:wrap;gap:8px}
  .kpi{display:flex;flex-wrap:wrap;gap:8px}
  .kpi span{background:#0b1422;border:1px solid var(--line);border-radius:8px;padding:6px 10px}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .bad{color:var(--bad)}
  /* pie */
  .pie{width:140px;height:140px;border-radius:50%;background:
      conic-gradient(#22d3ee var(--a), #34d399 0 var(--b),
                     #a5b4fc 0 var(--c), #f472b6 0 var(--d),
                     #60a5fa 0);}
  .pie-wrap{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .legend{display:grid;gap:6px}
  .legend span{display:inline-flex;gap:6px;align-items:center}
  .legend i{display:inline-block;width:10px;height:10px;border-radius:2px}
</style>
</head>
<body>
<header>
  <h1>ã‚ãªãŸã®é‘‘å®šï½œå‘½ãƒ»é‹ãƒ»åœ Ã— æ•°ç§˜ï¼‹å®¿æ›œ</h1>
  <p>èª­ã¿ã‚„ã™ãã€ã™ãå®Ÿè¡Œã«ç§»ã›ã‚‹å…·ä½“ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‚</p>
</header>

<main>
  <!-- å…¥åŠ› -->
  <div class="card">
    <div class="row">
      <div>
        <label>ã‚ãªãŸã®ç”Ÿå¹´æœˆæ—¥</label>
        <input type="date" id="birthA"/>
        <div class="row">
          <div>
            <label>å‡ºç”Ÿæ™‚åˆ»ï¼ˆä»»æ„ï¼‰</label>
            <input type="time" id="timeA" step="60"/>
          </div>
          <div>
            <label>æ€§åˆ¥ï¼ˆä»»æ„ï½œæ–‡ä½“ã«åæ˜ ï¼‰</label>
            <select id="genderA">
              <option value="">æŒ‡å®šãªã—</option>
              <option value="female">å¥³æ€§</option>
              <option value="male">ç”·æ€§</option>
            </select>
          </div>
        </div>
        <p class="small muted">â€»å®¿æ›œã¯æœˆã®é»„çµŒã‹ã‚‰27å®¿ã‚’ç®—å‡ºï¼ˆMeeusç³»ç°¡æ˜“æ³•ï¼‰ã€‚æ™‚åˆ»ä¸æ˜ã¯æ­£åˆæ¨å®šã€‚</p>
      </div>
      <div>
        <label>ã‚ãªãŸã®æ°åï¼ˆãƒ­ãƒ¼ãƒå­—æ¨å¥¨ãƒ»ä»»æ„ï¼‰</label>
        <input type="text" id="nameA" placeholder="ä¾‹: TARO YAMADA"/>
        <label style="margin-top:8px">ç›¸æ€§ï¼ˆä»»æ„ï¼‰ï¼šç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥</label>
        <input type="date" id="birthB"/>
        <div class="row">
          <div>
            <label>ç›¸æ‰‹ã®å‡ºç”Ÿæ™‚åˆ»ï¼ˆä»»æ„ï¼‰</label>
            <input type="time" id="timeB" step="60"/>
          </div>
          <div>
            <label>ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</label>
            <select id="tz">
              <option value="">è‡ªå‹•ï¼ˆç«¯æœ«TZï¼‰</option>
              <option value="9">æ—¥æœ¬ï¼ˆUTC+9ï¼‰</option>
              <option value="0">UTCÂ±0</option>
              <option value="-5">NYï¼ˆUTC-5ï¼‰</option>
              <option value="1">CETï¼ˆUTC+1ï¼‰</option>
            </select>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="run">é‘‘å®šã™ã‚‹</button>
          <button id="shuffle" title="è¡¨ç¾ã ã‘ãƒ©ãƒ³ãƒ€ãƒ ã«æ›´æ–°ï¼ˆæ•°å€¤ã¯å›ºå®šï¼‰">è¡¨ç¾ã‚’å¤‰ãˆã‚‹</button>
        </div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="kpi small">
      <span>ãƒ©ã‚¤ãƒ•ãƒ‘ã‚¹ï¼š<strong id="lifePath">â€”</strong></span>
      <span>èª•ç”Ÿæ•°ï¼š<strong id="birthNum">â€”</strong></span>
      <span>æœ¬å‘½å®¿ï¼š<strong id="shukuA">â€”</strong></span>
      <span>ä»Šå¹´ã®å€‹äººå¹´ï¼š<strong id="pyear">â€”</strong></span>
      <span id="nameBad" class="bad" style="display:none">â€»æ°åã¯ãƒ­ãƒ¼ãƒå­—æ¨å¥¨ã§ã™</span>
    </div>
  </div>

  <!-- 1. ã‚ãªãŸã®è¨­è¨ˆå›³ -->
  <div class="card" id="secDesign">
    <h2>1. ã‚ãªãŸã®è¨­è¨ˆå›³ï¼ˆ5åˆ†ã§ã‚ã‹ã‚‹ï¼‰</h2>
    <div id="designPie" class="pie-wrap"></div>
    <div class="box" id="designText"></div>
  </div>

  <!-- 2. ã„ã¾ã®å­£ç¯€ -->
  <div class="card" id="secSeason">
    <h2>2. ã„ã¾ã®å­£ç¯€ï¼ˆå€‹äººå¹´ãƒ»æœˆãƒ»æ—¥ï¼‰</h2>
    <div id="spark" class="box"></div>
    <div id="seasonText"></div>
  </div>

  <!-- 3. ä¸€ç”Ÿã®ãƒ“ãƒƒã‚°ã‚¦ã‚§ãƒ¼ãƒ– -->
  <div class="card" id="secPinn">
    <h2>3. ä¸€ç”Ÿã®ãƒ“ãƒƒã‚°ã‚¦ã‚§ãƒ¼ãƒ–ï¼ˆãƒ”ãƒŠã‚¯ãƒ«ï¼†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼‰</h2>
    <div id="pinnChart" class="box"></div>
    <div id="pinnText"></div>
  </div>

  <!-- 5. ãµãŸã‚Šã®å–ã‚Šæ‰±ã„èª¬æ˜æ›¸ -->
  <div class="card" id="secLove">
    <h2>5. ãµãŸã‚Šã®å–ã‚Šæ‰±ã„èª¬æ˜æ›¸ï¼ˆå®¿æ›œãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼‹ä¸€è‡´é …ç›®ï¼‰</h2>
    <div class="box" id="compat"></div>
    <p class="small muted">â€»ç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥ã‚’å…¥ã‚Œã‚‹ã¨ã€å®¿æ›œï¼‹æ•°ç§˜ã§ç‚¹æ•°åŒ–ã—ãŸç›¸æ€§ã¨é•·æ–‡ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
  </div>

  <!-- 36ãƒ¶æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="card" id="secCal">
    <h2>äºˆå®šã‚’çµ„ã¿ã‚„ã™ã„36ãƒ¶æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div class="small muted">
      ã€Œå€‹äººæœˆï¼ˆ1ã€œ9ï¼‰ã€ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€<strong>ã‚ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã‚¿ã‚°</strong>ã§è¡¨ç¤ºã€‚å„æœˆã¯æœ€å¤§3ã‚¿ã‚°ã¾ã§ï¼ˆæ‹æ„›ï¼å‡ºä¼šã„ï¼çµå©šï¼å¼•è¶Šã—ï¼è»¢è·ï¼ä»•äº‹é‹ï¼æ˜‡æ ¼ï¼‰ã€‚
    </div>
    <div class="flex small" style="margin-top:8px;flex-wrap:wrap">
      <label><input type="checkbox" class="ft" value="love" checked> æ‹æ„›</label>
      <label><input type="checkbox" class="ft" value="meet" checked> å‡ºä¼šã„</label>
      <label><input type="checkbox" class="ft" value="marry" checked> çµå©š</label>
      <label><input type="checkbox" class="ft" value="move" checked> å¼•è¶Šã—</label>
      <label><input type="checkbox" class="ft" value="job" checked> è»¢è·</label>
      <label><input type="checkbox" class="ft" value="work" checked> ä»•äº‹é‹</label>
      <label><input type="checkbox" class="ft" value="promo" checked> æ˜‡æ ¼</label>
      <button id="applyFilter" style="max-width:140px;margin-left:auto">åæ˜ </button>
    </div>
    <div id="calendar" class="calendar" style="margin-top:10px"></div>
  </div>

  <div class="card small muted">
    <strong>å…è²¬ï¼š</strong>æœ¬ãƒ„ãƒ¼ãƒ«ã¯è‡ªå·±ç†è§£ã¨è¡Œå‹•ã®ãƒ’ãƒ³ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚åŒ»ç™‚ãƒ»æ³•å‹™ãƒ»æŠ•è³‡åˆ¤æ–­ã®ä»£æ›¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æš¦ã‚„æµæ´¾ã«ã‚ˆã‚Šå·®ç•°ãŒå‡ºã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
  </div>
</main>

<script>
/* ========= åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const d2r=d=>d*Math.PI/180, norm360=x=>(x%360+360)%360;
function toDateTZ(dateStr,timeStr,tzHours){
  const [y,m,d]=dateStr.split("-").map(Number);
  let H=12,MIN=0; if(timeStr){const t=timeStr.split(":");H=+t[0];MIN=+t[1];}
  const tz=(tzHours==null||tzHours==="")?-(new Date().getTimezoneOffset()/60):Number(tzHours);
  return new Date(Date.UTC(y,m-1,d,H - tz,MIN));
}
function JD(utc){
  const y=utc.getUTCFullYear(), m=utc.getUTCMonth()+1;
  const D=utc.getUTCDate()+(utc.getUTCHours()+utc.getUTCMinutes()/60)/24;
  let Y=y,M=m; if(M<=2){Y--;M+=12;}
  const A=Math.floor(Y/100), B=2-A+Math.floor(A/4);
  return Math.floor(365.25*(Y+4716))+Math.floor(30.6001*(M+1))+D+B-1524.5;
}
function seedFrom(...xs){
  let s = 1779033703;
  for(const x of xs){
    const str = String(x);
    for(let i=0;i<str.length;i++){
      s = Math.imul(s ^ str.charCodeAt(i), 3432918353);
      s = (s << 13) | (s >>> 19);
    }
  }
  return (s >>> 0);
}
function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function choice(rng, arr){ return arr[Math.floor(rng()*arr.length)] }
function pickN(rng, arr, n){
  const a=[...arr]; const out=[];
  while(out.length < Math.min(n,a.length)){ out.push(a.splice(Math.floor(rng()*a.length),1)[0]); }
  return out;
}
function uniq(arr){ return [...new Set(arr)]; }
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));

/* ========= å®¿æ›œï¼ˆé»„çµŒâ†’27å®¿ï¼‰ ========= */
function moonLon(utc){
  const t=(JD(utc)-2451545)/36525;
  const L0=norm360(218.3164477+481267.88123421*t-0.0015786*t*t+t*t*t/538841-t*t*t*t/65194000);
  const D =norm360(297.8501921+445267.1114034*t-0.0018819*t*t+t*t*t/545868-t*t*t*t/113065000);
  const M =norm360(357.5291092+35999.0502909*t-0.0001536*t*t+t*t*t/24490000);
  const M1=norm360(134.9633964+477198.8675055*t+0.0087414*t*t+t*t*t/69699-t*t*t*t/14712000);
  const F =norm360(93.2720950 +483202.0175233*t-0.0036539*t*t-t*t*t/3526000+t*t*t*t/863310000);
  let lon=L0
    +6.289*Math.sin(d2r(M1))
    +1.274*Math.sin(d2r(2*D-M1))
    +0.658*Math.sin(d2r(2*D))
    +0.214*Math.sin(d2r(2*M1))
    +0.186*Math.sin(d2r(M))
    -0.114*Math.sin(d2r(2*F));
  return norm360(lon);
}
const SHUKU=["è§’æœ¨è›Ÿ","äº¢é‡‘é¾","æ°åœŸè²‰","æˆ¿æ—¥å…","å¿ƒæœˆç‹","å°¾ç«è™","ç®•æ°´è±¹","æ–—æœ¨ç¬","å¥³åœŸè ","è™šæ—¥é¼ ","å±æœˆç‡•","å®¤ç«çŒª","å£æ°´è²","å¥æœ¨ç‹¼","å©é‡‘ç‹—","èƒƒåœŸé›‰","æ˜´æ—¥éµ ","ç•¢æœˆçƒ","è§œç«çŒ´","å‚æ°´çŒ¿","äº•æœ¨çŠ´","é¬¼é‡‘ç¾Š","æŸ³åœŸç","æ˜Ÿæ—¥é¦¬","å¼µæœˆé¹¿","ç¿¼ç«è›‡","è»«æ°´èš“"];
function shukuOf(utc){ const lon=moonLon(utc); const idx=Math.floor(lon/(360/27)); return {name:SHUKU[idx], idx}; }

/* ========= æ•°ç§˜ ========= */
const sumDigits=n=>String(n).split("").reduce((a,b)=>a+Number(b),0);
function reduceNum(n){ if([11,22,33].includes(n))return n; let r=n; while(r>9) r=sumDigits(r); return r; }
const lifePath=(y,m,d)=>{const t=sumDigits(y)+sumDigits(m)+sumDigits(d); return [11,22,33].includes(t)?t:reduceNum(t);};
const birthNumber=d=>([11,22].includes(d)?d:reduceNum(d));
const pYear=(bY,bM,bD,year)=>reduceNum(reduceNum(bM+bD)+reduceNum(year));
const pMonth=(pyear,month)=>reduceNum(pyear+month);
const pDay=(pmonth,day)=>reduceNum(pmonth+day);

/* ===== åå‰ãƒ™ãƒ¼ã‚¹ï¼ˆãƒ­ãƒ¼ãƒå­—æ¨å¥¨ï¼‰ ===== */
const LETTERS={A:1,J:1,S:1,B:2,K:2,T:2,C:3,L:3,U:3,D:4,M:4,V:4,E:5,N:5,W:5,F:6,O:6,X:6,G:7,P:7,Y:7,H:8,Q:8,Z:8,I:9,R:9};
const VOWELS=new Set(["A","E","I","O","U","Y"]);
function nameNumbers(raw){
  if(!raw) return null;
  const s=(raw||"").toUpperCase().replace(/[^A-Z\s]/g,"").trim();
  if(!s) return null;
  const letters=[...s].filter(c=>c>="A"&&c<="Z");
  if(!letters.length) return null;
  const vals=letters.map(c=>LETTERS[c]||0);
  const vowels=letters.filter(c=>VOWELS.has(c)).map(c=>LETTERS[c]);
  const cons=letters.filter(c=>!VOWELS.has(c)).map(c=>LETTERS[c]);
  const expression=reduceNum(vals.reduce((a,b)=>a+b,0));
  const soul= reduceNum((vowels.length?vowels:[0]).reduce((a,b)=>a+b,0));
  const personality= reduceNum((cons.length?cons:[0]).reduce((a,b)=>a+b,0));
  return {expression,soul,personality,raw:s};
}

/* ===== ãƒ”ãƒŠã‚¯ãƒ«ï¼†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ===== */
function pinnacles(by,bm,bd){
  const P1=reduceNum(bm+bd);
  const P2=reduceNum(bd + reduceNum(by));
  const P3=reduceNum(P1+P2);
  const P4=reduceNum(bm + reduceNum(by));
  const C1=reduceNum(Math.abs(bm-bd));
  const C2=reduceNum(Math.abs(reduceNum(by)-bd));
  const C3=reduceNum(Math.abs(C1-C2));
  const C4=reduceNum(Math.abs(bm - reduceNum(by)));
  return {P:[P1,P2,P3,P4], C:[C1,C2,C3,C4]};
}
function pinnacleRanges(lp, birthYear){
  const a=36-lp, b=a+9, c=b+9; // å¹´é½¢
  return [
    {from:0, to:a},
    {from:a, to:b},
    {from:b, to:c},
    {from:c, to:120}
  ].map(r=>({start:birthYear+r.from, end:birthYear+r.to}));
}

/* ========= ãƒ†ã‚­ã‚¹ãƒˆï¼šè¡¨ç¾ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ15+ï¼‰ ========= */
const LP_COPY={
  1:["å‹¢ã„ã¨å…ˆå°åŠ›ã€‚ã‚ãªãŸãŒå§‹ã‚ã‚‹ã¨ç©ºæ°—ãŒå‹•ãã€‚è¿·ã£ãŸã‚‰æœ€åˆã®ä¸€æ­©ã‚’æœ€çŸ­ã§ã€‚","ä¸»å½¹é‹ã€‚æ±ºã‚ã‚‹ãƒ»é€²ã‚ã‚‹ãƒ»çµæœã‚’å‡ºã™ã€ã«å¼·ã„ã€‚"],
  2:["èª¿æ•´ã¨å…±æ„Ÿã€‚äººã®æ°—æŒã¡ã‚’ã»ã©ãæ‰‹ã€‚å½“ãŸã‚Šå‰ã®æ°—é£ã„ãŒæ­¦å™¨ã€‚","ç¸ã‚’ã¤ãªãæ©‹æ¸¡ã—å½¹ã€‚èãåŠ›ãŒäººã‚’æ•‘ã†ã€‚"],
  3:["ç™ºä¿¡ã¨å‰µé€ ã€‚è¨€è‘‰ãƒ»æ˜ åƒãƒ»éŸ³ã®è¡¨ç¾ã§è¼ãã€‚","éŠã³å¿ƒãŒè§£æ±ºç­–ã‚’é€£ã‚Œã¦ãã‚‹ã€‚ã¾ãšå‡ºã™ã€‚"],
  4:["ä»•çµ„ã¿ã¨ä¿¡é ¼ã€‚ç©ã¿ä¸Šã’ã§æˆæœã‚’å›ºå®šã€‚","åœŸå°ã‚’æ•´ãˆãŸã‚‰å‹ã¡ã€‚ä¸å¯§ã•ãŒä¿¡ç”¨ã«ãªã‚‹ã€‚"],
  5:["å¤‰åŒ–ã¨è‡ªç”±ã€‚åˆ·æ–°ãƒ»æ—…ãƒ»æ–°é™³ä»£è¬ãŒæ „é¤Šã€‚","æ ã‚’è¶ŠãˆãŸæ™‚ã«æ‰èƒ½ãŒç‚¹ç«ã™ã‚‹ã€‚"],
  6:["è²¬ä»»ã¨èª¿å’Œã€‚ç¾ã¨ã‚±ã‚¢ã§äººãŒæ•´ã†ã€‚","â€œé¢å€’ã‚’è¦‹ã‚‹â€ãŒé‹ã®ã‚¨ãƒ³ã‚¸ãƒ³ã€‚"],
  7:["æ¢ç©¶ã¨é™ã‘ã•ã€‚æ·±ãå­¦ã¶ã»ã©å…‰ã‚‹ã€‚","çµè«–ã¯å°‘ãªãã¦ã„ã„ã€‚å¿…è¦ãªè¨€è‘‰ã ã‘ã€‚"],
  8:["å®Ÿç¾ã¨çµ±ç‡ã€‚çµæœã‚’ä½œã‚‹å¸ä»¤å¡”ã€‚","æ•°å­—ã§ç¤ºã™ã»ã©è©•ä¾¡ãŒè·³ã­ä¸ŠãŒã‚‹ã€‚"],
  9:["å…±æ„Ÿã¨å¥‰ä»•ã€‚èª°ã‹ã®ç—›ã¿ã‚’æ‹¾ã†ç›®ã€‚","ä¸–ç•Œè¦³ã‚’èªã‚‹ã»ã©ä»²é–“ãŒé›†ã¾ã‚‹ã€‚"],
  11:["ç›´æ„Ÿã¨å•“ç™ºã€‚ã²ã‚‰ã‚ãã‚’æ©‹ã«ã™ã‚‹äººã€‚","â€œãµã£ã¨æ¥ãŸâ€ã‚’å³ãƒ†ã‚¹ãƒˆã€‚"],
  22:["å¤§è¨ˆç”»ã€‚å¤§ããªå™¨ã‚’å½¢ã«ã™ã‚‹åŠ›ã€‚","ç ´ç‰‡ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã»ã©ä¸–ç•ŒãŒåºƒãŒã‚‹ã€‚"],
  33:["ç„¡æ¡ä»¶ã®æ„›ã€‚ç™’ã‚„ã—ã¨èŠ¸è¡“ã®æ‰‹ã€‚","ã‚„ã•ã—ã•ã‚’ä»•çµ„ã¿ã«å¤‰ãˆã‚‹ã¨ç„¡æ•µã€‚"]
};
const SH_COPY={
  "è§’æœ¨è›Ÿ":"ã¯ã˜ã‚ã‚‹å‹‡æ°—ã€‚å°ã•ãç€æ‰‹ãŒå‰ã€‚","äº¢é‡‘é¾":"æ­£ã—ã•ã¨è¨€èªåŒ–ã€‚ç­‹ã®é€šã—æ–¹ãŒéµã€‚",
  "æ°åœŸè²‰":"æ•´ãˆã‚‹æ‰è¦šã€‚æ®µå–ã‚Šå‹ã¡ã€‚","æˆ¿æ—¥å…":"äººæ°—é‹ã€‚è¦‹ã›æ–¹ã§è·³ã­ã‚‹ã€‚",
  "å¿ƒæœˆç‹":"æ„Ÿå—æ€§ã€‚ã‚„ã‚ã‚‰ã‹ãå±Šãã€‚","å°¾ç«è™":"æƒ…ç†±ã§ç‰½å¼•ã€‚ç«åŠ›ã®ä½¿ã„åˆ†ã‘ã€‚",
  "ç®•æ°´è±¹":"ç™ºä¿¡æ‹¡æ•£ã€‚å±Šã‘ã‚‹æŠ€è¡“ã€‚","æ–—æœ¨ç¬":"å …å®Ÿã•ã€‚å®ˆã‚Šã®å¼·ã•ã€‚",
  "å¥³åœŸè ":"è‚²ã¦ã‚‹åŠ›ã€‚æ°—é…ã‚ŠãŒä¾¡å€¤ã€‚","è™šæ—¥é¼ ":"ç©ºå›ã‚Šæ³¨æ„ã€‚è¶³å ´å›ºã‚ã€‚",
  "å±æœˆç‡•":"ã‚¹ãƒ”ãƒ¼ãƒ‰å‹è² ã€‚è»½ã‚„ã‹ã«ã€‚","å®¤ç«çŒª":"ä¿¡ç”¨ã®ç©ã¿ä¸Šã’ã€‚ä¸å¯§ã«é€²ã‚€ã€‚",
  "å£æ°´è²":"è¦‹æŠœãç›®ã€‚å®ˆã‚Šã«å†´ãˆã‚‹ã€‚","å¥æœ¨ç‹¼":"ä¼ç”»ç·¨é›†ã€‚éª¨æ ¼ã¥ãã‚Šã€‚",
  "å©é‡‘ç‹—":"è·äººæ°—è³ªã€‚ãã¡ã‚“ã¨ãŒæ­¦å™¨ã€‚","èƒƒåœŸé›‰":"å®Ÿå‹™åŠ›ã€‚è¡£é£Ÿä½ã«å¼·ã„ã€‚",
  "æ˜´æ—¥éµ ":"ã‚¹ã‚¿ãƒ¼æ€§ã€‚å…‰ã‚’å½“ã¦ã‚‹å ´ã¸ã€‚","ç•¢æœˆçƒ":"ã‚³ãƒ„ã‚³ãƒ„å‹ã€‚ç¶šã‘ã¦å‹ã¤ã€‚",
  "è§œç«çŒ´":"ã“ã¨ã°ã¨æŠ€è¡“ã€‚è§£æã®åˆ‡ã‚Œå‘³ã€‚","å‚æ°´çŒ¿":"çªç ´ã¨æ”¹é©ã€‚æ–°è¦ã§è¼ãã€‚",
  "äº•æœ¨çŠ´":"å­¦ã³ã¨å¿ƒã®ã‚±ã‚¢ã€‚","é¬¼é‡‘ç¾Š":"æ…é‡ã•ã€‚æ·±å‘¼å¸ã§æ•´ãˆã‚‹ã€‚",
  "æŸ³åœŸç":"ã—ãªã‚„ã‹ã•ã€‚å¤‰åŒ–ã«å¼·ã„ã€‚","æ˜Ÿæ—¥é¦¬":"é ãã¸ã€‚æµ·å¤–ã¨ç›¸æ€§è‰¯ã—ã€‚",
  "å¼µæœˆé¹¿":"ä½™è£•ã¨è¦‹ã›æ–¹ã€‚","ç¿¼ç«è›‡":"æˆ¦ç•¥ã®é‹­ã•ã€‚å‹ã¡ç­‹ã‚’èª­ã‚€ã€‚",
  "è»«æ°´èš“":"ã„ã‚„ã—ã¨æ—…ç«‹ã¡ã€‚åŒºåˆ‡ã‚Šã‚’ã¤ã‘ã‚‹ã€‚"
};

const ACTION_WORK=[
  "ä»Šæ—¥ã®æœ€é‡è¦ã‚¿ã‚¹ã‚¯ã‚’1è¡Œã§æ›¸ãå‡ºã™â†’æœä¸€ã§ç€æ‰‹",
  "15åˆ†ã‚¿ã‚¤ãƒãƒ¼Ã—1æœ¬ã ã‘é›†ä¸­ã™ã‚‹",
  "æˆæœã‚’â€œè¦‹ãˆã‚‹åŒ–â€ã—ã¦æå‡ºï¼ˆç”»åƒ/æ•°å€¤/ä¸€æ–‡ï¼‰",
  "ä¸è¦ãªä»•äº‹ã‚’1ã¤ã‚„ã‚ã‚‹å®£è¨€ã‚’ã™ã‚‹",
  "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’1ã¤ã ã‘æœ€æ–°åŒ–",
  "ç· åˆ‡ãƒ»ç›®çš„ãƒ»æˆæœç‰©ã‚’æ–‡ç« ã§ç¢ºèª",
  "æ¬¡ã®äºˆå®šã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å…¥ã‚Œã¦ã‹ã‚‰ä½œæ¥­ã‚’çµ‚ãˆã‚‹",
  "å°æœ¬åŒ–ã§ãã‚‹ä½œæ¥­ã‚’1æœ¬ä½œã‚‹",
  "ã€èª°ã®å½¹ã«ç«‹ã¤ï¼Ÿã€ã‚’ãƒ¡ãƒ¢ã—ã¦ã‹ã‚‰å§‹ã‚ã‚‹",
  "é€±ã®å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’3è¡Œã§æŒ¯ã‚Šè¿”ã‚‹",
  "ææ¡ˆã¯2æŠã§æç¤ºã™ã‚‹",
  "3è¡Œå ±å‘Šï¼ˆã‚„ã£ãŸãƒ»å›°ã‚Šãƒ»æ¬¡ã‚„ã‚‹ï¼‰ã‚’é€ã‚‹",
  "æ•°å­—ï¼ˆä»¶æ•°/æ™‚é–“/é‡‘é¡ï¼‰ã®ã©ã‚Œã‹ã§çµæœã‚’ç¤ºã™",
  "è¿·ã£ãŸã‚‰â€œæœ€åˆã«å°ã•ãã‚„ã‚‹â€ã‚’é¸ã¶",
  "å¾—æ„ãªå‹ã«åå‰ã‚’ã¤ã‘ã¦ä¿å­˜"
];
const ACTION_LIFE=[
  "è¿”ä¿¡ãƒšãƒ¼ã‚¹ã‚’äº‹å‰ã«åˆæ„ã™ã‚‹",
  "æ•£æ­©10åˆ†ã§ãƒ¡ãƒ³ã‚¿ãƒ«ã‚’æ•´ãˆã‚‹",
  "å°±å¯å‰30åˆ†ã¯ç”»é¢ã‚ªãƒ•",
  "æœä¸€æ¯ã®ç™½æ¹¯ã§ãƒªã‚ºãƒ ã‚’ã¤ãã‚‹",
  "é€±ã«1å›ã€äºˆå®šã‚’æ¨ã¦ã‚‹æ™‚é–“ã‚’ã¤ãã‚‹",
  "ã€ã‚ã‚ŠãŒã¨ã†ã€ã‚’1æ—¥1å›è¨€è‘‰ã«ã™ã‚‹",
  "å†™çœŸã‚’æ’®ã£ã¦å°ã•ãªå–œã³ã‚’å¯è¦–åŒ–",
  "ãŠé‡‘ãƒ»æ™‚é–“ãƒ»å®¶äº‹ã®10åˆ†ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆè‡ªåˆ†ä¼šè­°ã§ã‚‚OKï¼‰",
  "æ·±å‘¼å¸5å›â†’è‚©ã®åŠ›ã‚’æŠœã",
  "è€ƒãˆã™ããŸã‚‰â€œä»Šæ—¥ã¯ã‚„ã‚‰ãªã„â€ã®å‹‡æ°—",
  "è²·ã„ç‰©ã¯ãƒªã‚¹ãƒˆåŒ–ã—ã¦ä¸€åº¦ã ã‘",
  "å¸°å®…å¾Œ5åˆ†ã ã‘ç‰‡ã¥ã‘",
  "æœã®å…‰ã‚’æµ´ã³ã‚‹",
  "ä»Šæ—¥ã¯â€œäººã®å¦å®šã‚’ã—ãªã„â€ãƒ‡ãƒ¼ã«ã™ã‚‹",
  "ã‚„ã‚ŠãŸã„ã“ã¨ã‚’3ã¤æ›¸ã„ã¦1ã¤ã ã‘ã‚„ã‚‹"
];

const REL_TONE={
  "å‘½":"ä¼¼ãŸè€…åŒå£«ã§æ·±ãåˆ†ã‹ã‚Šåˆãˆã‚‹ç›¸æ€§ã€‚ä¼¼ã™ãã‚‹ã‚†ãˆã®å¼µã‚Šåˆã„ã¯ã€å½¹å‰²åˆ†æ‹…ã§å›é¿ã€‚",
  "å‹":"è‡ªç„¶ä½“ã§æ”¯ãˆåˆãˆã‚‹ç›¸æ€§ã€‚æ—¥å¸¸ãŒãã®ã¾ã¾æ„›ã«ãªã‚‹ã€‚",
  "æˆ":"æ®µå–ã‚ŠãŒãƒãƒã‚Šç¾å®ŸãŒé€²ã‚€ç›¸æ€§ã€‚å…±åŒä½œæ¥­ã§æ·±ã¾ã‚‹ã€‚",
  "æ „":"ãŠäº’ã„ã‚’å¼•ãä¸Šã’åˆã†è¯ã®ç¸ã€‚è¦‹ã›å ´ãŒã‚ã‚‹ã»ã©åŠ é€Ÿã€‚",
  "å®‰":"å®‰å¿ƒã¨ç™’ã‚„ã—ã®ç›¸æ€§ã€‚ã¬ãã‚‚ã‚Šã¨ç”Ÿæ´»æ„ŸãŒéµã€‚",
  "èƒ":"è‚²ã¡åˆã†ç¸ã€‚ã‚†ã£ãã‚Šã®æ­©ã¿ãŒå¤§ããªå®Ÿã‚Šã«ã€‚",
  "è¡°":"åŠ›ã‚’æŠœãå­¦ã³ã®ç¸ã€‚ç­‰èº«å¤§ã§å‘ãåˆã†ã¨å‘³ã‚ã„æ·±ã„ã€‚",
  "æ¥­":"èª²é¡Œã®ç¸ã€‚å°å‡ºã—ã®æ”¯ãˆåˆã„ãŒæˆé•·ã«å¤‰ã‚ã‚‹ã€‚",
  "å±":"åˆºæ¿€ãŒå¼·ã„ã€‚å¢ƒç•Œç·šã¨ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãŒé•·ç¶šãã®éµã€‚",
  "å£Š":"ä¾¡å€¤è¦³ã®ã‚ºãƒ¬ãŒå‡ºã‚„ã™ã„ã€‚ãƒ«ãƒ¼ãƒ«è¨­è¨ˆã§å®ˆã‚ŠãªãŒã‚‰é€²ã‚€ã€‚"
};
const REL_NAME=["å‘½","å±","å®‰","â€”","å£Š","â€”","â€”","â€”","æ¥­","å‹","â€”","â€”","â€”","æ „","è¡°","â€”","â€”","â€”","æˆ","èƒ","â€”","â€”","å£Š","â€”","å®‰","å±","â€”"];
function relationByDistance(d){
  const base=REL_NAME[d];
  if(base && base!=="â€”") return base;
  if(d===0) return "å‘½";
  if(d===13) return "æ „";
  if(d===14) return "è¡°";
  if(d===4||d===23) return "å£Š";
  if(d===8) return "æ¥­";
  if(d===19) return "èƒ";
  if(d<=2) return "å®‰";
  if(d<=9) return "å‹";
  if(d<=18) return "æˆ";
  return "è¡°";
}
const REL_BASE_SCORE={ "å‘½":85,"æ „":82,"å‹":80,"æˆ":78,"å®‰":76,"èƒ":74,"è¡°":68,"æ¥­":62,"å±":60,"å£Š":55 };
function lpCompatDelta(a,b){ const diff=Math.abs(a-b); if(diff<=1) return +8; if(diff<=3) return +4; if(diff<=5) return 0; return -4; }
function compatScore(rel,lpA,lpB){ const base=REL_BASE_SCORE[rel]??70; const delta=lpCompatDelta(lpA,lpB); return clamp(base+delta,40,99); }

/* ========= è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
function tag(colorClass, text){ return `<span class="tag ${colorClass}">#${text}</span>`; }

/* ========= 1. è¨­è¨ˆå›³ ========= */
function renderDesign(targetPie, targetText, y,m,d, nameInfo, shuku, rng){
  const lp=lifePath(y,m,d), bn=birthNumber(d);
  const KPIs=[
    {k:"Life Path", v:lp},
    {k:"èª•ç”Ÿæ•°", v:bn},
    ...(nameInfo?[
      {k:"Expression", v:nameInfo.expression},
      {k:"Soul Urge", v:nameInfo.soul},
      {k:"Personality", v:nameInfo.personality}
    ]:[])
  ];
  const total=KPIs.length;
  const slice=360/total;
  targetPie.innerHTML = (()=> {
    const vars = [...Array(total)].map((_,i)=>`--${String.fromCharCode(97+i)}:${(i+1)*slice}deg`).join(";");
    const legend = KPIs.map((o,i)=>`<span><i style="background:var(--accent);opacity:${0.6+i*0.1}"></i>${o.k}ï¼š<strong>${o.v}</strong></span>`).join("");
    return `
      <div class="pie" style="${vars}"></div>
      <div class="legend">${legend}</div>`;
  })();

  const lpCopy = choice(rng, LP_COPY[lp]||["ç­‰èº«å¤§ã§ã„ãã»ã©é‹ãŒæ•´ã†ã€‚"]);
  const shCopy = SH_COPY[shuku] || "è‡ªåˆ†ã®ãƒªã‚ºãƒ ã§OKã€‚";
  const oneLiner = `ã€Œ${lp}Ã—${shuku}ã€ï¼š${lpCopy} ${shCopy}`;
  targetText.innerHTML = `
    <p class="lead">ğŸŒŸ ${oneLiner}</p>
    <p><strong>ã„ã¾ã®ã‚ãªãŸã‚’ä¸€è¨€ã§ï¼š</strong> ${lpCopy}</p>
    <p><strong>å‹•ãæ–¹ã®ãƒ’ãƒ³ãƒˆï¼š</strong> ${shCopy}</p>`;
}

/* ========= 2. ã„ã¾ã®å­£ç¯€ï¼ˆã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼‹3è¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ ========= */
function renderSeason(targetSpark, targetText, y,m,d){
  const now=new Date();
  const py=pYear(y,m,d, now.getFullYear());
  const pm=pMonth(py, now.getMonth()+1);
  const pd=pDay(pm, now.getDate());
  // 30æ—¥ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆæ“¬ä¼¼ï¼šå€‹äººæ—¥ã‚’1-9ã§æ­£è¦åŒ–ï¼‰
  const days=30; const values=[...Array(days)].map((_,i)=>((pd+i)%9)+1);
  const w=300,h=60; const step=w/(days-1);
  const points=values.map((v,i)=>`${i*step},${h-(v/9)*h}`).join(" ");
  targetSpark.innerHTML=`
    <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
      <polyline points="${points}" fill="none" stroke="white" stroke-width="2" opacity="0.6"/>
    </svg>
    <div class="small muted">â€»ä»Šæ—¥ã¯å€‹äººæ—¥<strong> ${pd}</strong>ã€‚å³ã¸è¡Œãã»ã©æœªæ¥30æ—¥ã€‚</div>`;

  // 3è¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  const rng=mulberry32(seedFrom("season",y,m,d,py,pm,pd));
  const a1=choice(rng, ACTION_WORK);
  const a2=choice(rng, ACTION_LIFE);
  const a3=choice(rng, ACTION_LIFE.filter(x=>x!==a2));
  targetText.innerHTML=`
    <p><strong>å€‹äººå¹´ï¼š</strong>${py}ã€€<strong>å€‹äººæœˆï¼š</strong>${pm}ã€€<strong>å€‹äººæ—¥ï¼š</strong>${pd}</p>
    <div class="box">
      <p class="lead"><strong>ä»Šæ—¥ã‹ã‚‰ã®3è¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³</strong></p>
      <p>ğŸ’¼ ä»•äº‹ï¼š${a1}</p>
      <p>ğŸ¤ å¯¾äººï¼š${a2}</p>
      <p>ğŸ§˜ è‡ªå·±ã‚±ã‚¢ï¼š${a3}</p>
    </div>`;
}

/* ========= 3. ãƒ”ãƒŠã‚¯ãƒ«ï¼†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ========= */
function renderPinn(targetChart, targetText, y,m,d){
  const lp=lifePath(y,m,d);
  const pin=pinnacles(y,m,d);
  const ranges=pinnacleRanges(lp,y);
  // å°ã•ãªå¹´è¡¨ãƒãƒ¼
  const W=320,H=34; const total=ranges[ranges.length-1].end - ranges[0].start;
  function seg(x){ const w=(x.end-x.start)/total*W; return w; }
  const colors=["#22d3ee","#34d399","#a5b4fc","#60a5fa"];
  let x=0, bars="";
  ranges.forEach((r,i)=>{ const w=seg(r); bars+=`<rect x="${x}" y="4" width="${w}" height="26" rx="6" fill="${colors[i]}"/>`; x+=w; });
  targetChart.innerHTML=`
    <svg width="${W}" height="${H}">${bars}
      <text x="6" y="23" fill="#0b1422" font-size="12">ç¬¬1 P${pin.P[0]} / C${pin.C[0]}</text>
      <text x="${W/3+6}" y="23" fill="#0b1422" font-size="12">ç¬¬2 P${pin.P[1]} / C${pin.C[1]}</text>
      <text x="${(W*2)/3+6}" y="23" fill="#0b1422" font-size="12">ç¬¬3 P${pin.P[2]} / C${pin.C[2]}</text>
    </svg>
    <div class="small muted">ç¬¬1:${ranges[0].start}â€“${ranges[0].end}ï¼ç¬¬2:${ranges[1].start}â€“${ranges[1].end}ï¼ç¬¬3:${ranges[2].start}â€“${ranges[2].end}ï¼ç¬¬4:${ranges[3].start}+ï¼ˆP=ãƒ”ãƒŠã‚¯ãƒ«, C=ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼‰</div>`;

  const phrases={
    1:"å§‹å‹•ãƒ»ä¸»å°ãƒ»æœ€çŸ­ã®ä¸€æ­©ã€‚",
    2:"å”åŠ›ãƒ»èª¿æ•´ãƒ»èãåŠ›ã€‚",
    3:"è¡¨ç¾ãƒ»ç™ºä¿¡ãƒ»éŠã³å¿ƒã€‚",
    4:"åœŸå°ãƒ»ç¶™ç¶šãƒ»ä»•çµ„ã¿åŒ–ã€‚",
    5:"åˆ·æ–°ãƒ»æ—…ãƒ»è‡ªç”±ã€‚",
    6:"ã‚±ã‚¢ãƒ»èª¿å’Œãƒ»è²¬ä»»ã€‚",
    7:"æ¢ç©¶ãƒ»å†…çœãƒ»å°‚é–€æ€§ã€‚",
    8:"å®Ÿç¾ãƒ»äº¤æ¸‰ãƒ»æˆæœã€‚",
    9:"å¥‰ä»•ãƒ»å…±æ„Ÿãƒ»å®Œäº†ã€‚",
    11:"ç›´æ„Ÿãƒ»ã²ã‚‰ã‚ããƒ»å•“ç™ºã€‚",
    22:"å¤§è¨ˆç”»ãƒ»æ§‹ç¯‰ãƒ»ç¤¾ä¼šåŒ–ã€‚",
    33:"ç™’ã‚„ã—ãƒ»èŠ¸è¡“ãƒ»å¥‰ä»•ã€‚"
  };
  function line(idx){ const p=pin.P[idx], c=pin.C[idx]; return `ç¬¬${idx+1}ãƒ”ãƒŠã‚¯ãƒ« ${p}ï¼š${phrases[p]||"ç­‰èº«å¤§ã§"}ï¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ${c}`; }
  targetText.innerHTML=`
    <p class="lead">â›°ï¸ ${line(0)}</p>
    <p>æ™‚æœŸã«åˆã£ãŸå‹•ãæ–¹ã‚’é¸ã¶ã»ã©ã€åŠªåŠ›ã¯æœ€çŸ­è·é›¢ã«ãªã‚Šã¾ã™ã€‚æ€–ãã¦ã‚‚â€œå°ã•ãå‡ºã™â€ã‚’é¸ã¶ã¨ã€æ™¯è‰²ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚</p>
    <p><strong>æ¬¡ã®åˆè¨€è‘‰ï¼š</strong>${phrases[pin.P[1]] || "ä¸å¯§ã«"} â†’ ${phrases[pin.P[2]] || "ç­‰èº«å¤§ã§"}</p>`;
}

/* ========= 5. ãµãŸã‚Šã®å–ã‚Šæ‰±ã„èª¬æ˜æ›¸ ========= */
function compatNarrative(rel,lpA,lpB,shA,shB,rng){
  const tone=REL_TONE[rel]||"";
  const rulesDo=[
    "é€±1å›ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’è¨€è‘‰ã§ä¼ãˆã‚‹",
    "äºˆå®šã®å…±æœ‰ã‚’å…ˆã«ã™ã‚‹ï¼ˆè¿”ä¿¡ãƒšãƒ¼ã‚¹ã®åˆæ„ï¼‰",
    "æœªæ¥ã®è©±ã‚’10åˆ†ã ã‘ã™ã‚‹",
    "å®¶äº‹ãƒ»ãŠé‡‘ãƒ»æ™‚é–“ã®å½¹å‰²ã‚’ãƒ¡ãƒ¢ã«ã™ã‚‹",
    "çŸ­æ™‚é–“ã§ã‚‚ä¼šã†ç¿’æ…£ã‚’ä½œã‚‹",
    "å†™çœŸã‚„ä½œå“ãªã©â€œè¦‹ãˆã‚‹æ€ã„å‡ºâ€ã‚’æ®‹ã™",
    "ãŠäº’ã„ã®ä¸€äººæ™‚é–“ã‚’ç¢ºä¿ã™ã‚‹"
  ];
  const rulesDont=[
    "æ„Ÿæƒ…ã®ã¾ã¾ã«é•·æ–‡ã‚’é€ã‚‹",
    "ç›¸æ‰‹ã®äºˆå®šã«è¸ã¿è¾¼ã¿ã™ãã‚‹",
    "éå»ã®å¤±æ•—ã‚’æ˜ã‚Šè¿”ã™",
    "å³ãƒ¬ã‚¹ã‚’å¼·è¦ã™ã‚‹",
    "â€œå¯Ÿã—ã¦â€ã§ä¼ãˆã‚ˆã†ã¨ã™ã‚‹",
    "ç›¸æ‰‹ä¸­å¿ƒã§è‡ªåˆ†ã‚’ç©ºã«ã™ã‚‹"
  ];
  const d=pickN(rng, rulesDo, 3), nd=pickN(rng, rulesDont, 3);
  return `
    <p class="lead"><strong>é–¢ä¿‚ã®ç©ºæ°—ï¼š</strong>${tone}</p>
    <p>å®¿æ›œã¯ã€Œ${shA}ã€Ã—ã€Œ${shB}ã€ã€æ•°ç§˜ã¯ ${lpA} ã¨ ${lpB} ã®çµ„ã¿åˆã‚ã›ã€‚ä¼¼ã¦ã„ã‚‹æ‰€ã¯å¼·ã¿ã«ãªã‚Šã€é•ã„ã¯ãƒ«ãƒ¼ãƒ«ã§å®ˆã‚Œã¾ã™ã€‚</p>
    <div class="box">
      <p><strong>ã‚„ã‚‹ã“ã¨3ã¤ï¼š</strong>â‘ ${d[0]}ã€€â‘¡${d[1]}ã€€â‘¢${d[2]}</p>
      <p><strong>ã‚„ã‚‰ãªã„ã“ã¨3ã¤ï¼š</strong>â‘ ${nd[0]}ã€€â‘¡${nd[1]}ã€€â‘¢${nd[2]}</p>
    </div>`;
}
function renderCompat(target, y,m,d, shA, lpA, tzSel){
  const rng=mulberry32(seedFrom("compat",y,m,d,shA.idx));
  const dB=document.getElementById("birthB").value;
  if(!dB){ target.innerHTML=`<p class="muted">ç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥ã‚’å…¥ã‚Œã‚‹ã¨ã€å®¿æ›œÃ—æ•°ç§˜ã®ç›¸æ€§ï¼ˆã‚¹ã‚³ã‚¢ã¨é•·æ–‡ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>`; return; }
  const utcB=toDateTZ(dB, document.getElementById("timeB").value||"", tzSel);
  const lpB=lifePath(utcB.getUTCFullYear(),utcB.getUTCMonth()+1,utcB.getUTCDate());
  const shB=shukuOf(utcB);
  const N=27, cw=(shB.idx-shA.idx+N)%N, ccw=(shA.idx-shB.idx+N)%N, dist=Math.min(cw,ccw);
  const rel=relationByDistance(dist);
  const score=compatScore(rel,lpA,lpB);
  target.innerHTML=`
    <div class="row">
      <div class="box"><strong>ã‚ãªãŸ</strong><br>æœ¬å‘½å®¿ï¼š${shA.name}ï¼æ•°ç§˜ï¼š${lpA}</div>
      <div class="box"><strong>ãŠç›¸æ‰‹</strong><br>æœ¬å‘½å®¿ï¼š${shB.name}ï¼æ•°ç§˜ï¼š${lpB}</div>
    </div>
    <p class="lead">æ‹æ„›ç›¸æ€§ï¼ˆå®¿æ›œÃ—æ•°ç§˜ï¼‰ï¼š<strong>${score}/100</strong>ï½œé–¢ä¿‚åï¼š<strong>${rel}</strong></p>
    ${compatNarrative(rel,lpA,lpB,shA.name,shB.name,rng)}`;
}

/* ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ36ãƒ¶æœˆï¼‰ ========= */
function monthLabels(pm,shuku){
  const tags=[];
  const add=(l,cls)=>{ if(tags.length<3) tags.push([l,cls]); };
  if(pm===6) add("çµå©šã®è©±ãŒé€²ã¿ã‚„ã™ã„","t-marry");
  if(pm===8) add("æ˜‡æ ¼ãƒ»äº¤æ¸‰ã®è¿½ã„é¢¨","t-promo");
  if(pm===1||pm===5||pm===8) add("è»¢è·ãƒ»æŒ‘æˆ¦ã«è¿½ã„é¢¨","t-job");
  if(pm===2||pm===6) add("æ‹æ„›ãŒè‚²ã¡ã‚„ã™ã„","t-love");
  if([1,3,5].includes(pm)) add("å‡ºä¼šã„ã®ãƒãƒ£ãƒ³ã‚¹","t-meet");
  if(pm===5) add("å¼•è¶Šã—ã®è¿½ã„é¢¨","t-move");
  if(tags.length<3 && (pm===3||pm===4||pm===8)) add("ä»•äº‹é‹ï¼šæˆæœã«çµã³ã¤ãæœˆ","t-work");
  const goodS=["è§’æœ¨è›Ÿ","æˆ¿æ—¥å…","å°¾ç«è™","ç®•æ°´è±¹","æ˜´æ—¥éµ ","å¼µæœˆé¹¿","ç¿¼ç«è›‡","å¥æœ¨ç‹¼","å®¤ç«çŒª","æ˜Ÿæ—¥é¦¬","è»«æ°´èš“"];
  const warnS=["è™šæ—¥é¼ ","é¬¼é‡‘ç¾Š"];
  if(tags.length<3 && goodS.includes(shuku)) add("å®¿æ›œã®è¿½ã„é¢¨","t-meet");
  if(tags.length<3 && warnS.includes(shuku)) add("å°‘ã—æ…é‡ã«è¨ˆç”»ã‚’","t-work");
  return tags;
}
function renderCalendar(root,by,bm,bd,shuku,months=36,filters){
  root.innerHTML="";
  const now=new Date();
  const start=new Date(Date.UTC(now.getFullYear(),now.getMonth(),1));
  for(let i=0;i<months;i++){
    const d=new Date(Date.UTC(start.getUTCFullYear(),start.getUTCMonth()+i,1));
    const py=pYear(by,bm,bd,d.getUTCFullYear()), pm=pMonth(py,d.getUTCMonth()+1);
    let tags=monthLabels(pm,shuku).filter(([label,cls])=>(
      (cls==="t-love" && filters.love) ||
      (cls==="t-meet" && filters.meet) ||
      (cls==="t-marry" && filters.marry) ||
      (cls==="t-move" && filters.move) ||
      (cls==="t-job" && filters.job) ||
      (cls==="t-work" && filters.work) ||
      (cls==="t-promo" && filters.promo)
    ));
    const box=document.createElement("div");
    const isNow = (d.getUTCFullYear()===now.getFullYear() && d.getUTCMonth()===now.getMonth());
    box.className="mon"+(isNow?" now":"");
    box.innerHTML=`<div class="head"><strong>ğŸ“… ${d.getUTCFullYear()}å¹´${d.getUTCMonth()+1}æœˆ</strong><span class="pill">å€‹äººæœˆ ${pm}</span></div>
      <div class="tags">${tags.map(t=>`<span class="tag ${t[1]}">#${t[0]}</span>`).join("")||'<span class="small muted">#æº–å‚™ãƒ»ä¼‘æ¯ã«è‰¯ã„æœˆ</span>'}</div>`;
    root.appendChild(box);
  }
}

/* ========= ãƒ¡ã‚¤ãƒ³å‡¦ç† ========= */
let variantOffset = 0;
function runAll(changeOnlyCopy=false){
  const dA=document.getElementById("birthA").value;
  if(!dA){alert("ã‚ãªãŸã®ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  const tzSel=document.getElementById("tz").value||"";
  const utcA=toDateTZ(dA, document.getElementById("timeA").value||"", tzSel);
  const y=utcA.getUTCFullYear(), m=utcA.getUTCMonth()+1, d=utcA.getUTCDate();
  const shA=shukuOf(utcA), lpA=lifePath(y,m,d), bn=birthNumber(d);

  // åå‰ï¼ˆä»»æ„ï¼‰
  const nm=document.getElementById("nameA").value||"";
  const nameInfo=nameNumbers(nm);
  document.getElementById("nameBad").style.display = (nm && !nameInfo) ? "inline" : "none";

  // KPI
  document.getElementById("lifePath").textContent=lpA;
  document.getElementById("birthNum").textContent=bn;
  document.getElementById("shukuA").textContent=shA.name;
  document.getElementById("pyear").textContent=pYear(y,m,d,(new Date()).getFullYear());

  // è¡¨ç¾ã ã‘ãƒ©ãƒ³ãƒ€ãƒ åŒ–ãƒˆã‚°ãƒ«
  if(!changeOnlyCopy) variantOffset=0; else variantOffset++;
  const rng=mulberry32(seedFrom(y,m,d,shA.idx,variantOffset));

  // 1. è¨­è¨ˆå›³
  renderDesign(document.getElementById("designPie"), document.getElementById("designText"), y,m,d, nameInfo, shA.name, rng);

  // 2. ã„ã¾ã®å­£ç¯€
  renderSeason(document.getElementById("spark"), document.getElementById("seasonText"), y,m,d);

  // 3. ãƒ”ãƒŠã‚¯ãƒ«
  renderPinn(document.getElementById("pinnChart"), document.getElementById("pinnText"), y,m,d);

  // 5. ç›¸æ€§
  renderCompat(document.getElementById("compat"), y,m,d, shA, lpA, tzSel);

  // 36ãƒ¶æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  const filters={}; document.querySelectorAll(".ft").forEach(cb=>filters[cb.value]=cb.checked);
  renderCalendar(document.getElementById("calendar"), y,m,d, shA.name, 36, filters);
}

/* ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ */
document.getElementById("run").addEventListener("click", ()=>runAll(false));
document.getElementById("shuffle").addEventListener("click", ()=>runAll(true));
document.getElementById("applyFilter").addEventListener("click", ()=>runAll(true));
</script>
</body>
</html>
