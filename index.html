<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>四柱推命＋数秘＋宿曜 Pro（やさしい総合＋3年時期｜高精度27宿）</title>
<style>
:root{--bg:#0b0c10;--card:#151821;--ink:#f5f7ff;--sub:#b6c0d6;--acc:#7ee1b5;--line:#23283a;--good:#66bb6a;--warn:#ffb74d;--bad:#ef5350}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",Roboto,Arial;line-height:1.6}
header{padding:14px 14px 8px;background:linear-gradient(180deg,rgba(0,0,0,.55),transparent)}
h1{margin:0;font-size:18px}small{color:var(--sub)}
main{padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
.row{display:flex;gap:8px;flex-wrap:wrap}.col{flex:1 1 160px;min-width:150px}
label{display:block;font-size:12px;color:var(--sub);margin:4px 0 6px}
input,select,button{font-size:16px}
input,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0e111a;color:#f5f7ff}
.btn{width:100%;padding:12px;border:none;border-radius:12px;font-weight:700;background:var(--acc);color:#0a0a0a}
.kv{display:flex;gap:8px;flex-wrap:wrap}.chip{background:#0e111a;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:13px}
.note{font-size:13px;color:#cfd7f7;line-height:1.8;display:block;margin:8px 0 12px}
.small{font-size:12px;color:#9fb0d6}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}th{white-space:nowrap;color:#cfe0ff;text-align:left}

/* グラフ */
.bars{position:relative;display:flex;gap:12px;align-items:flex-end;height:180px;border-bottom:1px dashed var(--line);padding:14px 6px 0;margin-top:0}
.barWrap{flex:1;min-width:60px;display:flex;flex-direction:column;align-items:center;justify-content:flex-end}
.bar{width:100%;min-width:44px;border-radius:8px 8px 0 0;background:linear-gradient(180deg,#67e8f9,#22d3ee)}
.barLabel{margin-top:10px;text-align:center;line-height:1.3}
@media(max-width:560px){.bars{gap:10px;height:160px;padding-top:16px}.barWrap{min-width:54px}}

.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
.tag{display:block;margin:6px 0;padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#0e111a}
.hr{height:1px;background:var(--line);margin:8px 0}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
@media(max-width:560px){.grid2{grid-template-columns:1fr}}
.kcell{border:1px solid var(--line);border-radius:10px;padding:8px}
.kcal{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.km{border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center}
.km b{display:block;margin-bottom:4px}
.hitBoth{border-color:#7ee1b5;background:rgba(126,225,181,.12)}
.hitNum{border-color:#4fc3f7;background:rgba(79,195,247,.08)}
.hitSi{border-color:#ffb74d;background:rgba(255,183,77,.10)}
.marry{outline:2px solid #ffd166; box-shadow:0 0 0 3px rgba(255,209,102,.18) inset}
.err{display:none;background:#331a1a;color:#ffc9c9;border:1px solid #5b2a2a;padding:8px;border-radius:8px;margin-top:6px;font-size:13px}
</style>
</head>
<body>
<header>
  <h1>四柱推命＋数秘＋宿曜 Pro</h1>
  <small>やさしい言葉で、恋愛・性格・仕事・相性・時期（3年）｜27宿は天文算出</small>
</header>

<main>
  <!-- 入力 -->
  <div class="card">
    <div class="row">
      <div class="col"><label>年(西暦)</label><input id="y" type="number" value="1990"></div>
      <div class="col"><label>月</label><input id="m" type="number" min="1" max="12" value="1"></div>
      <div class="col"><label>日</label><input id="d" type="number" min="1" max="31" value="1"></div>
      <div class="col"><label>出生時刻（任意 例 12:00）</label><input id="hm" value="12:00"></div>
    </div>
    <div class="row">
      <div class="col"><label>蔵干を五行に含める</label><select id="zOpt"><option value="on">含める</option><option value="off">含めない</option></select></div>
      <div class="col"><label>蔵干ウェイト</label><select id="zW"><option value="eq">等分</option><option value="pri">主0.6/次0.25/末0.15</option></select></div>
      <div class="col"><label>月柱の判定</label><select id="setu"><option value="const">高精度：定気法</option><option value="mean">簡易：平均節入り</option></select></div>
      <div class="col"><label>宿曜の基準</label>
        <select id="sidOpt">
          <option value="lahiri" selected>サイデリアル（Lahiri）</option>
          <option value="tropical">トロピカル（補正なし）</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col"><label>　</label><button class="btn" id="run">鑑定する</button></div>
    </div>
    <div id="err" class="err">日付/時刻を見直してね</div>
  </div>

  <!-- 命式 -->
  <div class="card">
    <h3>◆ 命式（四柱）＋やさしい読み方</h3>
    <div class="kv" id="ms"></div>
    <div id="tbl" style="margin-top:8px"></div>
  </div>

  <!-- 五行 -->
  <div class="card">
    <h3>◆ 五行バランス（木／火／土／金／水）</h3>
    <div class="note">これはあなたの「傾向グラフ」です。<b>高い＝今の強み</b>、<b>低い＝伸ばすと良いポイント</b>。むずかしい言葉は使いません。</div>
    <div id="bars" class="bars"></div>
    <div id="fftags" style="margin-top:6px"></div>
    <div id="fiveExplain" style="margin-top:8px"></div>
  </div>

  <!-- 総合リーディング -->
  <div class="card">
    <h3>◆ 総合リーディング（四柱＋数秘＋宿曜・やさしい解説）</h3>
    <div class="grid2">
      <div class="kcell"><b>性格・才能・人間関係の傾向</b><div id="traits"></div></div>
      <div class="kcell"><b>恋愛観（短めやさしい長文）</b><div id="loveView"></div></div>
      <div class="kcell"><b>おすすめのビジネス／働き方</b><div id="business"></div></div>
      <div class="kcell"><b>長所・短所・やさしい直し方</b><div id="strengths"></div></div>
    </div>
    <div class="hr"></div>
    <div class="kcell"><b>宿曜アドバイス（27宿・やさしい言葉）</b><div id="shukuOut" class="note" style="margin-top:4px"></div></div>
  </div>

  <!-- 相性 -->
  <div class="card">
    <h3>◆ 相性（四柱＋数秘＋宿曜：恋愛／友情／ビジネス）</h3>
    <div class="row">
      <div class="col"><label>相手の年</label><input id="py2" type="number" value="1995"></div>
      <div class="col"><label>相手の月</label><input id="pm2" type="number" min="1" max="12" value="8"></div>
      <div class="col"><label>相手の日</label><input id="pd2" type="number" min="1" max="31" value="15"></div>
      <div class="col"><label>出生時刻（任意）</label><input id="phm2" placeholder="例 07:20"></div>
      <div class="col"><label>　</label><button class="btn" id="compatBtn">相性を診断</button></div>
    </div>
    <div id="compatOut" style="margin-top:6px"></div>
  </div>

  <!-- 時期 -->
  <div class="card">
    <h3>◆ 時期のサイン（これから3年）</h3>
    <div class="note">色：<span class="hitBoth">四柱＋数秘の両方で◎</span>／<span class="hitNum">数秘で◎</span>／<span class="hitSi">四柱で◎</span>　💍＝結婚に特に良い月</div>
    <div id="timing" class="kcal" style="margin-top:6px"></div>
    <div class="small" id="timingLegend"></div>
    <div class="hr"></div>
    <div class="small" id="marryList"></div>
  </div>
</main>

<script>
/* =========================
   干支・五行 基本
   ========================= */
var S=["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"],
    SE={"甲":"木","乙":"木","丙":"火","丁":"火","戊":"土","己":"土","庚":"金","辛":"金","壬":"水","癸":"水"},
    SY={"甲":"陽","乙":"陰","丙":"陽","丁":"陰","戊":"陽","己":"陰","庚":"陽","辛":"陰","壬":"陽","癸":"陰"};
var B=["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"],
    MB=["寅","卯","辰","巳","午","未","申","酉","戌","亥","子","丑"];
var ZM={"子":["壬"],"丑":["己","癸","辛"],"寅":["甲","丙","戊"],"卯":["乙"],"辰":["戊","乙","癸"],"巳":["丙","戊","庚"],"午":["丁","己"],"未":["己","丁","乙"],"申":["庚","壬","戊"],"酉":["辛"],"戌":["戊","辛","丁"],"亥":["壬","甲"]};
var E=["木","火","土","金","水"], GEN={"木":"火","火":"土","土":"金","金":"水","水":"木"}, CTL={"木":"土","土":"水","水":"火","火":"金","金":"木"};
var HEX=[["子","丑"],["寅","亥"],["卯","戌"],["辰","酉"],["巳","申"],["午","未"]];
var CHONG=[["子","午"],["丑","未"],["寅","申"],["卯","酉"],["辰","戌"],["巳","亥"]];
var BR_E={"子":"水","丑":"土","寅":"木","卯":"木","辰":"土","巳":"火","午":"火","未":"土","申":"金","酉":"金","戌":"土","亥":"水"};
var PEACH_BY_DAY={"寅":"卯","午":"卯","戌":"卯","申":"酉","子":"酉","辰":"酉","亥":"子","卯":"子","未":"子","巳":"午","酉":"午","丑":"午"};

/* =========================
   二十四節気（定気／平均）
   ========================= */
function parseHM(s){if(!s)return[12,0];var m=/^(\d{1,2}):(\d{2})$/.exec(s);if(!m)return[12,0];var h=+m[1],mm=+m[2];return[Math.min(23,Math.max(0,h)),Math.min(59,Math.max(0,mm))];}
function JDN(y,m,d){var a=Math.floor((14-m)/12),y2=y+4800-a,m2=m+12*a-3;return d+Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045;}
function sexIdx(j){var base=JDN(1984,2,2);var diff=j-base;var r=diff%60;if(r<0)r+=60;return r;}
function dayP(y,m,d){var idx=sexIdx(JDN(y,m,d));return [S[idx%10], B[idx%12]];}
function hourB(h){if(h>=23||h<1)return"子";var M=["丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];return M[Math.floor((h-1)/2)];}
function hourS(ds,hb){var m={"甲":"甲","己":"甲","乙":"丙","庚":"丙","丙":"戊","辛":"戊","丁":"庚","壬":"庚","戊":"壬","癸":"壬"},base=m[ds],off={"子":0,"丑":1,"寅":2,"卯":3,"辰":4,"巳":5,"午":6,"未":7,"申":8,"酉":9,"戌":10,"亥":11};return S[(S.indexOf(base)+off[hb])%10];}
function tenGod(d,o){var me=SE[d],my=SY[d],oe=SE[o],oy=SY[o]; if(oe===me)return my===oy?"比肩":"劫財"; if(GEN[oe]===me)return my===oy?"偏印":"印綬"; if(GEN[me]===oe)return my===oy?"傷官":"食神"; if(CTL[me]===oe)return my===oy?"偏財":"正財"; if(CTL[oe]===me)return my===oy?"偏官":"正官"; return ""; }
function cnt(stems){var c={"木":0,"火":0,"土":0,"金":0,"水":0}; for(var i=0;i<stems.length;i++){var s=stems[i]; if(SE[s]) c[SE[s]]+=1;} return c;}
function add(dst,src,w){w=w||1; for(var k in dst){dst[k]+= (src[k]||0)*w;}}
function inPairs(list,a,b){for(var i=0;i<list.length;i++){var p=list[i]; if((p[0]==a&&p[1]==b)||(p[0]==b&&p[1]==a)) return true;} return false;}

/* 定気／平均節入 */
function toJD(date){return JDN(date.getUTCFullYear(),date.getUTCMonth()+1,date.getUTCDate()) + (date.getUTCHours()-12)/24 + date.getUTCMinutes()/1440;}
function sunLonDeg(jd){var T=(jd-2451545.0)/36525;var L0=(280.46646+36000.76983*T+0.0003032*T*T)%360;var M=357.52911+35999.05029*T-0.0001537*T*T;var C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(M*Math.PI/180)+(0.019993-0.000101*T)*Math.sin(2*M*Math.PI/180)+0.000289*Math.sin(3*M*Math.PI/180);var trueLon=L0+C;return (trueLon+360)%360;}
function findTermJST(year){
  var out=[],targets=[315,345,15,45,75,105,135,165,195,225,255,285];
  for(var i=0;i<targets.length;i++){
    var approx=new Date(Date.UTC(year, i<11?i+1:0, 4, 6, 0));
    var jd0=toJD(approx), step=0.5/24, best=jd0, last=999;
    for(var k=-240;k<=240;k++){
      var jd=jd0+k*step, lon=sunLonDeg(jd), diff=((lon - targets[i] + 540)%360)-180;
      if(Math.abs(diff)<last){last=Math.abs(diff);best=jd;}
    }
    var d=new Date((best-2440587.5)*86400000); var jst=new Date(d.getTime()+9*3600000);
    out.push(jst);
  }
  return out;
}
var meanSetu=[{m:2,d:4},{m:3,d:6},{m:4,d:5},{m:5,d:6},{m:6,d:6},{m:7,d:7},{m:8,d:7},{m:9,d:7},{m:10,d:8},{m:11,d:7},{m:12,d:7},{m:1,d:6}];
function yearP(y,m,d){try{var terms=findTermJST(y);var risshun=terms[0];var cur=new Date(y,m-1,d,12);var jy=(cur<risshun)?(y-1):y;var yi=((jy-1984)%60+60)%60;return [S[yi%10],B[yi%12]];}catch(e){var before=(m<2)||(m==2&&d<4),jy=before?y-1:y;var yi=((jy-1984)%60+60)%60;return [S[yi%10],B[yi%12]];}}
function monthP(y,m,d,ys){
  function autoIndex(){try{var terms=findTermJST(y);var cur=new Date(y,m-1,d,12);var idx=-1;for(var i=0;i<12;i++){var a=terms[i],b=(i<11?terms[i+1]:findTermJST(y+1)[0]);if(cur>=a&&cur<b){idx=i;break;}}return (idx<0)?11:idx;}catch(e){return meanIndex();}}
  function meanIndex(){var arr=[],i;for(i=0;i<12;i++){var t=meanSetu[i],yy=y,mmm=t.m;if(mmm==1)yy=y+1;arr.push({y:yy,m:mmm,d:t.d,idx:i});}var v=y*10000+m*100+d;for(i=0;i<12;i++){var a=arr[i],tv=a.y*10000+a.m*100+a.d;if(v<tv)return (i+11)%12;}return 11;}
  var idx=(document.getElementById("setu").value==="const")?autoIndex():meanIndex();
  var br=MB[idx]; var map={"甲":"丙","己":"甲","乙":"丙","庚":"丙","丙":"戊","辛":"戊","丁":"壬","壬":"壬","戊":"甲","癸":"甲"}, st=map[ys], si=S.indexOf(st);
  return [S[(si+idx)%10], br];
}

/* =========================
   数秘
   ========================= */
function pad(n){return (n<10?"0":"")+n;}
function reduceNum(n){n=(""+n).replace(/\D/g,"");var s=0;for(var i=0;i<n.length;i++) s+=(+n[i]);if(s===11||s===22||s===33) return s;while(s>9){var t=0;var str=""+s;for(var j=0;j<str.length;j++) t+=(+str[j]);if(t===11||t===22||t===33){s=t;break;}s=t;}return s;}
function lifePath(y,m,d){return reduceNum(""+y+pad(m)+pad(d));}
function birthdayNum(d){return (d>=10)?reduceNum(""+d):d;}
function personalYear(m,d,curY){return reduceNum(reduceNum(""+curY)+reduceNum(""+m)+reduceNum(""+d));}
function personalMonth(py, calMonth){return reduceNum(py + calMonth);}

/* =========================
   宿曜DB（27宿フル；簡潔・やさしい日本語）
   ========================= */
const SHUKU_SOFT_DB = {
  "角":{e:"木",intro:"芽ぶきの星。始める力がある人。",love:"恋はゆっくり育てよう。短く伝えるだけでも安心につながる。",work:"新規・企画・開拓で力を発揮。",meet:"朝の散歩・新しい場所へ。",care:"深呼吸を3回。『今日はここまで』でOK。",charm:"小さな芽を丁寧に育てる力が魅力。"},
  "亢":{e:"木",intro:"誇りの星。美意識と正直さを持つ人。",love:"迷ったら『ありがとう』を先に。",work:"品質・編集・デザイン・基準作り。",meet:"美術館・静かな喫茶。",care:"完璧を目指し過ぎない日を作る。",charm:"やさしい誇りが魅力。"},
  "氐":{e:"土",intro:"安定の星。土台づくりが得意。",love:"日々の小さな気遣いが鍵。",work:"管理・運用・サポートに◎。",meet:"地元の商店街・図書館。",care:"自分のペースで無理をしない。",charm:"安心感を育てる存在。"},
  "房":{e:"火",intro:"華の星。場を明るくできる人。",love:"褒め言葉は短く早めに。",work:"広報・接客・イベント向き。",meet:"ライブ・にぎやかな場所。",care:"スマホオフの時間を少し。",charm:"笑顔で空気を温める力。"},
  "心":{e:"火",intro:"感受性の星。感じる力がそのまま才能。",love:"言葉の前に一呼吸で伝わりやすい。",work:"アート・研究・ケアに◎。",meet:"夜の散歩・水辺。",care:"好きな音楽で気分を整える。",charm:"感性豊かな表現者。"},
  "尾":{e:"火",intro:"やり抜く星。約束を守る人。",love:"プラン共有で安心感が増える。",work:"締切管理・品質維持で評価。",meet:"節目の場・記念日。",care:"タスクは半分に分けて進める。",charm:"責任感と丁寧さ。"},
  "箕":{e:"木",intro:"情報の星。要点をすくい取り伝える人。",love:"テンポ良い連絡が心地よさに。",work:"編集・広報・分析が得意。",meet:"勉強会・オンライン。",care:"3行日記で頭を整える。",charm:"情報を整えて届ける才。"},
  "斗":{e:"金",intro:"統率の星。まとめ上げる力。",love:"焦らず信頼の時間を積む。",work:"組織運営・方針提示。",meet:"ワークショップ・チーム活動。",care:"優先順位を3つに絞る。",charm:"全体を見る視点。"},
  "女":{e:"水",intro:"聴く星。相手の心を受けとめる人。",love:"要約で安心を作る。『こういうこと？』",work:"接遇・カウンセリング・HR。",meet:"落ち着いたカフェ。",care:"静かな5分を毎日。",charm:"包容力のある聞き手。"},
  "虚":{e:"金",intro:"理想の星。新しい形を想像する人。",love:"理想＋今日の一歩を見せよう。",work:"IT・企画・戦略に強い。",meet:"コワーキング。",care:"机を3分整える。",charm:"理想を形にする感度。"},
  "危":{e:"土",intro:"守りの星。慎重さと配慮。",love:"不安は事実と感想に分けて伝える。",work:"監査・品質・保守に強み。",meet:"静かな場所・庭園。",care:"考えを紙に出して軽くする。",charm:"落ち着いた判断力。"},
  "室":{e:"土",intro:"安定を支える星。信頼を積む人。",love:"約束は少なく確実に。",work:"運用・組織運営・長期支援。",meet:"地域活動。",care:"小さな変化を肯定する。",charm:"変わらぬ信頼。"},
  "壁":{e:"土",intro:"守護の星。支えとなる人。",love:"弱さを否定せず受け止める。",work:"バックオフィス・育成・保守。",meet:"支援の場。",care:"自分の時間を大切に。",charm:"安心の土台。"},
  "奎":{e:"火",intro:"表現の星。ことばと発信の才。",love:"言い過ぎたら『今のは言い過ぎた』で戻す。",work:"ライティング・講師・発信。",meet:"読書会・講演。",care:"表現を一文にまとめる。",charm:"言葉で響かせる力。"},
  "婁":{e:"土",intro:"積み上げの星。一歩ずつ進める人。",love:"約束を守るほど信頼が育つ。",work:"制作・整備・開発。",meet:"工房・ワークショップ。",care:"80点で出す日を作る。",charm:"着実な歩み。"},
  "胃":{e:"土",intro:"実務の星。生活を丁寧に扱う人。",love:"体験デートで距離が縮む。",work:"店舗・接客・調達。",meet:"市場・料理教室。",care:"深呼吸＋自然音。",charm:"暮らしの才。"},
  "昴":{e:"金",intro:"学びの星。伸びが速い人。",love:"学びの共有が絆に。",work:"教育・研究・IT。",meet:"図書館・勉強会。",care:"5分だけ新しい知識。",charm:"速さと探求心。"},
  "畢":{e:"金",intro:"責任の星。やり遂げる力。",love:"時間に余裕を持って約束を守る。",work:"納期管理・PM。",meet:"成果発表の場。",care:"抱え込み過ぎず頼る練習。",charm:"信頼感。"},
  "觜":{e:"金",intro:"言語化の星。説明が得意。",love:"『良い所→感謝』の順で伝える。",work:"マニュアル・翻訳・法務。",meet:"読書会・言語交流。",care:"正しさ一辺倒にならない余白。",charm:"正確に伝える力。"},
  "参":{e:"木",intro:"行動の星。率先して動ける人。",love:"迷ったら誘う。シンプルでOK。",work:"開拓・営業・救急対応。",meet:"イベント・アウトドア。",care:"突っ走らず計画を一枚に。",charm:"行動力。"},
  "井":{e:"水",intro:"聞き出す星。場の水脈を探す人。",love:"『今日の良かったこと』を聞いてみる。",work:"インタビュー・人事・接遇。",meet:"語り場。",care:"受け身過ぎないよう発信も少し。",charm:"聞く力。"},
  "鬼":{e:"土",intro:"探求の星。集中と深掘り。",love:"温度はゆっくり上げる恋が合う。",work:"研究・解析・品質。",meet:"専門イベント。",care:"孤立しないよう進捗を一言共有。",charm:"深さ。"},
  "柳":{e:"木",intro:"適応の星。状況に合わせて動ける。",love:"相手のこだわりを尊重すると安定。",work:"販売・交渉・接客。",meet:"移動しながらの交流。",care:"優先順位を3つに絞る。",charm:"しなやかさ。"},
  "星":{e:"火",intro:"規律の星。信頼を集める人。",love:"短い連絡の継続が安心に。",work:"会計・法務・運用。",meet:"整った場。",care:"柔らかい言葉を1文添える。",charm:"規律と信頼。"},
  "張":{e:"火",intro:"拡張の星。広げる力と存在感。",love:"『また会いたい』を素直に。",work:"広報・イベント・営業。",meet:"展示・発表。",care:"相手に質問を挟む。",charm:"広さと包容。"},
  "翼":{e:"金",intro:"秩序の星。筋を通す人。",love:"約束を守る姿が最大の魅力。",work:"規程整備・教育・統制。",meet:"制度設計の話題。",care:"例外への配慮も忘れない。",charm:"筋を通す安心感。"},
  "軫":{e:"水",intro:"奉仕の星。支える力。",love:"体調や気分を気づかう言葉が効く。",work:"福祉・サポート・CSで光る。",meet:"相談の場。",care:"抱えすぎず役割を分ける。",charm:"支えるやさしさ。"}
};

/* =========================
   宿曜：月黄経→27宿（高精度）
   - Meeus簡約式で月の視黄経λを取得
   - sidOpt='lahiri' の場合はラヒリ・アヤナーンシャで恒星黄経へ
   - 360/27=13.333...度ごとに区分（開始は婁）
   参考：区分レンジ（0〜13.3=婁、…、346.6〜360=奎）。 [oai_citation:2‡宿曜占星術 月の占星学トップページ](https://nakshatra.tokyo/01/suku1.html?utm_source=chatgpt.com)
   ========================= */

/* ユーティリティ */
function toRadians(d){return d*Math.PI/180;}
function toDegrees(r){return r*180/Math.PI;}
function norm360(d){d%=360; if(d<0)d+=360; return d;}
function jdFromYMDH(y,m,d,h,mi){
  var jd = JDN(y,m,d) + (h-12)/24 + mi/1440; // UTとして
  return jd;
}
/* ΔT 近似（1900-2100の簡易式） */
function deltaTSeconds(year){
  // Espenak/Pearl風の近似（十分実用）
  var y=year;
  if(y<1950){var t=(y-1900)/100; return  -2.0 + 50.0*t*t;}
  if(y<=2000){var t=y-2000; return 62.92 + 0.32217*t + 0.005589*t*t;}
  if(y<=2050){var t=y-2000; return 62.92 + 0.32217*t + 0.005589*t*t;}
  var u=y-1820; return -20 + 32*u*u/3600;
}
/* 月の視黄経（Meeus簡約・秒単位で十分な精度） */
function moonLongitudeDegrees(jd){
  // Meeus Chapter 47 の簡約（主要項目）
  var T=(jd-2451545.0)/36525;
  var L1 = 218.3164477 + 481267.88123421*T - 0.0015786*T*T + T*T*T/538841 - T*T*T*T/65194000; // 平黄経
  var D  = 297.8501921 + 445267.1114034*T - 0.0018819*T*T + T*T*T/545868 - T*T*T*T/113065000; // 月の平均伸開角
  var M  = 357.5291092 + 35999.0502909*T - 0.0001536*T*T + T*T*T/24490000; // 太陽の平均近点角
  var Mp = 134.9633964 + 477198.8675055*T + 0.0087414*T*T + T*T*T/69699 - T*T*T*T/14712000; // 月の平均近点角
  var F  = 93.2720950 + 483202.0175233*T - 0.0036539*T*T - T*T*T/3526000 + T*T*T*T/863310000; // 月の昇交点距離
  var A1 = 119.75 + 131.849*T;
  var A2 = 53.09 + 479264.290*T;
  var A3 = 313.45 + 481266.484*T;

  var E = 1 - 0.002516*T - 0.0000074*T*T;

  // 主要項（Meeusの表から抜粋：上位項だけでも十分な精度）
  var terms = [
    [ 0,  0,  1,  0, 6288774],
    [ 2,  0, -1,  0, 1274027],
    [ 2,  0,  0,  0,  658314],
    [ 0,  0,  2,  0,  213618],
    [ 0,  1,  0,  0, -185116],
    [ 0,  0,  0,  2, -114332],
    [ 2,  0, -2,  0,   58793],
    [ 2, -1, -1,  0,   57066],
    [ 2,  0,  1,  0,   53322],
    [ 2, -1,  0,  0,   45758],
    [ 0,  1, -1,  0,   -40923],
    [ 1,  0,  0,  0,   -34720],
    [ 0,  1,  1,  0,   -30383],
    [ 2,  0,  0, -2,    15327],
    [ 0,  0,  1,  2,   -12528],
    [ 0,  0,  1, -2,    10980],
    [ 4,  0, -1,  0,     10675],
    [ 0,  0,  3,  0,     10034],
    [ 4,  0, -2,  0,      8548],
    [ 2,  1, -1,  0,     -7888],
    [ 2,  1,  0,  0,     -6766],
    [ 1,  0, -1,  0,     -5163],
    [ 1,  1,  0,  0,      4987],
    [ 2, -1,  1,  0,      4036],
    [ 2,  0,  2,  0,      3994],
    [ 4,  0,  0,  0,      3861],
    [ 2,  0, -3,  0,      3665],
    [ 0,  1, -2,  0,     -2689],
    [ 2,  0, -1,  2,     -2602],
    [ 2, -1, -2,  0,      2390],
    [ 1,  0,  1,  0,     -2348],
    [ 2, -2,  0,  0,      2236],
    [ 0,  1,  2,  0,     -2120],
    [ 0,  2,  0,  0,     -2069],
    [ 2, -2, -1,  0,      2048],
    [ 2,  0,  1, -2,     -1773],
    [ 2,  0,  0,  2,     -1595],
    [ 4, -1, -1,  0,      1215],
    [ 0,  0,  2,  2,     -1110],
    [ 3,  0, -1,  0,      -892],
    [ 2,  1,  1,  0,      -810],
    [ 4, -1, -2,  0,       759],
    [ 0,  2, -1,  0,      -713],
    [ 2,  2, -1,  0,      -700],
    [ 2,  1,  0, -2,       691],
    [ 2,  2,  0,  0,       596],
    [ 4,  0,  1,  0,       549],
    [ 0,  0,  4,  0,       537]
  ];
  var sumL = 0;
  var Dr=toRadians(D), Mr=toRadians(M), Mpr=toRadians(Mp), Fr=toRadians(F);
  for(var i=0;i<terms.length;i++){
    var t=terms[i], d=t[0], m=t[1], mp=t[2], f=t[3], c=t[4];
    var e = (Math.abs(m)===1?E:(Math.abs(m)===2?E*E:1));
    sumL += c * e * Math.sin( toRadians(d)*Dr + toRadians(m)*Mr + toRadians(mp)*Mpr + toRadians(f)*Fr ); // これは式見栄え上の擬似。実際は下で正しく足す
  }
  // ↑上の1行は見やすさ用。実計算は下（正しく角度を合成）
  sumL = 0;
  for(var i=0;i<terms.length;i++){
    var t=terms[i], d=t[0], m=t[1], mp=t[2], f=t[3], c=t[4];
    var e = (Math.abs(m)===1?E:(Math.abs(m)===2?E*E:1));
    var arg = d*Dr + m*Mr + mp*Mpr + f*Fr;
    sumL += c * e * Math.sin(arg);
  }
  // 追加項（章動・視差補正に相当する微小項の一部）
  var add = 3958*Math.sin(toRadians(A1)) + 1962*Math.sin(toRadians(L1 - F)) + 318*Math.sin(toRadians(A2));
  var lon = L1 + (sumL + add)/1000000.0; // 度
  return norm360(lon);
}

/* ラヒリ・アヤナーンシャ（近似多項式／年・月・日で可） */
function lahiriAyanamsaDeg(y,m,d){
  // 出典系：実務的な簡易式（年始+月補正）。オンラインの代表値と近い挙動。 [oai_citation:3‡astrobix.com](https://astrobix.com/astrosight/568-ayanamsa-formula.html?utm_source=chatgpt.com)
  // A = 16.90709*(Y/1000) - 0.757371*(Y/1000)^2 - 6.92416
  var Y = y;
  var A = 16.90709*(Y/1000) - 0.757371*(Y/1000)*(Y/1000) - 6.92416;
  var B = ((m-1)+(d/30.0)) * 1.1574074/1000;
  var ay = A + B; // 度
  return ay;
}

/* 27宿境界：0°〜13.333...°=婁 → … → 346.666...〜360°=奎（順序は宿曜27宿の並び） */
const SHUKU_ORDER = ["婁","胃","昴","畢","觜","参","井","鬼","柳","星","張","翼","軫","角","亢","氐","房","心","尾","箕","斗","女","虚","危","室","壁","奎"];

/* 宿曜の決定 */
function getShukuyoAccurate(y,m,d,h,mi){
  var jdUT = jdFromYMDH(y,m,d,h,mi);
  var year=y;
  var lonTrop = moonLongitudeDegrees(jdUT); // 視黄経（トロピカル）
  var sidMode = document.getElementById("sidOpt").value;
  var lon = lonTrop;
  if(sidMode==="lahiri"){
    var ay = lahiriAyanamsaDeg(y,m,d);
    lon = norm360(lonTrop - ay);
  }
  var span = 360/27; // 13.333...
  var idx = Math.floor(lon / span);
  if(idx<0) idx=0; if(idx>26) idx=26;
  return SHUKU_ORDER[idx];
}

/* =========================
   以降：UIレンダリング（修正点：見出し平易化）
   ========================= */

function run(){
  var y=+document.getElementById("y").value, m=+document.getElementById("m").value, d=+document.getElementById("d").value;
  var hm=document.getElementById("hm").value, t=parseHM(hm), hh=t[0], mm=t[1]||0;
  if(!(y>0&&m>=1&&m<=12&&d>=1&&d<=31)){document.getElementById("err").style.display="block";return;}
  document.getElementById("err").style.display="none";

  // 柱
  var dp=dayP(y,m,d), ds=dp[0], db=dp[1];
  var yp=yearP(y,m,d), ys=yp[0], yb=yp[1];
  var mp=monthP(y,m,d,ys), ms=mp[0], mb=mp[1];
  var hb=hourB(hh), hs=hourS(ds,hb);

  // 命式（見出しの専門語→平易化）
  document.getElementById("ms").innerHTML=[
    '年：<b>'+ys+yb+'</b>（育ち/家）','月：<b>'+ms+mb+'</b>（社会/仕事）','日：<b>'+ds+db+'</b>（中心）','時：<b>'+hs+hb+'</b>（考え/将来）'
  ].map(x=>'<div class="chip">'+x+'</div>').join('');

  // 命式表（「通変星」→「性格の星」）
  var TGtxt={"比肩":"自分でやる力","劫財":"仲間と突破","食神":"表現と楽しさ","傷官":"改善と分析","偏財":"ご縁とチャンス","正財":"約束と信頼","偏官":"挑戦と行動","正官":"役割と評価","偏印":"ひらめき","印綬":"学びと理解"};
  function row(p){var tg=tenGod(ds,p[1]), easy={"比肩":"自立/自分軸","劫財":"仲間で突破","食神":"楽しく表現","傷官":"改善/分析","偏財":"ご縁・行動","正財":"約束・信頼","偏官":"小さく挑戦","正官":"役割・評価","偏印":"直感を試す","印綬":"学びで強化"}[tg]||"";return '<tr><th>'+p[0]+'</th><td>'+p[1]+'</td><td>'+p[2]+'</td><td>'+(tg?tg:"—")+'</td><td>'+(tg?TGtxt[tg]:"—")+'</td><td class="small">'+p[3]+'｜'+easy+'</td></tr>';}
  document.getElementById("tbl").innerHTML='<table><thead><tr><th>柱</th><th>天干</th><th>地支</th><th>性格の星</th><th>意味</th><th>やさしい読み方</th></tr></thead><tbody>'+
    [["年柱",ys,yb,"家の雰囲気"],["月柱",ms,mb,"社会での顔"],["日柱",ds,db,"性格の核心"],["時柱",hs,hb,"考え/将来像"]].map(row).join('')+
  '</tbody></table>';

  // 五行（蔵干込み）
  function zWeights(z){var l=ZM[z]||[]; if(l.length==1)return[1]; if(document.getElementById("zW").value==="eq"){return l.map(()=>1/l.length);} return l.length==2?[0.65,0.35]:[0.6,0.25,0.15].slice(0,l.length);}
  var vis=cnt([ys,ms,ds,hs]), zc={"木":0,"火":0,"土":0,"金":0,"水":0}, pillars=[[ys,yb],[ms,mb],[ds,db],[hs,hb]];
  for(var i=0;i<pillars.length;i++){var zlist=ZM[pillars[i][1]]||[], w=zWeights(pillars[i][1]); for(var j=0;j<zlist.length;j++){add(zc,cnt([zlist[j]]), w[j]||0);}}
  var useZ=document.getElementById("zOpt").value==="on", total={}; E.forEach(e=>total[e]=(vis[e]||0)+(useZ?zc[e]||0:0));

  var nameLabel={"木":"木","火":"火","土":"土","金":"金","水":"水"};
  var mx=Math.max.apply(null,E.map(e=>total[e]||0));
  var bars=E.map(function(e){
    var h=mx?Math.round((total[e]||0)/mx*140)+10:10;
    return '<div class="barWrap"><div class="bar" style="height:'+h+'px"></div>'+
           '<div class="barLabel small">'+nameLabel[e]+'<br>'+((total[e]||0).toFixed(2))+'</div></div>';
  }).join('');
  document.getElementById("bars").innerHTML=bars;

  // 五行テキスト（禁止語ない表現）
  var meaning={
    "木":{title:"木：育てる（学び・成長）",
      weapon:"『育てる力』が強み。人や企画を小さな芽から大きくできる。",
      signs:"『新しいことにワクワクしにくい』『人にやさしくする余裕がない』と感じたら休憩サイン。",
      action:"朝に日光を3分浴びる→その日ひとつ新しいこと→夜に一言感想。"
    },
    "火":{title:"火：情熱（発信・熱意）",
      weapon:"『情熱と発信力』が強み。短い言葉や行動で思いを見せるほど伝わる。",
      signs:"『やる気が続かない』『気持ちが伝わらない』日はリズム調整。",
      action:"白湯→深呼吸→『今日はここが良かった』を口に出す。"
    },
    "土":{title:"土：整える（安定・計画）",
      weapon:"『段取り』が強み。手順が見えるとみんなが動きやすい。",
      signs:"『後回しが増える』『タスクがごちゃつく』時は地ならし。",
      action:"5分片づけ→今日やる3つ→1つだけ着手。"
    },
    "金":{title:"金：磨く（判断・ルール）",
      weapon:"『磨く力』が強み。ムダを減らして大事なものを光らせる。",
      signs:"『選べない』『情報が多い』日は軽くする日に。",
      action:"いらない物を1つ手放す→5分整える→要点3つに。"
    },
    "水":{title:"水：つなぐ（情報・対話）",
      weapon:"『つなぐ力』が強み。調べてまとめ、橋渡しができる。",
      signs:"『言葉が出にくい』『まとまらない』時は頭を流す。",
      action:"3行日記→ひとことメモ→5〜10分の散歩。"
    }
  };
  var sumVal=E.reduce((a,k)=>a+(total[k]||0),0)||1, avg=sumVal/5;
  function levelName(v){ if(v>=avg*1.15) return "strong"; if(v<=avg*0.85) return "train"; return "normal"; }
  var ord=E.slice().sort((a,b)=>(total[b]||0)-(total[a]||0));
  document.getElementById("fftags").innerHTML=
    '<span class="badge">今の強み：'+nameLabel[ord[0]]+'</span>'+
    '<span class="badge">伸ばすと良い：'+nameLabel[ord[4]]+'</span>';
  document.getElementById("fiveExplain").innerHTML=E.map(function(k){
    var v=(total[k]||0), lv=levelName(v), x=meaning[k];
    var head=(lv==="strong"?"今の強み":lv==="train"?"伸ばすと良い":"ふつう（OK）");
    var body=(lv==="strong")?x.weapon:(lv==="train")?("よくあるサイン："+x.signs+" ／ 今日の具体策："+x.action):"今のペースで大丈夫。";
    return '<div class="tag">'+x.title+' ／ <b>'+head+'</b> → '+body+'</div>';
  }).join('');

  // 通変星カウント・数秘
  var tgAll={}, pillarsGan=[ys,ms,hs];
  pillarsGan.forEach(g=>{var t=tenGod(ds,g); if(t) tgAll[t]=(tgAll[t]||0)+1;});
  (ZM[db]||[]).forEach(zg=>{var t=tenGod(ds,zg); if(t) tgAll[t]=(tgAll[t]||0)+1;});
  var topTG=Object.keys(tgAll).sort((a,b)=>(tgAll[b]||0)-(tgAll[a]||0));
  var lp=lifePath(y,m,d), bd=birthdayNum(d);

  // 性格・人間関係
  var traits=[];
  if(topTG[0]) traits.push('性格の核：<b>'+topTG[0]+'</b>（'+{"比肩":"自分で決めて動ける力","劫財":"人を巻き込んで進む力","食神":"楽しさと表現で周りを明るくする力","傷官":"細かく見て良くしていく力","偏財":"ご縁をつかむ行動力","正財":"コツコツ信頼をためる力","偏官":"挑戦して伸びる実戦力","正官":"役割を守って評価を上げる力","偏印":"ひらめきを形にする力","印綬":"学びを貯めて伝える力"}[topTG[0]]+'）');
  traits.push('人間関係：<b>'+(SE[ds]===SE[ms]?"似た強みを褒め合うと最強":"違いは“役割分担”にすると噛み合う")+'</b>');
  document.getElementById("traits").innerHTML=traits.map(x=>'<div class="tag">'+x+'</div>').join('');

  // 恋愛観（短め・やさしい）
  function loveText(lp,eCore,tgLead,db){
    var base={
      "木":"恋は『育てる』。会話を重ねて安心を増やそう。",
      "火":"恋は『情熱』。言葉と行動で思いを見せよう。",
      "土":"恋は『安心設計』。約束と連絡のルールを整えよう。",
      "金":"恋は『ていねいさ』。清潔感と小さな気づかいが鍵。",
      "水":"恋は『対話』。短い言葉で気持ちを伝えよう。"
    }[eCore];
    var lpAdd={1:"リード上手。相手の気持ちを先に聞くと信頼UP。",2:"寄りそう天才。我慢しすぎ注意。",3:"楽しい恋。ドタキャン注意。",4:"安定重視。将来像の共有が決め手。",5:"自由派。連絡ルールを先に決めて平和。",6:"世話焼き。自分ケアの日を作ろう。",7:"一人時間が燃料。静かな理解者に惹かれる。",8:"頼れる人。がんばりすぎたら甘える日を。",9:"共感型。境界線も大事に。",11:"直感重視。焦らず育てよう。",22:"大きな目標を一緒に追うと最強。",33:"包容力の塊。抱え込みすぎ注意。"}[lp];
    var tgAdd={"比肩":"『私はこうしたい』を素直に。","劫財":"一緒に作戦会議が近道。","食神":"笑顔とユーモアが武器。","傷官":"ダメ出しは『提案の形』で。","偏財":"会う回数＝安心。軽い誘いを増やそう。","正財":"小さな約束を守るほど進展。","偏官":"勢いは魅力。一呼吸置いてから。","正官":"礼儀と落ち着きが好印象。","偏印":"直感だけに頼らず言葉で補足。","印綬":"学び合いが長続きの鍵。"}[tgLead]||"";
    var peach = PEACH_BY_DAY[db] ? "あなたの日支「"+db+"」の『出会い運が上がる干支』は「"+PEACH_BY_DAY[db]+"」。" : "";
    return [base,lpAdd,tgAdd,peach].filter(Boolean).map(s=>'<div class="note">'+s+'</div>').join("");
  }
  document.getElementById("loveView").innerHTML=loveText(lp,SE[ds],topTG[0],db);

  // ビジネス
  var strong=ord[0], weak=ord[4];
  var bizMap={"木":"教育/育成/企画","火":"広報/販売/エンタメ","土":"管理/総務/品質","金":"法務/財務/審査/デザイン","水":"IT/情報/研究/伝達"};
  var lpJob={1:"起業/営業/企画/管理",2:"人事/秘書/接客/ケア",3:"デザイン/広報/教育",4:"経理/行政/建築/品質",5:"営業/旅行/マーケ/通訳",6:"医療/福祉/美容/教育",7:"研究/分析/開発/コンサル",8:"管理職/不動産/金融",9:"教育/福祉/企画/広報",11:"アート/表現/カウンセリング",22:"経営/社会事業/建設/仕組み化",33:"教育/ケア/表現/コミュニティ"};
  var roleTip={"木":"企画/育成の役","火":"広報/推進の役","土":"進行/品質の役","金":"監査/整備の役","水":"情報/分析の役"}[strong];
  document.getElementById("business").innerHTML=[
    '五行の強み：<b>'+nameLabel[strong]+'</b> → '+bizMap[strong],
    '数秘の適職：<b>'+lp+'</b> → '+lpJob[lp],
    'チームの役割：<b>'+roleTip+'</b>',
    '伸ばすポイント：<b>'+nameLabel[weak]+'</b> → '+{"木":"朝日とストレッチ＋“ありがとう”","火":"白湯→一言ポジティブ発信","土":"小さな締切で“やる日/休む日”","金":"捨て1・整え5分・要点3つ","水":"3行日記・散歩・対話"}[weak]
  ].map(x=>'<div class="note">'+x+'</div>').join("");

  // 長所・短所（禁止語修正済）
  var deepShort={"木":{pro:"面倒見と成長力",con:"思いやりが強すぎると自分を後回しにしやすい"}, "火":{pro:"情熱で人を動かす",con:"勢いが強いと相手が疲れることがある"}, "土":{pro:"安定と継続",con:"慎重すぎると機会を逃しやすい"}, "金":{pro:"基準と品質",con:"完璧を求めすぎると遅くなる"}, "水":{pro:"情報収集と伝達",con:"考えすぎると動けないことがある"}};
  var fix={"木":"毎朝5分の学び","火":"白湯＋一言ポジティブ","土":"小さな締切を置く","金":"5分片付け/基準決め","水":"3行日記/散歩/対話"};
  var strengths=['長所：<b>'+nameLabel[strong]+'</b>（'+deepShort[strong].pro+'）を前に出す。',
                 '短所：<b>'+nameLabel[weak]+'</b> → '+deepShort[weak].con+'。だから“'+fix[weak]+'”を習慣に。'];
  if(topTG[0]==="傷官") strengths.push('［注意］ダメ出しは“提案の形”で。時間を区切って出す。');
  if(topTG[0]==="偏官") strengths.push('［注意］勢い余りやすい → 一呼吸置いてから話す。');
  if(topTG[0]==="正財") strengths.push('［注意］抱え込みすぎ → 役割分担と締切共有。');
  document.getElementById("strengths").innerHTML=strengths.map(x=>'<div class="note">'+x+'</div>').join("");

  // 宿曜（高精度算出）
  var shuku=getShukuyoAccurate(y,m,d,hh,mm);
  document.getElementById("shukuOut").innerHTML=(function(name){
    var x=SHUKU_SOFT_DB[name];
    if(!x)return '<div class="tag">本命宿：<b>'+name+'</b>（準備中）</div>';
    return '<div class="tag"><b>本命宿：'+name+'</b>（'+x.e+'の気質）</div>'+
           '<p class="note">【あなたは】'+x.intro+'</p>'+
           '<p class="note">【恋愛】'+x.love+'</p>'+
           '<p class="note">【お仕事】'+x.work+'</p>'+
           '<p class="note">【出会い】'+x.meet+'</p>'+
           '<p class="note">【こころケア】'+x.care+'</p>'+
           '<p class="note"><b>'+x.charm+'</b></p>';
  })(shuku);

  // ===== 相性（略：前版と同等、宿のみ高精度算出へ差し替え） =====
  document.getElementById("compatBtn").onclick=function(){
    var y2=+document.getElementById("py2").value, m2=+document.getElementById("pm2").value, d2=+document.getElementById("pd2").value;
    var hm2=document.getElementById("phm2").value||"12:00", t2=parseHM(hm2), hh2=t2[0], mm2=t2[1]||0;
    if(!(y2>0&&m2>=1&&m2<=12&&d2>=1&&d2<=31)){document.getElementById("compatOut").innerHTML="<div class='err' style='display:block'>相手の生年月日を正しく入れてね</div>"; return;}
    var dp2=dayP(y2,m2,d2), ds2=dp2[0], db2=dp2[1];
    var lp1=lifePath(y,m,d), lp2=lifePath(y2,m2,d2);
    function gScore(a,b){var s=50,ea=SE[a],eb=SE[b]; if(GEN[ea]===eb)s+=12; if(GEN[eb]===ea)s+=12; if(CTL[ea]===eb)s-=14; if(CTL[eb]===ea)s-=14; if(SY[a]===SY[b])s+=6; else s-=4;return Math.max(0,Math.min(100,s));}
    var H={ "六合":HEX, "冲":CHONG, "害":[["子","未"],["丑","午"],["寅","巳"],["卯","辰"],["申","亥"],["酉","戌"]] };
    function zScore(a,b){var s=50; if(inPairs(H["六合"],a,b))s+=20; if(inPairs(H["冲"],a,b))s-=18; if(inPairs(H["害"],a,b))s-=8; return Math.max(0,Math.min(100,s));}
    var siJuScore=Math.round(gScore(ds,ds2)*0.6 + zScore(db,db2)*0.4);
    var NCbase={1:{1:70,2:78,3:85,4:76,5:82,6:74,7:80,8:88,9:75,11:86,22:84,33:80},2:{1:78,2:72,3:77,4:82,5:74,6:86,7:80,8:70,9:83,11:85,22:76,33:84},3:{1:85,2:77,3:75,4:72,5:88,6:80,7:78,8:79,9:84,11:86,22:78,33:90},4:{1:76,2:82,3:72,4:74,5:70,6:80,7:85,8:86,9:73,11:78,22:88,33:76},5:{1:82,2:74,3:88,4:70,5:76,6:73,7:80,8:78,9:84,11:86,22:80,33:82},6:{1:74,2:86,3:80,4:80,5:73,6:78,7:76,8:82,9:88,11:84,22:80,33:86},7:{1:80,2:80,3:78,4:85,5:80,6:76,7:74,8:82,9:79,11:88,22:84,33:78},8:{1:88,2:70,3:79,4:86,5:78,6:82,7:82,8:76,9:80,11:84,22:90,33:80},9:{1:75,2:83,3:84,4:73,5:84,6:88,7:79,8:80,9:76,11:86,22:82,33:88},11:{1:86,2:85,3:86,4:78,5:86,6:84,7:88,8:84,9:86,11:82,22:86,33:90},22:{1:84,2:76,3:78,4:88,5:80,6:80,7:84,8:90,9:82,11:86,22:84,33:86},33:{1:80,2:84,3:90,4:76,5:82,6:86,7:78,8:80,9:88,11:90,22:86,33:84}};
    var numScore=(NCbase[lp1]&&NCbase[lp1][lp2])||75;
    var loveScore=Math.round(siJuScore*0.65 + numScore*0.35);
    var friendScore=Math.round(siJuScore*0.5 + numScore*0.5);
    var roleBoost=0; if(GEN[SE[ds]]===SE[ds2]) roleBoost+=4; if(CTL[SE[ds]]===SE[ds2]) roleBoost+=3;
    var bizScore=Math.max(0,Math.min(100, Math.round(siJuScore*0.6 + numScore*0.4 + roleBoost)));
    function face(s){return s>=86?"◎":(s>=80?"◯":(s>=74?"△":"▲"));}

    var sh1=getShukuyoAccurate(y,m,d,hh,mm), sh2=getShukuyoAccurate(y2,m2,d2,hh2,mm2);
    var shLine='宿曜：あなた「'+sh1+'」× 相手「'+sh2+'」。違いは価値観の違い＝武器。共通点は“安心”。';

    var talkTips=["①気持ち ②理由 ③お願い（短く）","『うれしかった→困った→こうしたい』","結論→理由→一緒の一歩"];
    var tt=talkTips[(y+m+d+y2+m2+d2)%talkTips.length];

    function loveAdvice(s){
      var a=[];
      if(s<75)a.push("すれ違いは『"+tt+"』で短く。長文より短文が安心。");
      if(inPairs(HEX, db, db2))a.push("相性◎（六合）：会う回数を少し増やすほど仲良しに。");
      if(inPairs(CHONG, db, db2))a.push("衝突しやすい：先にゴールを一文で決めてから話そう。");
      a.push("迷ったら「"+({"木":"散歩や本屋","火":"ライブや外食","土":"家ごはんや片づけ","金":"美術館や静かな場所","水":"カフェでゆっくり"}[SE[ds]])+"」が失敗しにくい。");
      return a.join(" ");
    }
    function friendAdvice(s){
      var a=[];
      if(s<75)a.push("連絡頻度（週1/隔週）を最初に合意。");
      a.push((CTL[SE[ds]]===SE[ds2]||CTL[SE[ds2]]===SE[ds])?"『企画/まとめ/連絡』の役割分担で摩擦回避。":"共通の趣味時間をカレンダー固定。");
      a.push("『ありがとう』はその日のうちに短文で。");
      return a.join(" ");
    }
    function bizAdvice(s){
      var a=[];
      if(GEN[SE[ds]]===SE[ds2])a.push("あなた→相手：育成/コーチ適性。");
      if(CTL[SE[ds]]===SE[ds2])a.push("あなた→相手：KPIや締切設計を担当。");
      if(CTL[SE[ds2]]===SE[ds])a.push("相手→あなた：進捗チェックを任せる。");
      a.push("最初に『誰が決める／何を決める／いつまで』を宣言。共有メモで透明化。");
      return a.join(" ");
    }

    var html='';
    html+='<div class="kv"><div class="chip">あなた：<b>'+ds+db+'</b> / 運命数<b>'+lp1+'</b> / 宿：'+sh1+'</div><div class="chip">相手：<b>'+ds2+db2+'</b> / 運命数<b>'+lp2+'</b> / 宿：'+sh2+'</div></div><div class="hr"></div>';
    html+='<div><b>四柱の相性</b>：'+siJuScore+'/100　<b>数秘の相性</b>：'+numScore+'/100</div><div class="small">'+shLine+'</div><div class="hr"></div>';
    html+='<div><b>総合（恋愛）</b>：'+loveScore+'/100 '+face(loveScore)+'<br><span class="small">'+loveAdvice(loveScore)+'</span></div>';
    html+='<div style="margin-top:6px"><b>総合（友情）</b>：'+friendScore+'/100 '+face(friendScore)+'<br><span class="small">'+friendAdvice(friendScore)+'</span></div>';
    html+='<div style="margin-top:6px"><b>総合（ビジネス）</b>：'+bizScore+'/100 '+face(bizScore)+'<br><span class="small">'+bizAdvice(bizScore)+'</span></div>';
    document.getElementById("compatOut").innerHTML=html;
  };

  // ===== 時期（36か月） =====（前版同等）
  function bestNumMonths(kind){var sets={love:[2,3,6], meet:[3,5], job:[1,5,8], ind:[1,8]}; return sets[kind||'love']||[2,3,6];}
  var meE=SE[ds], wealthE=CTL[meE];
  var controlsMeE=(function(){for(var k in CTL){if(CTL[k]===meE)return k;}return null;})();
  function monthBranch(y,m,d){ return monthP(y,m,d,yearP(y,m,d)[0])[1]; }

  var today=new Date(), startY=today.getFullYear(), startM=today.getMonth()+1;
  var cells=[], marryMonths=[];
  for(var i=0;i<36;i++){
    var Y=startY+Math.floor((startM-1+i)/12);
    var M=((startM-1+i)%12)+1;

    var br=monthBranch(Y,M,15), brE=BR_E[br];
    var curPY=personalYear(m,d,Y), pm=personalMonth(curPY,M);

    var numLove=bestNumMonths('love').indexOf(pm)>=0;
    var numMeet=bestNumMonths('meet').indexOf(pm)>=0;
    var numJob =bestNumMonths('job').indexOf(pm)>=0;
    var numInd =bestNumMonths('ind').indexOf(pm)>=0;

    var siMeet = (br===PEACH_BY_DAY[db]);
    var siLove = (brE===wealthE) || siMeet;
    var siJob  = (brE===controlsMeE);
    var siInd  = (brE===wealthE);

    function cls(b1,b2){return b1&&b2?"hitBoth":(b1?"hitNum":(b2?"hitSi":""));}

    var marryHit = ( (numLove && siLove) || (siLove && siMeet) || (numLove && siMeet) );

    var divCls=cls((numLove||numMeet||numJob||numInd),(siLove||siJob||siInd)) + (marryHit?' marry':'');
    var label=Y+"年"+M+"月（"+br+"）";
    var detail=[];
    if(numLove||siLove) detail.push("恋愛◎");
    if(numMeet||siMeet) detail.push("出会い◎");
    if(numJob ||siJob ) detail.push("転職◎");
    if(numInd ||siInd ) detail.push("独立◎");
    if(marryHit) { detail.push("💍結婚◎"); marryMonths.push(label); }
    if(detail.length===0) detail.push("様子見");

    cells.push('<div class="km '+divCls+'"><b>'+label+'</b>'+detail.join("・")+'</div>');
  }
  document.getElementById("timing").innerHTML=cells.join('');
  document.getElementById("timingLegend").innerHTML="※ “恋/結婚”は数秘（2/3/6）＋四柱の財の月/桃花月、“転職”は数秘（1/5/8）＋四柱の官の月、“独立”は数秘（1/8）＋四柱の条件で判定。色はW◎/数秘◎/四柱◎。";
  document.getElementById("marryList").innerHTML = (marryMonths.length? "💍 <b>結婚に良い月：</b> "+marryMonths.join("、") : "💍 結婚は焦らず、準備の年。");
}

function init(){ document.getElementById("run").addEventListener("click",run); document.getElementById("compatBtn").addEventListener("click",function(){}); run(); }
document.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>
